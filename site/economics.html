<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Economics of LLM Inference</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
/* ─── RESET & BASE ─── */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg: #0a0a0c;
  --bg-card: #111115;
  --bg-card-hover: #18181e;
  --border: #1e1e28;
  --border-active: #3a3a50;
  --text: #e8e6e3;
  --text-dim: #9a98a0;
  --text-muted: #4a4850;
  --accent: #56B4E9;
  --accent-dim: #3a8dc4;
  --accent-glow: rgba(86,180,233,0.08);
  --compute: #D55E00;
  --memory: #0090D6;
  --io: #E69F00;
  --logic: #CC79A7;
  --network: #56B4E9;
  --economics: #009E73;
  --font-display: 'Instrument Serif', serif;
  --font-body: 'Atkinson Hyperlegible', sans-serif;
  --font-mono: 'DM Mono', monospace;
}

html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  font-weight: 400;
  line-height: 1.8;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  padding-top: 48px;
}

::selection { background: var(--accent); color: var(--bg); }

/* ─── SITE NAV ─── */
.site-nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 600;
  height: 48px;
  background: rgba(10,10,12,0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 2rem;
}
.nav-logo { font-family: var(--font-display); font-size: 1rem; color: var(--text); text-decoration: none; white-space: nowrap; }
.nav-links { display: flex; align-items: center; gap: 1.5rem; }
.nav-link {
  font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.15em;
  text-transform: uppercase; color: var(--text-muted); text-decoration: none;
  padding: 0.25rem 0; transition: color 0.2s ease;
}
.nav-link:hover { color: var(--text-dim); }
.nav-link.active { color: var(--accent); border-bottom: 1.5px solid var(--accent); }
.nav-divider { width: 1px; height: 18px; background: var(--border); flex-shrink: 0; }

/* ─── THEME TOGGLE ─── */
.theme-toggle {
  width: 32px; height: 32px; border-radius: 50%;
  border: 1px solid var(--border); background: transparent;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  color: var(--text-dim); font-size: 1rem;
  transition: border-color 0.2s ease, color 0.2s ease;
}
.theme-toggle:hover { border-color: var(--border-active); color: var(--text); }
.theme-toggle::after { content: '\263C'; }
[data-theme="light"] .theme-toggle::after { content: '\263E'; }

/* ─── HERO ─── */
.hero {
  min-height: 50vh; display: flex; flex-direction: column;
  justify-content: center; align-items: center; text-align: center;
  padding: 1.5rem 2rem; position: relative; overflow: hidden;
}
.hero::before {
  content: ''; position: absolute; inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0,158,115,0.04) 0%, transparent 50%),
    radial-gradient(ellipse 60% 40% at 20% 80%, rgba(86,180,233,0.03) 0%, transparent 50%),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(230,159,0,0.03) 0%, transparent 50%);
  pointer-events: none;
}
.hero-label {
  font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.3em;
  text-transform: uppercase; color: var(--economics); margin-bottom: 1rem;
  opacity: 0; animation: fadeUp 0.8s ease forwards 0.2s;
}
.hero h1 {
  font-family: var(--font-display); font-size: clamp(3rem, 8vw, 7rem);
  font-weight: 400; line-height: 1.05; letter-spacing: -0.02em; max-width: 900px;
  opacity: 0; animation: fadeUp 0.8s ease forwards 0.4s;
}
.hero h1 em { font-style: italic; color: var(--accent); }
.hero-sub {
  font-size: clamp(1rem, 2vw, 1.2rem); color: var(--text-dim);
  max-width: 600px; margin-top: 1rem;
  opacity: 0; animation: fadeUp 0.8s ease forwards 0.6s;
}
.hero-cta {
  margin-top: 1.5rem; display: flex; align-items: center; gap: 0.5rem;
  font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted);
  opacity: 0; animation: fadeUp 0.8s ease forwards 0.8s;
}
.hero-cta .arrow { display: inline-block; animation: bounce 2s ease infinite; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(6px); } }

/* ─── PHASE OVERVIEW ─── */
.phase-overview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; max-width: 1200px; margin: 0 auto; padding: 0 2rem 4rem; }
.phase-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: border-color 0.18s ease, background-color 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease; position: relative; }
.phase-card:hover { border-color: var(--border-active); background: var(--bg-card-hover); }
.phase-letter { font-family: var(--font-display); font-size: 2.5rem; color: var(--accent); line-height: 1; margin-bottom: 0.5rem; }
.phase-name { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 0.25rem; }
.phase-subtitle { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem; }
.phase-steps { display: flex; flex-direction: column; gap: 0.25rem; }
.phase-steps span { font-family: var(--font-mono); font-size: 0.72rem; color: var(--text-muted); letter-spacing: 0.05em; }
.phase-card:not(:last-child)::after { content: '\2192'; position: absolute; right: -1rem; top: 50%; transform: translate(50%, -50%); color: var(--text-muted); font-size: 1.2rem; z-index: 3; }

/* ─── PIPELINE ─── */
.pipeline-section { padding: 4rem 2rem 6rem; max-width: 1200px; margin: 0 auto; }
.section-label { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem; }
.section-title { font-family: var(--font-display); font-size: clamp(2rem, 4vw, 3.5rem); font-weight: 400; margin-bottom: 1rem; }
.section-desc { color: var(--text-dim); max-width: 650px; margin-bottom: 3rem; font-size: 1rem; }
.phase-divider { display: grid; grid-template-columns: 48px 1fr; padding: 2rem 0 0.5rem; position: relative; }
.phase-divider:first-child { padding-top: 0; }
.phase-divider-marker { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 8px; background: var(--accent); color: var(--bg); font-family: var(--font-mono); font-weight: 700; font-size: 0.75rem; margin-left: 8px; z-index: 2; }
.phase-divider-content { padding: 0.25rem 0 0 0.75rem; }
.phase-divider-name { font-family: var(--font-display); font-size: 1.15rem; color: var(--accent); }
.phase-divider-desc { font-size: 0.8rem; color: var(--text-muted); }
.pipeline-flow { display: flex; flex-direction: column; gap: 0; position: relative; }
.pipeline-flow::before { content: ''; position: absolute; left: 24px; top: 0; bottom: 0; width: 1px; background: linear-gradient(to bottom, transparent, var(--border) 5%, var(--border) 95%, transparent); }
.pipeline-step { display: grid; grid-template-columns: 48px 1fr; gap: 0; cursor: pointer; position: relative; }
.step-marker { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; }
.step-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--border); background: var(--bg); margin-top: 1.5rem; transition: border-color 0.18s ease, background-color 0.18s ease, box-shadow 0.18s ease; flex-shrink: 0; }
.pipeline-step:hover .step-dot, .pipeline-step.active .step-dot { border-color: var(--accent); background: var(--accent); box-shadow: 0 0 12px rgba(86,180,233,0.3); }
.step-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem; margin: 0.5rem 0; transition: border-color 0.18s ease, background-color 0.18s ease; position: relative; overflow: hidden; cursor: pointer; }
.step-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, var(--accent-glow) 0%, transparent 50%); opacity: 0; transition: opacity 0.18s ease; }
.pipeline-step:hover .step-card, .pipeline-step.active .step-card { border-color: var(--border-active); background: var(--bg-card-hover); }
.pipeline-step:hover .step-card::before, .pipeline-step.active .step-card::before { opacity: 1; }
.step-header { display: flex; align-items: center; gap: 0.75rem; position: relative; z-index: 1; cursor: pointer; }
.step-number { font-family: var(--font-mono); font-size: 0.6rem; color: var(--accent-dim); letter-spacing: 0.1em; min-width: 24px; }
.step-name { font-family: var(--font-display); font-size: 1.4rem; flex: 1; }
.step-badge { font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 0.1em; text-transform: uppercase; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid; }
.step-badge::before { margin-right: 0.3em; }
.badge-compute { color: var(--compute); border-color: rgba(213,94,0,0.3); background: rgba(213,94,0,0.05); }
.badge-compute::before { content: '\26A1'; }
.badge-economics { color: var(--economics); border-color: rgba(0,158,115,0.3); background: rgba(0,158,115,0.05); }
.badge-economics::before { content: '$'; }
.step-summary { color: var(--text-dim); font-size: 0.9rem; margin-top: 0.5rem; position: relative; z-index: 1; }
.step-expand-icon { color: var(--text-muted); font-size: 1.2rem; transition: transform 0.18s ease; font-family: var(--font-mono); }
.pipeline-step.active .step-expand-icon { transform: rotate(45deg); color: var(--accent); }

/* ─── EXPANDED DETAIL ─── */
.step-detail { max-height: 0; overflow: hidden; transition: max-height 0.18s ease-out; position: relative; z-index: 1; cursor: default; }
.pipeline-step.active .step-detail { max-height: 8000px; }
.detail-inner { padding: 1.5rem 0 0.5rem; border-top: 1px solid var(--border); margin-top: 1rem; }
.detail-section { margin-bottom: 1.5rem; }
.detail-section:last-child { margin-bottom: 0; }
.detail-label { font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--accent-dim); margin-bottom: 0.5rem; }
.detail-text { font-size: 0.92rem; color: var(--text-dim); line-height: 1.8; }
.detail-text strong { color: var(--text); font-weight: 400; }
.detail-text code { font-family: var(--font-mono); font-size: 0.78rem; background: rgba(86,180,233,0.06); color: var(--accent); padding: 0.15rem 0.4rem; border-radius: 4px; }
.callout-box { border-radius: 8px; padding: 0.85rem 1rem; margin-bottom: 1.25rem; font-size: 0.9rem; line-height: 1.7; }
.callout-takeaway { background: rgba(86,180,233,0.06); border-left: 3px solid var(--accent); }
.callout-takeaway .callout-label { font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--accent); margin-bottom: 0.3rem; }
.callout-takeaway p { color: var(--text); font-weight: 700; }
.callout-analogy { background: rgba(204,121,167,0.05); border-left: 3px solid var(--logic); }
.callout-analogy .callout-label { font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--logic); margin-bottom: 0.3rem; }
.callout-analogy p { color: var(--text-dim); font-style: italic; }

/* ─── SUB-TOPICS ─── */
.sub-topics { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
.sub-topic { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; cursor: pointer; transition: border-color 0.18s ease, background-color 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease; }
.sub-topic:hover { border-color: var(--border-active); background: rgba(255,255,255,0.04); }
.sub-topic.expanded { grid-column: 1 / -1; border-color: var(--accent-dim); }
.sub-topic-header { display: flex; align-items: center; justify-content: space-between; }
.sub-topic-name { font-family: var(--font-display); font-size: 1.1rem; }
.sub-topic-icon { color: var(--text-muted); font-family: var(--font-mono); font-size: 0.9rem; transition: transform 0.3s ease; }
.sub-topic.expanded .sub-topic-icon { transform: rotate(45deg); color: var(--accent); }
.sub-topic-preview { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.35rem; }
.sub-topic-detail { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
.sub-topic.expanded .sub-topic-detail { display: block; }
.sub-topic-detail p { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 0.75rem; line-height: 1.8; }
.sub-topic-detail p:last-child { margin-bottom: 0; }

/* ─── TABLES, METRICS, CODE, TERMS ─── */
.data-table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; font-size: 0.8rem; }
.data-table th { font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
.data-table td { padding: 0.5rem 0.75rem; color: var(--text-dim); border-bottom: 1px solid rgba(30,30,40,0.5); }
.data-table td:first-child { color: var(--text); }
.data-table tr:last-child td { border-bottom: none; }
.metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin: 0.75rem 0; }
.metric { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem 1rem; text-align: center; }
.metric-value { font-family: var(--font-display); font-size: 1.6rem; color: var(--accent); }
.metric-label { font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 0.25rem; }
.code-block { background: #0d0d10; border: 1px solid var(--border); border-radius: 8px; padding: 1rem 1.25rem; margin: 0.75rem 0; font-family: var(--font-mono); font-size: 0.75rem; line-height: 1.8; color: var(--text-dim); overflow-x: auto; white-space: pre; }
.code-block .kw { color: var(--accent); }
.code-block .fn { color: var(--logic); }
.code-block .num { color: var(--io); }
.code-block .str { color: var(--compute); }
.term { color: var(--accent); text-decoration: underline; text-decoration-style: dotted; text-decoration-color: rgba(86,180,233,0.4); text-underline-offset: 3px; cursor: help; }
.term-tooltip { position: fixed; max-width: 340px; background: #1a1a22; border: 1px solid var(--border-active); border-radius: 10px; padding: 0.85rem 1rem; z-index: 1000; box-shadow: 0 8px 32px rgba(0,0,0,0.5); animation: tooltipIn 0.2s ease; }
.term-tooltip-title { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent); margin-bottom: 0.35rem; }
.term-tooltip-body { font-size: 0.85rem; color: var(--text-dim); line-height: 1.6; }
.term-tooltip-close { position: absolute; top: 0.5rem; right: 0.5rem; width: 1.25rem; height: 1.25rem; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); font-size: 0.65rem; cursor: pointer; padding: 0; line-height: 1; transition: color 0.15s, border-color 0.15s; }
.term-tooltip-close:hover { color: var(--text-dim); border-color: var(--border-active); }
.term-tooltip-footer { display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem; padding-top: 0.4rem; border-top: 1px solid var(--border); }
.term-tooltip-source { display: inline-block; font-family: var(--font-mono); font-size: 0.65rem; color: var(--accent-dim); opacity: 0.7; text-decoration: none; letter-spacing: 0.05em; transition: opacity 0.2s ease; }
.term-tooltip-source:hover { opacity: 1; }
.term-tooltip-nav { font-family: var(--font-mono); font-size: 0.65rem; color: var(--accent-dim); opacity: 0.7; text-decoration: none; letter-spacing: 0.05em; transition: opacity 0.2s ease; white-space: nowrap; cursor: pointer; }
.term-tooltip-nav:hover { opacity: 1; color: var(--accent); }
@keyframes tooltipIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* ─── CROSS-LINK ─── */
.cross-link { display: inline-block; margin-top: 0.5rem; color: var(--accent-dim); font-family: var(--font-mono); font-size: 0.75rem; text-decoration: none; letter-spacing: 0.05em; transition: color 0.2s; }
.cross-link:hover { color: var(--accent); }

/* ─── INTERACTIVE VISUALS ─── */
.step-visual { position: relative; min-height: 200px; background: rgba(255,255,255,0.015); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin: 0.75rem 0; font-family: var(--font-mono); font-size: 0.7rem; padding: 1.5rem; }
.waterfall-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
.waterfall-label { min-width: 100px; font-size: 0.65rem; color: var(--text-dim); text-align: right; }
.waterfall-bar-wrap { flex: 1; height: 24px; background: rgba(255,255,255,0.03); border-radius: 4px; overflow: hidden; position: relative; }
.waterfall-segment { height: 100%; float: left; transition: width 0.6s ease; position: relative; }
.waterfall-segment:hover { opacity: 0.85; }
.waterfall-val { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 0.55rem; color: rgba(255,255,255,0.9); }
.waterfall-total { font-size: 0.65rem; color: var(--text); min-width: 60px; }
.timeline-track { position: relative; height: 4px; background: var(--border); border-radius: 2px; margin: 2rem 0 1rem; }
.timeline-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--accent); border-radius: 2px; transition: width 1.5s ease; }
.timeline-point { position: absolute; top: -8px; width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--accent); background: var(--bg-card); transform: translateX(-50%); z-index: 2; }
.timeline-point-label { position: absolute; top: 18px; left: 50%; transform: translateX(-50%); white-space: nowrap; font-size: 0.55rem; color: var(--text-dim); }
.timeline-point-value { position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%); white-space: nowrap; font-size: 0.6rem; color: var(--accent); font-weight: 500; }
.calc-container { display: flex; flex-direction: column; gap: 1rem; }
.calc-slider-group { display: flex; align-items: center; gap: 1rem; }
.calc-slider-group label { min-width: 80px; font-size: 0.65rem; color: var(--text-dim); }
.calc-slider-group input[type="range"] { flex: 1; accent-color: var(--accent); }
.calc-slider-group .calc-val { min-width: 50px; font-size: 0.75rem; color: var(--accent); text-align: right; }
.calc-result { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
.calc-result-item { flex: 1; min-width: 120px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; text-align: center; }
.calc-result-value { font-family: var(--font-display); font-size: 1.4rem; color: var(--accent); }
.calc-result-label { font-family: var(--font-mono); font-size: 0.5rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 0.2rem; }
.capital-bars { display: flex; flex-direction: column; gap: 0.6rem; }
.capital-bar-row { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
.capital-bar-row:hover .capital-bar-wrap { border-color: var(--border-active); }
.capital-bar-label { min-width: 70px; font-size: 0.6rem; color: var(--text-dim); text-align: right; }
.capital-bar-wrap { flex: 1; height: 28px; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; display: flex; transition: border-color 0.2s; }
.capital-equity { background: var(--accent); height: 100%; transition: width 0.6s ease; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; color: var(--bg); }
.capital-debt { background: var(--economics); height: 100%; transition: width 0.6s ease; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; color: var(--bg); }
.capital-cost { min-width: 80px; font-size: 0.55rem; color: var(--text-muted); }
.capital-detail { display: none; margin: 0.25rem 0 0.5rem 80px; padding: 0.75rem; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 6px; font-size: 0.8rem; color: var(--text-dim); line-height: 1.7; }
.capital-detail.visible { display: block; }

/* ─── MINIMAP ─── */
.minimap { position: fixed; right: max(1.5rem, calc((100vw - 1200px) / 2 - 10rem)); top: 50%; transform: translateY(-50%); z-index: 400; opacity: 0; pointer-events: none; transition: opacity 0.35s ease; display: flex; flex-direction: column; gap: 0; }
.minimap.visible { opacity: 1; pointer-events: auto; }
.minimap-phase { padding: 0.4rem 0; position: relative; }
.minimap-phase + .minimap-phase { border-top: 1px solid var(--border); margin-top: 0.15rem; padding-top: 0.55rem; }
.minimap-phase-label { font-family: var(--font-mono); font-size: 0.5rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--accent-dim); margin-bottom: 0.35rem; padding-left: 2px; }
.minimap-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.2rem 0; text-decoration: none; cursor: pointer; outline: none; }
.minimap-dot { width: 8px; height: 8px; border-radius: 50%; border: 1.5px solid var(--border-active); background: var(--bg); flex-shrink: 0; box-shadow: 0 0 0 3px var(--bg); transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease; }
.minimap-label { font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 0.06em; color: var(--text-muted); white-space: nowrap; transition: color 0.2s ease; }
.minimap-item:hover .minimap-dot { border-color: var(--border-active); }
.minimap-item:hover .minimap-label { color: var(--text-dim); }
.minimap-item.active .minimap-dot { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 6px var(--accent-glow), 0 0 12px var(--accent-glow); }
.minimap-item.active .minimap-label { color: var(--text); }

/* ─── FOOTER ─── */
.footer { padding: 4rem 2rem; text-align: center; border-top: 1px solid var(--border); }
.footer p { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.1em; }

/* ─── SCROLL ANIMATIONS ─── */
.reveal { opacity: 0; transform: translateY(20px); transition: all 0.6s ease; }
.reveal.visible { opacity: 1; transform: translateY(0); }

/* ─── RESPONSIVE ─── */
.minimap-label { opacity: 0; width: 0; overflow: hidden; transition: opacity 0.2s ease, width 0.2s ease; }
.minimap-phase-label { opacity: 0; width: 0; overflow: hidden; transition: opacity 0.2s ease, width 0.2s ease; }
.minimap:hover { background: var(--bg); box-shadow: -4px 0 16px rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 0.75rem 1rem 0.75rem 0.5rem; border-radius: 8px; }
.minimap:hover .minimap-label { opacity: 1; width: auto; }
.minimap:hover .minimap-phase-label { opacity: 1; width: auto; }
[data-theme="light"] .minimap:hover { box-shadow: -4px 0 16px rgba(0,0,0,0.08); }
@media (max-width: 768px) {
  .minimap { display: none; }
  .site-nav { padding: 0 0.75rem; }
  .nav-logo { font-size: 0.85rem; }
  .nav-link { font-size: 0.5rem; letter-spacing: 0.08em; }
  .nav-links { gap: 0.5rem; }
  .nav-divider { height: 14px; }
  .pipeline-flow::before { left: 18px; }
  .pipeline-step { grid-template-columns: 36px 1fr; }
  .step-card { padding: 1rem; }
  .step-name { font-size: 1.15rem; }
  .sub-topics { grid-template-columns: 1fr; }
  .step-badge { display: none; }
  .metrics-row { grid-template-columns: repeat(2, 1fr); }
  .phase-overview { grid-template-columns: 1fr; }
  .phase-card:not(:last-child)::after { content: '\2193'; right: 50%; top: auto; bottom: -1rem; transform: translate(50%, 50%); }
}

/* ─── LIGHT THEME ─── */
[data-theme="light"] {
  --bg: #f5f3ef; --bg-card: #ffffff; --bg-card-hover: #f0eee9;
  --border: #d8d5ce; --border-active: #b0abb8;
  --text: #1a1a1f; --text-dim: #4a4750; --text-muted: #8a8690;
  --accent: #1a7ab5; --accent-dim: #155e8c; --accent-glow: rgba(26,122,181,0.07);
  --compute: #b34a00; --memory: #006fa8; --io: #9d6e00; --logic: #a85d87; --network: #1a7ab5;
  --economics: #007A59;
}
[data-theme="light"] .site-nav { background: rgba(245,243,239,0.85); }
[data-theme="light"] .hero::before { background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0,122,89,0.06) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 20% 80%, rgba(26,122,181,0.04) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(157,110,0,0.04) 0%, transparent 50%); }
[data-theme="light"] .step-dot { background: var(--bg-card); }
[data-theme="light"] .pipeline-step:hover .step-dot, [data-theme="light"] .pipeline-step.active .step-dot { box-shadow: 0 0 12px rgba(26,122,181,0.25); }
[data-theme="light"] .badge-compute { border-color: rgba(179,74,0,0.3); background: rgba(179,74,0,0.06); }
[data-theme="light"] .badge-economics { border-color: rgba(0,122,89,0.3); background: rgba(0,122,89,0.06); }
[data-theme="light"] .sub-topic { background: rgba(0,0,0,0.02); }
[data-theme="light"] .sub-topic:hover { background: rgba(0,0,0,0.04); }
[data-theme="light"] .metric { background: rgba(0,0,0,0.02); }
[data-theme="light"] .code-block { background: #f0ede8; }
[data-theme="light"] .term-tooltip { background: #ffffff; box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
[data-theme="light"] .term-tooltip-close { border-color: rgba(0,0,0,0.15); color: rgba(0,0,0,0.3); }
[data-theme="light"] .term-tooltip-close:hover { border-color: rgba(0,0,0,0.3); color: rgba(0,0,0,0.5); }
[data-theme="light"] .term-tooltip-footer { border-top-color: rgba(0,0,0,0.08); }
[data-theme="light"] .callout-takeaway { background: rgba(26,122,181,0.06); }
[data-theme="light"] .callout-analogy { background: rgba(168,93,135,0.06); }
[data-theme="light"] .detail-text code { background: rgba(26,122,181,0.08); }
[data-theme="light"] .data-table td { border-bottom-color: rgba(0,0,0,0.06); }
[data-theme="light"] .term { text-decoration-color: rgba(26,122,181,0.4); }
[data-theme="light"] ::selection { background: var(--accent); color: #ffffff; }
[data-theme="light"] .step-visual { background: rgba(0,0,0,0.02); }
[data-theme="light"] .minimap-dot { background: var(--bg-card); }
[data-theme="light"] .minimap-item.active .minimap-dot { box-shadow: 0 0 8px rgba(26,122,181,0.2); }

body, .code-block, .callout-box, .metric, .site-nav, .minimap-phase { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }

/* ─── SEARCH ─── */
.search-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 2000; display: flex; align-items: flex-start; justify-content: center; padding-top: 12vh; opacity: 0; pointer-events: none; transition: opacity 0.15s ease; }
.search-overlay.open { opacity: 1; pointer-events: auto; }
.search-modal { background: var(--bg-card); border: 1px solid var(--border-active); border-radius: 12px; width: min(560px, calc(100vw - 2rem)); box-shadow: 0 24px 64px rgba(0,0,0,0.5); transform: translateY(-8px); transition: transform 0.15s ease; }
.search-overlay.open .search-modal { transform: translateY(0); }
.search-input-wrap { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; border-bottom: 1px solid var(--border); }
.search-icon-svg { width: 16px; height: 16px; color: var(--text-muted); flex-shrink: 0; fill: none; }
.search-input { flex: 1; background: none; border: none; outline: none; font-family: var(--font-body); font-size: 0.95rem; color: var(--text); }
.search-input::placeholder { color: var(--text-muted); }
.search-esc-hint { font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-muted); background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 0.15rem 0.4rem; flex-shrink: 0; }
.search-results { max-height: 380px; overflow-y: auto; padding: 0.4rem 0; contain: content; }
.search-group-header { font-family: var(--font-mono); font-size: 0.5rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--text-muted); padding: 0.6rem 1rem 0.2rem; }
.search-result { display: flex; align-items: center; gap: 0.75rem; padding: 0.55rem 1rem; cursor: pointer; transition: background 0.1s ease; }
.search-result:hover, .search-result.selected { background: var(--bg-card-hover); }
.search-result-dot { width: 6px; height: 6px; border-radius: 50%; border: 1.5px solid var(--border-active); background: transparent; flex-shrink: 0; transition: background 0.1s ease, border-color 0.1s ease; }
.search-result.selected .search-result-dot { background: var(--accent); border-color: var(--accent); }
.search-result-body { flex: 1; min-width: 0; }
.search-result-title { font-size: 0.85rem; color: var(--text-dim); }
.search-result.selected .search-result-title { color: var(--text); }
.search-result-desc { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.search-result-badge { font-family: var(--font-mono); font-size: 0.45rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent-dim); border: 1px solid rgba(86,180,233,0.25); border-radius: 3px; padding: 0.1rem 0.3rem; flex-shrink: 0; }
.search-no-results { padding: 2.5rem 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem; }
.search-footer { display: flex; gap: 1.5rem; padding: 0.5rem 1rem; border-top: 1px solid var(--border); justify-content: flex-end; align-items: center; }
.search-footer-hint { font-family: var(--font-mono); font-size: 0.5rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.3rem; }
.search-footer-key { background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 0.1rem 0.3rem; }
.search-trigger { background: none; border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0.6rem; cursor: pointer; color: var(--text-muted); font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 0.05em; transition: border-color 0.2s ease, color 0.2s ease; }
.search-trigger:hover { border-color: var(--border-active); color: var(--text-dim); }
.search-trigger svg { width: 12px; height: 12px; fill: none; }
.search-trigger .search-trigger-label { white-space: nowrap; }
.search-trigger kbd { font-family: var(--font-mono); font-size: 0.5rem; color: var(--text-muted); background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 0.05rem 0.3rem; }
.knowledge-trigger[disabled] { opacity: 0.65; cursor: wait; }
[data-theme="light"] .search-overlay { background: rgba(0,0,0,0.25); }
[data-theme="light"] .search-modal { box-shadow: 0 24px 64px rgba(0,0,0,0.15); }
@media (max-width: 768px) {
  .search-trigger .search-trigger-label, .search-trigger kbd { display: none; }
  .search-trigger { padding: 0.35rem; }
}
</style>
<script>
(function(){
  var s = localStorage.getItem('theme');
  if (s) { document.documentElement.setAttribute('data-theme', s); }
  else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  } else { document.documentElement.setAttribute('data-theme', 'dark'); }
})();
</script>
</head>
<body>

<nav class="site-nav">
  <a href="index.html" class="nav-logo">LLM Anatomy</a>
  <div class="nav-links">
    <a href="training.html" class="nav-link">Training</a>
    <a href="training-economics.html" class="nav-link">Training Economics</a>
    <span class="nav-divider"></span>
    <a href="index.html" class="nav-link">Inference</a>
    <a href="economics.html" class="nav-link active">Inference Economics</a>
    <button class="search-trigger" id="search-trigger" aria-label="Search all pages">
      <svg viewBox="0 0 16 16" stroke="currentColor" stroke-width="1.5"><circle cx="6.5" cy="6.5" r="4.5"></circle><path stroke-linecap="round" d="m10 10 3.5 3.5"></path></svg>
      <span class="search-trigger-label">Search</span>
      <kbd id="search-key-hint">&#8984;K</kbd>
    </button>
    <button class="search-trigger knowledge-trigger" id="download-knowledge" aria-label="Download website knowledge as Markdown">
      <svg viewBox="0 0 16 16" stroke="currentColor" stroke-width="1.5" fill="none"><path stroke-linecap="round" stroke-linejoin="round" d="M8 2.5v7"></path><path stroke-linecap="round" stroke-linejoin="round" d="m5.5 7.5 2.5 2.5 2.5-2.5"></path><path stroke-linecap="round" stroke-linejoin="round" d="M3 12.5h10"></path></svg>
      <span class="search-trigger-label">Knowledge</span>
      <kbd>.md</kbd>
    </button>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme"></button>
  </div>
</nav>

<!-- ─── MINIMAP ─── -->
<div class="minimap" id="minimap">
  <div class="minimap-phase">
    <div class="minimap-phase-label">Unit Economics</div>
    <a class="minimap-item" data-target="cost-stack"><span class="minimap-dot"></span><span class="minimap-label">Cost Stack</span></a>
    <a class="minimap-item" data-target="throughput"><span class="minimap-dot"></span><span class="minimap-label">Throughput</span></a>
    <a class="minimap-item" data-target="pricing"><span class="minimap-dot"></span><span class="minimap-label">Pricing</span></a>
  </div>
  <div class="minimap-phase">
    <div class="minimap-phase-label">Business Models</div>
    <a class="minimap-item" data-target="managed-vs-rental"><span class="minimap-dot"></span><span class="minimap-label">Managed vs Rental</span></a>
    <a class="minimap-item" data-target="buy-vs-rent"><span class="minimap-dot"></span><span class="minimap-label">Buy vs Rent</span></a>
    <a class="minimap-item" data-target="data-centers"><span class="minimap-dot"></span><span class="minimap-label">Data Centers</span></a>
  </div>
  <div class="minimap-phase">
    <div class="minimap-phase-label">Capital Structure</div>
    <a class="minimap-item" data-target="equity-vs-debt"><span class="minimap-dot"></span><span class="minimap-label">Equity vs Debt</span></a>
    <a class="minimap-item" data-target="contracted-revenue"><span class="minimap-dot"></span><span class="minimap-label">Contracted Revenue</span></a>
    <a class="minimap-item" data-target="stage-by-stage"><span class="minimap-dot"></span><span class="minimap-label">Stage by Stage</span></a>
  </div>
</div>

<!-- ─── HERO ─── -->
<section class="hero">
  <div class="hero-label">The Business of AI Compute</div>
  <h1>From Token to <em>Balance Sheet</em></h1>
  <p class="hero-sub">How AI inference is priced, built, financed, and scaled &mdash; the economics behind every API call.</p>
  <div class="hero-cta"><span>Scroll to explore</span><span class="arrow">&darr;</span></div>
</section>

<!-- ─── PHASE OVERVIEW ─── -->
<div class="phase-overview">
  <a class="phase-card reveal" href="#phase-d">
    <div class="phase-letter">D</div>
    <div class="phase-name">Unit Economics</div>
    <div class="phase-subtitle">The micro view &mdash; per-token cost &amp; price</div>
    <div class="phase-steps">
      <span>D1 &middot; The Cost Stack</span>
      <span>D2 &middot; Throughput as Margin</span>
      <span>D3 &middot; Pricing Structures</span>
    </div>
  </a>
  <a class="phase-card reveal" href="#phase-e">
    <div class="phase-letter">E</div>
    <div class="phase-name">Business Models</div>
    <div class="phase-subtitle">Company decisions &mdash; build, rent, or serve</div>
    <div class="phase-steps">
      <span>E1 &middot; Managed Inference vs GPU Rental</span>
      <span>E2 &middot; Buy vs Rent GPUs</span>
      <span>E3 &middot; Data Center Economics</span>
    </div>
  </a>
  <a class="phase-card reveal" href="#phase-f">
    <div class="phase-letter">F</div>
    <div class="phase-name">Capital Structure</div>
    <div class="phase-subtitle">Macro view &mdash; how it all gets financed</div>
    <div class="phase-steps">
      <span>F1 &middot; Why Equity Costs More Than Debt</span>
      <span>F2 &middot; Contracted Revenue &amp; Lenders</span>
      <span>F3 &middot; Debt vs Equity Across Stages</span>
    </div>
  </a>
</div>

<!-- ─── PIPELINE ─── -->
<section class="pipeline-section">
  <div class="section-label">Economics of AI Inference</div>
  <h2 class="section-title">Follow the Dollar</h2>
  <p class="section-desc">The technical pipeline follows the token from request to response. This page follows the dollar &mdash; from the cost of a single GPU-hour through pricing, business models, and capital markets.</p>

  <div class="pipeline-flow">

    <!-- ═══ PHASE D ═══ -->
    <div class="phase-divider" id="phase-d">
      <div class="phase-divider-marker">D</div>
      <div class="phase-divider-content">
        <div class="phase-divider-name">Unit Economics</div>
        <div class="phase-divider-desc">What it costs to serve a token &amp; what you charge for it</div>
      </div>
    </div>

    <!-- D1: The Cost Stack -->
    <div class="pipeline-step reveal" data-step="cost-stack" id="cost-stack">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">D1</span>
          <span class="step-name">The Cost Stack</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Bottom-up cost per GPU-hour: hardware amortization, power, networking, data center, and operations. <span class="term" data-term="capex">CapEx</span> vs <span class="term" data-term="opex">OpEx</span> drives everything.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Cost per million tokens = Total hourly GPU cost &divide; tokens served per hour. Throughput optimization is literally margin expansion.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>A restaurant's cost per meal &mdash; ingredients, rent, labor, utilities. Two restaurants with identical kitchens can have wildly different costs per plate based on how many covers they turn.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Cost Comparison</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Component</th><th>Crusoe (owns infra)</th><th>CoreWeave (leases some)</th></tr></thead>
                  <tbody>
                    <tr><td>GPU CapEx amortized (3yr)</td><td>~$0.95/hr</td><td>~$1.10/hr</td></tr>
                    <tr><td>Power</td><td>~$0.03/hr</td><td>~$0.07/hr</td></tr>
                    <tr><td>Data center (amortized)</td><td>~$0.15/hr</td><td>~$0.25/hr</td></tr>
                    <tr><td>Networking</td><td>~$0.10/hr</td><td>~$0.10/hr</td></tr>
                    <tr><td>Operations/platform</td><td>~$0.10/hr</td><td>~$0.12/hr</td></tr>
                    <tr><td><strong>Total cost per H100-hr</strong></td><td><strong>~$1.33/hr</strong></td><td><strong>~$1.64/hr</strong></td></tr>
                    <tr><td>Selling price</td><td>$2.20/hr</td><td>$2.20/hr</td></tr>
                    <tr><td><strong><span class="term" data-term="gross-margin">Gross Margin</span></strong></td><td><strong>~40%</strong></td><td><strong>~34%</strong></td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Interactive: Cost Waterfall</div>
              <div class="step-visual" id="visual-cost-waterfall"></div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Hardware / Compute</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">GPU purchase &amp; amortization &mdash; the largest line item</div>
                <div class="sub-topic-detail">
                  <p>GPU purchase: H100 SXM ~$25-30K, B200 ~$30-40K. Purchased GPUs amortize over 3-5 years &mdash; cheaper per hour if utilization is high, but depreciation risk from technology obsolescence. Rented GPUs are <span class="term" data-term="opex">OpEx</span> at ~$2.00-3.00/hr mid-market (down from $7-8/hr peak).</p>
                  <p>GPU failure rate: ~2-5% annually, requiring spare buffer inventory. At 10,000 GPUs, expect 200-500 failures per year.</p>
                  <table class="data-table" style="margin-top:0.75rem">
                    <thead><tr><th>GPU</th><th>On-Demand</th><th>Spot</th><th>Provider</th></tr></thead>
                    <tbody>
                      <tr><td>H200 SXM</td><td>$4.29/hr</td><td>&mdash;</td><td>Crusoe</td></tr>
                      <tr><td>H100 SXM</td><td>$3.90/hr</td><td>$1.60/hr</td><td>Crusoe</td></tr>
                      <tr><td>A100 80 GB</td><td>$1.95/hr</td><td>$1.30/hr</td><td>Crusoe</td></tr>
                      <tr><td>MI300X</td><td>$3.45/hr</td><td>$0.95/hr</td><td>Crusoe</td></tr>
                    </tbody>
                  </table>
                  <p style="margin-top:0.5rem"><strong>Spot pricing</strong> fills idle capacity at 50-70% discounts. Workloads must tolerate preemption (checkpointing required), making spot ideal for batch inference and fault-tolerant training but unsuitable for latency-sensitive serving.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Power &amp; Cooling</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview"><span class="term" data-term="pue">PUE</span>, electricity rates, and Crusoe&rsquo;s structural advantage</div>
                <div class="sub-topic-detail">
                  <p>Power cost varies wildly: <strong>$0.03-0.05/kWh</strong> (Crusoe&rsquo;s stranded energy) vs <strong>$0.08-0.12/kWh</strong> (grid in Northern Virginia). A single H100 draws ~700W under load. At $0.10/kWh = $0.07/hr per GPU. At 10,000 GPUs = <strong>$6.1M/year</strong> in electricity.</p>
                  <p><span class="term" data-term="pue">PUE</span> (Power Usage Effectiveness): 1.1 means 10% cooling overhead; 1.4 means 40%. Liquid cooling pushes closer to 1.1, air cooling sits at 1.3-1.5. Every 0.1 improvement in PUE across a 100MW facility saves ~$600K/year.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Networking &amp; Storage</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">InfiniBand adds 15-25% to total cluster cost</div>
                <div class="sub-topic-detail">
                  <p>InfiniBand for multi-GPU inference adds <strong>15-25% to total cluster cost</strong>. For a 1,000 H100 cluster: $5-15M in NICs, switches, and cabling. NVIDIA/Mellanox near-monopoly limits price negotiation.</p>
                  <p>Storage for model weights, KV cache spill, logging: ~5-10% of compute cost.</p>
                  <a href="index.html#cross-cutting" class="cross-link">&rarr; How InfiniBand works in the pipeline</a>
                  <a href="training-economics.html#hardware-costs" class="cross-link">&rarr; Training hardware costs comparison</a>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Operations</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">SRE/DevOps staff, monitoring, on-call</div>
                <div class="sub-topic-detail">
                  <p>Operational costs include SRE/DevOps staff, monitoring infrastructure, on-call rotations, and platform orchestration (Kubernetes, Slurm, auto-node-replacement).</p>
                  <p>GPU failures at 2-5% annually mean a 10,000-GPU fleet needs constant triage &mdash; detecting degraded GPUs, migrating workloads, RMA processing. This is where <span class="term" data-term="opex">OpEx</span> quietly compounds.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- D2: Throughput as Margin -->
    <div class="pipeline-step reveal" data-step="throughput" id="throughput">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">D2</span>
          <span class="step-name">Throughput as Margin</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Same GPU, same model &mdash; wildly different costs. Optimization level creates 3-5x throughput variance, which is why prices vary 10x+ across providers.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Throughput optimization IS margin expansion. If custom CUDA kernels serve 2x the tokens/sec on the same GPU, cost per token halves.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>Two factories with identical machines. One runs at 30% capacity with long changeover times; the other runs at 85% with quick changeovers. Same capital cost, dramatically different unit economics.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">The Formula</div>
              <div class="code-block"><span class="kw">Cost</span> per million tokens = (<span class="fn">Total hourly GPU cost</span>) &divide; (<span class="fn">tokens served per hour</span>)

<span class="kw">Numerator</span> is largely fixed (hardware + power + overhead)
<span class="kw">Denominator</span> varies 3-5x based on optimization level

&rarr; Same hardware, <span class="num">3-5x</span> cost variance</div>
            </div>

            <div class="detail-section">
              <div class="detail-label">What Drives the Denominator</div>
              <div class="metrics-row">
                <div class="metric"><div class="metric-value">3-5x</div><div class="metric-label">Throughput Variance</div></div>
                <div class="metric"><div class="metric-value">10x+</div><div class="metric-label">Price Variance</div></div>
                <div class="metric"><div class="metric-value">80-90%</div><div class="metric-label">Target Utilization</div></div>
              </div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Model Size</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">8B is ~10x cheaper per token than 405B</div>
                <div class="sub-topic-detail">
                  <p>Serving an 8B model is ~10x cheaper per token than 405B. The 405B model needs 8-16 GPUs (vs 1), performs 50x more matrix operations per token, and the larger KV cache per token reduces batch slots from 64+ to 8-16.</p>
                  <table class="data-table">
                    <thead><tr><th>Factor</th><th>8B</th><th>405B</th><th>Penalty</th></tr></thead>
                    <tbody>
                      <tr><td>Weight data per token</td><td>~16 GB</td><td>~810 GB</td><td>~50x</td></tr>
                      <tr><td>GPUs required</td><td>1</td><td>8-16</td><td>8-16x cost</td></tr>
                      <tr><td>Communication overhead</td><td>Zero</td><td>126 all-reduce ops</td><td>Pure penalty</td></tr>
                      <tr><td>Batch size</td><td>64+</td><td>8-16</td><td>4-8x less throughput</td></tr>
                      <tr><td>Cost / M tokens</td><td>$0.03-0.05</td><td>$0.50-1.00</td><td>10-20x</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Optimization Level</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Naive vs fully optimized &mdash; same GPU, 3-5x throughput difference</div>
                <div class="sub-topic-detail">
                  <p>The same model on the same GPU can have <strong>3-5x throughput variance</strong> between naive and fully optimized serving. This includes custom attention kernels (FlashAttention, PagedAttention), quantization (FP16 &rarr; INT4), continuous batching, speculative decoding, and prefix caching.</p>
                  <p>This is why inference platform companies like Fireworks exist &mdash; their serving infrastructure (FireAttention, MemoryAlloy) extracts dramatically more tokens/sec from the same hardware.</p>
                  <a href="index.html#cross-cutting" class="cross-link">&rarr; Performance Optimization Stack details</a>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Batching &amp; Utilization</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">GPU serving one request at a time wastes most capacity</div>
                <div class="sub-topic-detail">
                  <p>A GPU serving one request at a time wastes most of its compute capacity. <span class="term" data-term="statistical-multiplexing">Continuous batching</span> enables 80-90% utilization by adding new requests to an in-flight batch as slots free up.</p>
                  <p>Request characteristics matter: long context uses more KV cache memory, reducing batch slots. Output tokens cost more than input tokens because decode is sequential while prefill is parallel.</p>
                  <a href="index.html#phase-b" class="cross-link">&rarr; How continuous batching works</a>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Reasoning-Mode Throughput</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Interleaved and preserved thinking change decode economics</div>
                <div class="sub-topic-detail">
                  <p>Reasoning models add internal reasoning streams on top of visible output. Effective capacity planning must split <strong>visible tokens</strong> from <strong>reasoning tokens</strong>, then cap runtime via <span class="term" data-term="reasoning-effort">reasoning effort</span> or <span class="term" data-term="thinking-budget">thinking budget</span> controls.</p>
                  <p><span class="term" data-term="interleaved-thinking">Interleaved thinking</span> increases scheduler contention because reasoning and tool calls share the same decode loop. <span class="term" data-term="preserved-thinking">Preserved thinking</span> can reduce repeated work across turns, but raises carried-context cost if history policies are too permissive.</p>
                  <a href="index.html#step-decode" class="cross-link">&rarr; Decode behavior for reasoning models</a>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Hardware Generation</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">B200 with FP4 vs H100 at FP16</div>
                <div class="sub-topic-detail">
                  <p>Hardware generation creates step-function improvements. B200 with FP4 serves the same model at dramatically higher throughput than H100 at FP16. Blackwell delivers 3-5x performance per dollar vs Hopper.</p>
                  <p>This drives the technology obsolescence risk in GPU ownership &mdash; an H100 purchased today may be economically obsolete before fully depreciated.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- D3: Pricing Structures -->
    <div class="pipeline-step reveal" data-step="pricing" id="pricing">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">D3</span>
          <span class="step-name">Pricing Structures</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Per-token, per-GPU-hour, reserved, batch, value-based &mdash; each pricing model maps to a different customer segment, margin profile, and strategic intent.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Frontier inference cost is declining ~10x annually. Reserved contracts are economically similar to fixed-rate swaps on GPU compute prices.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>Airline pricing &mdash; first class, economy, standby, and corporate contracts all sell the same seat-mile at wildly different prices based on flexibility, commitment, and timing.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Customer Segmentation</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Segment</th><th>Volume</th><th>Pricing Model</th><th>Margin</th></tr></thead>
                  <tbody>
                    <tr><td>Hobbyist / prototyping</td><td>&lt;1M tok/day</td><td>Serverless per-token, free tier</td><td>Low/negative</td></tr>
                    <tr><td>Growth startup</td><td>1-100M tok/day</td><td>Serverless &rarr; on-demand</td><td>Medium, expanding</td></tr>
                    <tr><td>Enterprise</td><td>100M+ tok/day</td><td>Reserved capacity, custom</td><td>High</td></tr>
                    <tr><td>Batch / offline</td><td>Large, flexible</td><td>Batch pricing (50% off)</td><td>Medium (fills idle)</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">The Deflation Dynamic</div>
              <div class="detail-text"><p>GPT-3.5 equivalent pricing: <strong>$20/M tokens</strong> (late 2022) &rarr; <strong>$0.40/M tokens</strong> (2025). A 50x decline in ~2.5 years. Reserved contracts lock in today&rsquo;s price &mdash; if costs keep falling, the provider profits on the spread while customers overpay for certainty.</p></div>
              <div class="step-visual" id="visual-deflation-timeline"></div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Per-Token (Serverless)</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">$/million tokens, split input/output</div>
                <div class="sub-topic-detail">
                  <p>Standard for API providers. Input/output split is critical: output tokens cost 2-4x more to serve because decode is sequential. Without the split, adverse selection occurs &mdash; output-heavy workloads subsidized by input-heavy ones.</p>
                  <p>Cached input pricing (~50% discount) incentivizes consistent prefixes, improving server-side prefix cache hit rates. This is pricing that shapes behavior to reduce costs.</p>
                  <table class="data-table" style="margin-top:0.75rem">
                    <thead><tr><th>Model Size Tier</th><th>Input $/M</th><th>Output $/M</th></tr></thead>
                    <tbody>
                      <tr><td>Under 4B</td><td>$0.10</td><td>$0.10</td></tr>
                      <tr><td>4B &ndash; 16B</td><td>$0.20</td><td>$0.20</td></tr>
                      <tr><td>16B &ndash; 80B</td><td>$0.90</td><td>$0.90</td></tr>
                      <tr><td>MoE 56B &ndash; 176B</td><td>$0.50</td><td>$1.20</td></tr>
                    </tbody>
                  </table>
                  <p style="margin-top:0.5rem">Fireworks serverless tiers (open-source models). Cached input at <strong>50% discount</strong>; batch mode adds another <strong>50% discount</strong> for non-real-time workloads. The MoE output premium reflects decode-bound compute despite efficient routing.</p>
                  <a href="index.html#phase-a" class="cross-link">&rarr; Rate limits as pricing levers</a>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Reasoning &amp; Fine-Tune Tiers</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Pricing for reasoning tokens and custom adapters</div>
                <div class="sub-topic-detail">
                  <p>For reasoning models, many teams now separate visible output from reasoning streams (for example <span class="term" data-term="reasoning-content">reasoning_content</span>) and apply policy caps with <span class="term" data-term="reasoning-effort">effort</span>, <span class="term" data-term="thinking-budget">budget</span>, and <span class="term" data-term="reasoning-history">history</span> controls.</p>
                  <p>Fine-tuned offerings add another pricing layer: base model usage + adapter premium. Fireworks-style LoRA deployment economics (including multi-adapter serving and one-click adapter deployment) allow providers to segment by workflow quality, not just raw token volume.</p>
                  <table class="data-table" style="margin-top:0.75rem">
                    <thead><tr><th>Model</th><th>Input $/M</th><th>Output $/M</th><th>Ratio</th></tr></thead>
                    <tbody>
                      <tr><td>DeepSeek V3 (671B MoE)</td><td>$0.56</td><td>$1.68</td><td>3.0&times;</td></tr>
                      <tr><td>DeepSeek R1 (reasoning)</td><td>$3.00</td><td>$8.00</td><td>2.7&times;</td></tr>
                      <tr><td>GLM-5-0520 (vision)</td><td>$1.50</td><td>$3.00</td><td>2.0&times;</td></tr>
                      <tr><td>Kimi K2.5 (MoE)</td><td>$0.48</td><td>$1.44</td><td>3.0&times;</td></tr>
                    </tbody>
                  </table>
                  <p style="margin-top:0.5rem">Output tokens cost <strong>2&ndash;5&times; input</strong> across all models &mdash; the ratio reflects decode&rsquo;s sequential nature. Reasoning models carry the highest absolute rates because extended chain-of-thought generates 5&ndash;20&times; more output tokens per query.</p>
                  <a href="training.html#sft" class="cross-link">&rarr; Fine-tuning methods and deployment implications</a>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Reserved &amp; Committed</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">30-60% discounts for 1-3 year commitments</div>
                <div class="sub-topic-detail">
                  <p>Revenue predictability for both sides. Reserved contracts are <span class="term" data-term="fixed-rate-swap">economically similar to fixed-rate swaps</span>: provider receives fixed payments, effectively pays floating (market cost of delivering compute). In a deflationary environment, existing contracts become more valuable.</p>
                  <p>The real risk isn&rsquo;t the contract price &mdash; it&rsquo;s what the contract signals about capacity planning. Contracted capacity is hedged; uncontracted capacity is an outright bet on future pricing.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Batch Pricing</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">40-50% discount for non-real-time workloads</div>
                <div class="sub-topic-detail">
                  <p>Like standby airline tickets &mdash; fills idle capacity. Customer gives up latency guarantees in exchange for significant discount. Provider gains utilization in off-peak periods.</p>
                  <p>Batch workloads smooth demand curves: if real-time peaks at 2pm, batch jobs absorb 2am-6am idle capacity. This improves overall fleet utilization from 40-50% to 80-90%.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Strategic Pricing</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Pricing as competitive weapon</div>
                <div class="sub-topic-detail">
                  <p><strong>Land and expand:</strong> Price serverless tier aggressively (even below cost) to acquire developers, monetize at scale when usage grows.</p>
                  <p><strong>Value-based:</strong> Voice agent inference priced per-minute, not per-token. Aligns with customer&rsquo;s value perception &mdash; they think in &ldquo;minutes of agent time,&rdquo; not tokens.</p>
                  <p><strong>Competitive moat:</strong> If you have 2x throughput advantage (FireAttention), price 30% below competitors while maintaining better margins. Your optimization is their impossibility.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>


    <!-- ═══ PHASE E ═══ -->
    <div class="phase-divider" id="phase-e">
      <div class="phase-divider-marker">E</div>
      <div class="phase-divider-content">
        <div class="phase-divider-name">Business Models</div>
        <div class="phase-divider-desc">Company-level decisions &mdash; build, rent, or serve</div>
      </div>
    </div>

    <!-- E1: Managed Inference vs GPU Rental -->
    <div class="pipeline-step reveal" data-step="managed-vs-rental" id="managed-vs-rental">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">E1</span>
          <span class="step-name">Managed Inference vs GPU Rental</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Two fundamentally different businesses: selling outcomes (tokens) vs selling infrastructure (GPUs). <span class="term" data-term="statistical-multiplexing">Statistical multiplexing</span> is the magic of managed inference.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Managed inference sells outcomes at 55-70% gross margin via statistical multiplexing. GPU rental sells infrastructure at 34-40% margin with simpler operations but massive CapEx.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>Uber vs Hertz. Uber sells rides (outcomes) and pools cars across thousands of passengers. Hertz rents you the car &mdash; you worry about driving. Both make money on vehicles, but the economics are completely different.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Model Comparison</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Dimension</th><th>Managed Inference</th><th>GPU Rental</th></tr></thead>
                  <tbody>
                    <tr><td>What you sell</td><td>Tokens, completions, minutes</td><td>Raw GPU-hours</td></tr>
                    <tr><td>Customer thinks about</td><td>Outcomes</td><td>Infrastructure</td></tr>
                    <tr><td>Gross margin</td><td>55-70%</td><td>34-40%</td></tr>
                    <tr><td>Key advantage</td><td>Statistical multiplexing</td><td>Simpler operations</td></tr>
                    <tr><td>CapEx intensity</td><td>Lower (can rent GPUs)</td><td>Very high</td></tr>
                    <tr><td>R&amp;D cost</td><td>High (serving stack)</td><td>Moderate (platform)</td></tr>
                    <tr><td>Risk</td><td>Correlated demand spikes</td><td>Utilization &amp; pricing deflation</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Statistical Multiplexing</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">The insurance math behind managed inference</div>
                <div class="sub-topic-detail">
                  <p><span class="term" data-term="statistical-multiplexing">Statistical multiplexing</span> &mdash; Customer A peaks at 2pm, Customer B at 6pm, Customer C runs batch overnight. Pooling across thousands of customers enables <strong>80-90% GPU utilization</strong>, far higher than any single customer achieves.</p>
                  <p>Like insurance pooling &mdash; the law of large numbers applies to token traffic. The risk: <strong>correlated demand spikes</strong>. When a new model drops or a viral AI demo happens, everyone hits the API simultaneously. This is the &ldquo;catastrophic event&rdquo; requiring burst capacity or graceful degradation.</p>
                  <a href="index.html#phase-b" class="cross-link">&rarr; How continuous batching enables this</a>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Pricing Design Decisions</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Input/output split, cached pricing, model catalog</div>
                <div class="sub-topic-detail">
                  <p><strong>Input vs output split:</strong> Output tokens cost 2-4x more to serve. Without the split, adverse selection occurs &mdash; output-heavy workloads are subsidized.</p>
                  <p><strong>Cached input pricing:</strong> ~50% discount incentivizes consistent prefixes, improving prefix cache hit rates. Pricing that shapes behavior.</p>
                  <p><strong>Model-specific pricing:</strong> Based on cost to serve, competitive pricing, demand elasticity, and strategic value. Popular models subsidize long-tail catalog with sparse traffic.</p>
                  <table class="data-table" style="margin-top:0.75rem">
                    <thead><tr><th>GPU</th><th>Fireworks On-Demand</th><th>Crusoe On-Demand</th><th>Crusoe Spot</th></tr></thead>
                    <tbody>
                      <tr><td>H100 SXM</td><td>$5.49/hr</td><td>$3.90/hr</td><td>$1.60/hr</td></tr>
                      <tr><td>A100 80 GB</td><td>$3.19/hr</td><td>$1.95/hr</td><td>$1.30/hr</td></tr>
                    </tbody>
                  </table>
                  <p style="margin-top:0.5rem">The <strong>managed premium</strong>: Fireworks charges ~40% more than Crusoe on-demand for the same GPU because the rate bundles inference-optimized software (FireAttention, LoRA multiplexing, autoscaling). Crusoe spot at $1.60/hr represents raw infrastructure. The spread ($1.60 &rarr; $5.49) is where the entire inference software stack gets monetized.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">PM Decisions</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Catalog, rate limits, deprecation, optimization pass-through</div>
                <div class="sub-topic-detail">
                  <p><strong>1. Model catalog:</strong> Which models to add and when &mdash; each has hosting cost whether used or not. Warm GPUs for a model nobody calls is pure waste.</p>
                  <p><strong>2. Rate limits &amp; SLA tiers:</strong> Maps to burst capacity reserved per customer. Higher tier = more dedicated headroom = higher price.</p>
                  <p><strong>3. Model deprecation:</strong> Old models eat GPU memory, but enterprise customers depend on them. Migration timelines are diplomatic minefields.</p>
                  <p><strong>4. Optimization pass-through:</strong> When your team ships a 2x throughput improvement, do you pass savings to customers (growth) or keep as margin (profitability)?</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Cannibalization Tension</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">When managed inference undermines GPU rental</div>
                <div class="sub-topic-detail">
                  <p>When Crusoe launches Managed Inference alongside GPU rental, they create internal tension. If MemoryAlloy delivers 9.9x better TTFT and 81% cost reduction, why would any inference customer rent raw GPUs?</p>
                  <p><strong>How MemoryAlloy works:</strong> a cluster-wide KV cache that uses <span class="term" data-term="rdma">RDMA</span> to pool GPU memory across nodes. Instead of each GPU holding its own cache, MemoryAlloy treats the entire cluster&rsquo;s HBM as a shared resource. This enables instant context reuse across requests &mdash; the 9.9&times; TTFT improvement comes from eliminating redundant prefill when cached KV states exist elsewhere in the cluster. Supported models include Llama 3.1/3.3, DeepSeek R1/V3, and Qwen 2.5.</p>
                  <p>The resolution: GPU rental increasingly serves <strong>training</strong> customers and custom workloads. Managed inference captures inference demand at higher margin. Total revenue per GPU potentially goes up &mdash; but the PM must model the revenue migration carefully.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Infrastructure Platform Features</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">VPC, InfiniBand, managed orchestration, and SLA guarantees</div>
                <div class="sub-topic-detail">
                  <p>GPU cloud providers differentiate on platform features beyond raw compute. Crusoe&rsquo;s stack illustrates what enterprise buyers expect:</p>
                  <p><strong>Networking:</strong> InfiniBand for GPU-to-GPU, NVLink within nodes, RDMA for cluster-wide memory access. These determine whether multi-node inference and distributed training are viable.</p>
                  <p><strong>Orchestration:</strong> Managed Kubernetes (K8s) and Slurm for job scheduling. AutoClusters provision multi-node GPU environments in minutes rather than days of manual configuration.</p>
                  <p><strong>Isolation:</strong> VPC (Virtual Private Cloud) for network isolation, per-minute billing granularity, and enterprise security boundaries.</p>
                  <p><strong>SLAs:</strong> 99.98% uptime guarantee, &lt;6 minute support response time. These commitments unlock enterprise procurement cycles that require contractual guarantees.</p>
                  <p><strong>Hardware roadmap:</strong> GB200, B200, and MI355X availability signals to customers that the provider won&rsquo;t strand them on last-gen hardware &mdash; critical for multi-year capacity planning.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- E2: Buy vs Rent GPUs -->
    <div class="pipeline-step reveal" data-step="buy-vs-rent" id="buy-vs-rent">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">E2</span>
          <span class="step-name">Buy vs Rent GPUs</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Breakeven at 44% utilization before <span class="term" data-term="wacc">WACC</span>, 59% after. Technology obsolescence makes buying a depreciating asset bet; renting buys a monthly call option on compute.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Buying a GPU = being long a depreciating asset with uncertain future value. Renting = buying a monthly call option on compute capacity. The optimal strategy is a barbell: own base-load, rent flexibility.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>Electric utilities: own baseload power plants (nuclear, hydro &mdash; predictable, cheap per kWh) and buy peaking capacity on the spot market (gas turbines &mdash; flexible, expensive per kWh).</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Interactive: Breakeven Calculator</div>
              <div class="step-visual" id="visual-breakeven-calc"></div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Residual Value Scenarios</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Scenario</th><th>H100 Residual (3yr)</th><th>Value</th><th>Implication</th></tr></thead>
                  <tbody>
                    <tr><td>Bull case</td><td>40%</td><td>~$11K</td><td>Ownership strongly favored</td></tr>
                    <tr><td>Base case</td><td>20%</td><td>~$5.5K</td><td>Ownership favored at high utilization</td></tr>
                    <tr><td>Bear case</td><td>5%</td><td>~$1.4K</td><td>Next-gen makes it essentially worthless</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">TCO Breakdown</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Buy-side: $1.10/hr fully loaded vs rent at $2.50/hr</div>
                <div class="sub-topic-detail">
                  <p><strong>Buy side <span class="term" data-term="tco">TCO</span> per GPU-hour:</strong> Purchase price amortized over useful life + cost of capital + power/cooling + maintenance (2-5% annual failure rate) &minus; residual/salvage value.</p>
                  <p><strong>Depreciation tension:</strong> H100 straight-line over 3 years = ~$0.95/hr. Over 5 years = ~$0.57/hr. But GPU tech cycles are accelerating: H100 (2022) &rarr; H200 (2024) &rarr; B200 (2025). If Blackwell delivers 3-5x performance per dollar, H100 depreciating over 5 years is economically obsolete before fully depreciated.</p>
                  <p><strong>Rent side:</strong> ~$2.00-3.00/hr for H100. No upfront <span class="term" data-term="capex">CapEx</span>. Flexibility to scale. Obsolescence risk sits with the lessor &mdash; but you&rsquo;re paying their margin.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Cost of Capital Changes Everything</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview"><span class="term" data-term="wacc">WACC</span> shifts breakeven from 44% to 59-76%</div>
                <div class="sub-topic-detail">
                  <p>If blended <span class="term" data-term="wacc">WACC</span> for GPU purchases is 12%, the $28K H100 has economic cost of <strong>$3,360/year in capital charges alone</strong> &mdash; adding ~$0.38/hr to ownership cost, pushing fully loaded from $1.10 to ~$1.48/hr.</p>
                  <p>Breakeven utilization moves from 44% to ~59%. If funded with pure equity at 25%, breakeven jumps to ~76%. Interest rate environment matters: 300-400 bps difference on $1B GPU purchase = $30-40M/year in additional interest expense.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Technology Obsolescence</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Option value of renting vs owning</div>
                <div class="sub-topic-detail">
                  <p><strong>Renting = buying a monthly call option on compute.</strong> You pay a premium but maintain optionality to switch hardware, scale down, or pivot. Option value increases when volatility is high (AI hardware changing every 12-18 months), time horizon is uncertain, and interest rates are high.</p>
                  <p><strong>Buying is attractive when:</strong> Demand is highly predictable (Crusoe&rsquo;s 15-year Abilene lease), structural cost advantage exists (cheap power extends economic life), and the asset can be redeployed across use cases.</p>
                  <a href="index.html#cross-cutting" class="cross-link">&rarr; GPU Memory Hierarchy details</a>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">The Barbell Strategy</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Own base-load, rent flexibility</div>
                <div class="sub-topic-detail">
                  <p>The optimal strategy: <strong>heavy ownership of base-load capacity</strong> funded by low-cost infrastructure debt secured against long-term contracts, combined with <strong>rental/spot capacity for flexibility</strong>.</p>
                  <p>Like utilities: own baseload plants, buy peaking capacity on the spot market. The owned portion provides cost advantage; the rented portion provides optionality. The ratio depends on demand predictability and cost of capital.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- E3: Data Center Economics -->
    <div class="pipeline-step reveal" data-step="data-centers" id="data-centers">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">E3</span>
          <span class="step-name">Data Center Economics</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">$/kW/month is the unit, not $/sqft. Power is the binding constraint &mdash; AI racks draw 40-140 kW vs 2-4 kW for legacy, making space essentially free.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Crusoe's ~$50/kW/month energy advantage at a 100MW facility = $60M/year in structural cost savings that flow directly to margin or competitive pricing.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>Real estate for aluminum smelters &mdash; you don&rsquo;t price by square footage because the smelter&rsquo;s value is entirely determined by access to cheap electricity. Same with AI data centers.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Facility Type Ranges</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Facility Type</th><th>$/kW/month</th></tr></thead>
                  <tbody>
                    <tr><td>Wholesale colocation (legacy)</td><td>$80-120</td></tr>
                    <tr><td>Retail colocation</td><td>$120-180</td></tr>
                    <tr><td>AI-optimized facility</td><td>$150-250+</td></tr>
                    <tr><td>Hyperscaler self-build</td><td>$50-80 effective</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Crusoe&rsquo;s Energy Advantage</div>
              <div class="detail-text">
                <div class="metrics-row">
                  <div class="metric"><div class="metric-value">$0.03</div><div class="metric-label">Crusoe $/kWh</div></div>
                  <div class="metric"><div class="metric-value">$0.10</div><div class="metric-label">Grid $/kWh (NoVA)</div></div>
                  <div class="metric"><div class="metric-value">$50</div><div class="metric-label">$/kW/mo Advantage</div></div>
                  <div class="metric"><div class="metric-value">$60M</div><div class="metric-label">Annual Savings (100MW)</div></div>
                </div>
                <p>Traditional operator at $0.10/kWh: 1 kW continuous for a month = $72 just in electricity. Out of $150/kW/month price, nearly half is power. Crusoe at $0.03/kWh: same 1 kW = $22/month.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Crusoe Facility Portfolio</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Location</th><th>Capacity</th><th>Energy Source</th></tr></thead>
                  <tbody>
                    <tr><td>Abilene, TX</td><td>1.2 GW</td><td>Grid + renewables</td></tr>
                    <tr><td>Iceland</td><td>Expanding</td><td>Geothermal (near-zero carbon)</td></tr>
                    <tr><td>Wyoming</td><td>Operating</td><td>Stranded natural gas</td></tr>
                    <tr><td>Norway</td><td>Planned</td><td>Hydroelectric</td></tr>
                    <tr><td>Argentina</td><td>Planned</td><td>Stranded gas (Vaca Muerta)</td></tr>
                  </tbody>
                </table>
                <p style="margin-top:0.5rem">Crusoe&rsquo;s Abilene campus alone at <strong>1.2 GW</strong> would rank among the largest single-site data center deployments globally. The geographic diversification across clean/stranded energy sources hedges against regional power regulation and positions the company for enterprise customers with carbon-reduction mandates. A nuclear energy partnership with Blue Owl Capital adds baseload diversification beyond renewables.</p>
              </div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Power as Binding Constraint</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">AI racks draw 30-70x more power than legacy</div>
                <div class="sub-topic-detail">
                  <p>Legacy server rack: 2-4 kW. AI rack with 8 H100s: 40-70 kW. GB200 NVL72 rack: 120-140 kW. That&rsquo;s <strong>30-70x more power</strong> but roughly the same physical footprint. Pricing by square footage breaks completely.</p>
                  <p>Power delivery infrastructure alone costs millions: transformers ($1-5M each), switchgear, UPS, backup generators, distribution. Redundancy requirements (N+1 or 2N) mean 100 kW provisioned &rarr; 200 kW built.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Cooling at Scale</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Every watt consumed = a watt of heat to remove</div>
                <div class="sub-topic-detail">
                  <p>Every watt consumed becomes a watt of heat to remove. At 140 kW/rack, air cooling physically cannot keep up &mdash; liquid cooling is required. Cost scales linearly with kW.</p>
                  <p><span class="term" data-term="pue">PUE</span> captures this overhead. PUE of 1.1 (liquid) means 10% cooling overhead. PUE of 1.4 (air) means 40%. The difference at 100MW: an extra 30MW consumed just for cooling, or ~$15M/year at grid rates.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">What $/kW/month Bundles</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Power, cooling, redundancy &mdash; space is essentially free</div>
                <div class="sub-topic-detail">
                  <p>The $/kW/month price bundles: <strong>power delivery infrastructure</strong> (transformers, switchgear, UPS, generators, distribution), <strong>cooling capacity</strong> (linearly proportional to power), <strong>redundancy</strong> (N+1 or 2N), and <strong>physical space</strong> (essentially free at this point &mdash; tiny fraction of total cost).</p>
                  <p>This is why the metric is $/kW/month: it captures the actual scarce resource (power capacity) rather than the abundant one (floor space).</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>


    <!-- ═══ PHASE F ═══ -->
    <div class="phase-divider" id="phase-f">
      <div class="phase-divider-marker">F</div>
      <div class="phase-divider-content">
        <div class="phase-divider-name">Capital Structure</div>
        <div class="phase-divider-desc">How it all gets financed &mdash; debt, equity, and the cost of capital</div>
      </div>
    </div>

    <!-- F1: Why Equity Costs More Than Debt -->
    <div class="pipeline-step reveal" data-step="equity-vs-debt" id="equity-vs-debt">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">F1</span>
          <span class="step-name">Why Equity Costs More Than Debt</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Debt holders get paid first, accept lower returns. Equity holders are last in line with uncapped upside and uncapped downside &mdash; demanding much higher required returns.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Equity costs 3-4x more than debt because equity holders bear residual risk with no contractual protection. The tax shield on debt interest makes the gap even wider.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>A building with floors. Debt holders live on the ground floor &mdash; if the building sinks, they&rsquo;re last to get wet. Equity holders live in the penthouse &mdash; great view, but first to feel any earthquake. Higher floor = higher risk = higher rent.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">The Risk Hierarchy</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Dimension</th><th>Debt</th><th>Equity</th></tr></thead>
                  <tbody>
                    <tr><td>Priority in liquidation</td><td>First (senior)</td><td>Last (residual)</td></tr>
                    <tr><td>Cash flows</td><td>Contractual (fixed interest)</td><td>Residual (dividends optional)</td></tr>
                    <tr><td>Upside</td><td>Capped at interest rate</td><td>Uncapped</td></tr>
                    <tr><td>Downside</td><td>Protected by covenants</td><td>Can lose everything</td></tr>
                    <tr><td>Tax treatment</td><td>Interest is deductible</td><td>Returns are not</td></tr>
                    <tr><td>Typical cost</td><td>7-10%</td><td>20-30%+</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Tax Shield</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Interest deductibility widens the cost gap</div>
                <div class="sub-topic-detail">
                  <p>Interest payments are tax-deductible. At 21% corporate tax rate, 8% interest &rarr; ~6.3% after-tax cost. Equity returns have no such benefit.</p>
                  <p>On $5B of debt at 8%, the tax shield is worth <strong>$84M/year</strong> &mdash; pure value creation from choosing debt over equity for the same investment.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Contractual vs Residual Claims</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Debt holders price for downside protection</div>
                <div class="sub-topic-detail">
                  <p>Debt holder&rsquo;s max upside is the interest rate (8%). They price for downside protection via covenants, collateral, and priority. Equity investors face uncapped upside <em>and</em> uncapped downside &mdash; they need much higher expected returns to justify the risk.</p>
                  <p>Information asymmetry compounds this: debt holders protect themselves with covenants, while equity holders have board seats but can&rsquo;t contractually force profitability. More trust required = riskier = more expensive.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Why Not All Debt?</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Financial distress, capacity limits, rising marginal cost</div>
                <div class="sub-topic-detail">
                  <p>If debt is cheaper, why not fund everything with debt? Three limits:</p>
                  <p><strong>1. Financial distress risk:</strong> Too much leverage makes a temporary downturn existential. Missing one interest payment can trigger default cascades.</p>
                  <p><strong>2. Debt capacity limits:</strong> Lenders won&rsquo;t fund beyond cash flow coverage. The <span class="term" data-term="dscr">DSCR</span> sets a hard ceiling.</p>
                  <p><strong>3. Rising marginal cost:</strong> First billion at 8%, fifth billion at 12%. At some point, additional debt costs more than equity.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- F2: Contracted Revenue & Lenders -->
    <div class="pipeline-step reveal" data-step="contracted-revenue" id="contracted-revenue">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">F2</span>
          <span class="step-name">Contracted Revenue &amp; Lenders</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Not collateral &mdash; cash flow underwriting. Contracted revenue answers the question lenders care about most: &ldquo;How likely is it that you default?&rdquo; via <span class="term" data-term="dscr">DSCR</span> mechanics.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>A 40% commitment discount looks expensive in isolation, but the contracted revenue it creates can unlock debt capacity whose NPV far exceeds the discount given. Pricing decisions directly affect capital structure.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>Getting a mortgage. The bank doesn&rsquo;t just look at the house (collateral) &mdash; they look at your salary and employment contract (contracted revenue). A tenured professor with $100K salary gets a bigger mortgage at a lower rate than a freelancer earning $150K with no contract.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">The Four Mechanisms</div>
              <div class="detail-text">
                <div class="metrics-row">
                  <div class="metric"><div class="metric-value">3-4x</div><div class="metric-label">Higher Debt Capacity</div></div>
                  <div class="metric"><div class="metric-value">150bps</div><div class="metric-label">Lower Interest Rate</div></div>
                  <div class="metric"><div class="metric-value">2-3x</div><div class="metric-label">Longer Tenor</div></div>
                  <div class="metric"><div class="metric-value">$75M</div><div class="metric-label">Annual Interest Savings ($5B)</div></div>
                </div>
              </div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Higher Debt Capacity</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview"><span class="term" data-term="dscr">DSCR</span> math: same facility, dramatically different borrowing</div>
                <div class="sub-topic-detail">
                  <p>Lenders size loans using <span class="term" data-term="dscr">DSCR</span> &mdash; want cash flow at 1.3-2.0x annual debt service.</p>
                  <p><strong>Without contracted revenue:</strong> Lender underwrites to conservative $300M &rarr; $150M FCF &rarr; supports ~$100M/year debt service &rarr; ~$1-1.5B total debt capacity.</p>
                  <p><strong>With 15-year Oracle contract at $600M/year:</strong> Lender underwrites to $600M &rarr; $400M FCF &rarr; supports ~$267M/year debt service &rarr; ~$3-4B total debt capacity. Same facility, dramatically different borrowing.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Lower Interest &amp; Looser Covenants</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview"><span class="term" data-term="sofr">SOFR</span> + 400bps &rarr; SOFR + 250bps</div>
                <div class="sub-topic-detail">
                  <p>Contracted revenue with investment-grade counterparty compresses spread: <span class="term" data-term="sofr">SOFR</span> + 400bps &rarr; SOFR + 250bps. On $5B = <strong>$75M/year in interest savings</strong>.</p>
                  <p>Looser covenants: fewer restrictions on additional borrowing, less stringent maintenance ratios, more operational flexibility. Longer tenor: 15-year contracted revenue supports 10-12 year debt vs 3-5 years for uncontracted.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Assignment of Contracts</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Quasi-collateral: lenders step into payment streams</div>
                <div class="sub-topic-detail">
                  <p>Lenders structure <strong>assignment of contracts</strong> as security interest. If Crusoe defaults, JPMorgan could step into Crusoe&rsquo;s position and receive Oracle&rsquo;s lease payments directly.</p>
                  <p>Like mortgage-backed securities &mdash; the payment streams themselves are the security. Not the physical assets, but the right to receive contracted cash flows.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">The Virtuous Cycle</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Contracts &rarr; cheaper debt &rarr; lower WACC &rarr; more contracts</div>
                <div class="sub-topic-detail">
                  <p>Every 1-year or 3-year GPU reservation contract signed makes the debt package more attractive to lenders &rarr; cheaper debt &rarr; lower <span class="term" data-term="wacc">WACC</span> &rarr; more competitive pricing &rarr; more customers &rarr; more contracts &rarr; even more debt capacity.</p>
                  <p>This is why commitment discounts aren&rsquo;t just about revenue: they&rsquo;re a capital structure optimization. The PM must model the full-cycle NPV, not just the direct pricing impact.</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- F3: Debt vs Equity Across Stages -->
    <div class="pipeline-step reveal" data-step="stage-by-stage" id="stage-by-stage">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">F3</span>
          <span class="step-name">Debt vs Equity Across Stages</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">From Series A (95-100% equity) to public company (optimized mix). As cash flows become more predictable, the optimal debt/equity ratio shifts dramatically.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Debt requires predictability. Equity tolerates uncertainty. Crusoe runs two capital structures in one company: project-finance-funded infrastructure + venture-funded software.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like...</div>
              <p>A person&rsquo;s financial life. College student = 100% &ldquo;equity&rdquo; (parental support, scholarships). First job = some debt (car loan). Established career = mortgage, credit lines. Retired = optimized portfolio. More predictable income unlocks more leverage.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Interactive: Capital Structure by Stage</div>
              <div class="step-visual" id="visual-capital-bars"></div>
            </div>

            <div class="sub-topics">
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Series A &rarr; Series B</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">95-100% equity &rarr; 80-90% equity</div>
                <div class="sub-topic-detail">
                  <p><strong>Series A:</strong> No revenue, no assets, no track record. Might not exist in 18 months. Cost of equity: 50-100%+ implied (VCs need 100x potential). Debt is unavailable. Mix: 95-100% equity. Exception: venture debt (20-30% of last equity round) with warrants.</p>
                  <p><strong>Series B:</strong> $5-20M ARR, real product, paying customers. Cost of equity: 30-50%. Cost of debt: 12-15% (venture debt with warrants). Mix: 80-90% equity. Equipment financing becomes possible (80% LTV on GPU purchases).</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Series C/D &rarr; Pre-IPO</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">60-80% equity &rarr; 40-60% equity</div>
                <div class="sub-topic-detail">
                  <p><strong>Series C/D:</strong> $50-200M+ ARR, proven unit economics, enterprise contracts. Cost of equity: 15-25%. Cost of debt: 8-12% (term loans, asset-backed). Mix: 60-80% equity. CoreWeave pioneered billions in GPU-backed debt at this stage.</p>
                  <p><strong>Pre-IPO:</strong> $200M-1B+ revenue, clear profitability path. Cost of equity: 12-20%. Cost of debt: 6-9%. Mix: 40-60% equity. Convertible notes popular: lower interest (2-5%) with embedded call option. Crusoe is here now (Series E, $10B+).</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Public Company</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Full optimization &mdash; cost of equity drops dramatically</div>
                <div class="sub-topic-detail">
                  <p>Cost of equity drops dramatically: 10-15% (liquidity, transparency, diversifiability). Cost of debt: 4-7% (investment-grade bonds, commercial paper). Gap narrows but never closes &mdash; debt holders are always paid first.</p>
                  <p>Active capital management: share buybacks, debt-funded buybacks, dividend policy, credit rating management. The CFO becomes a portfolio manager optimizing the capital structure continuously.</p>
                </div>
              </div>
              <div class="sub-topic" onclick="toggleSubTopic(this)">
                <div class="sub-topic-header">
                  <span class="sub-topic-name">Crusoe&rsquo;s Dual Structure</span>
                  <span class="sub-topic-icon">+</span>
                </div>
                <div class="sub-topic-preview">Two capital structures in one company</div>
                <div class="sub-topic-detail">
                  <p>Crusoe runs two capital structures simultaneously:</p>
                  <p><strong>Project-finance infrastructure:</strong> Abilene&rsquo;s $9.6B debt + $5B equity. Low cost of capital, asset-heavy, contracted cash flows. Like a utility or pipeline company.</p>
                  <p><strong>Venture-funded software:</strong> Cloud platform, managed inference. High cost of capital, asset-light, uncertain returns. Like a typical tech startup.</p>
                  <p>The PM must understand which investments belong to which bucket. Managed inference feature ($20M) &rarr; equity-funded, needs venture-scale returns. Data center with signed contract &rarr; leverage cheap debt, lower hurdle rate.</p>
                </div>
              </div>
            </div>

            <a href="training-economics.html#model-funding" class="cross-link">&rarr; Foundation model funding &amp; mega-rounds</a>

          </div>
        </div>
      </div>
    </div>

  </div><!-- /.pipeline-flow -->
</section>

<!-- ─── FOOTER ─── -->
<footer class="footer">
  <p>A learning resource for AI infrastructure economics</p>
  <p style="margin-top:0.5rem"><a href="index.html" style="color:var(--accent-dim);text-decoration:none;font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.1em">&larr; TECHNICAL PIPELINE</a></p>
</footer>


<!-- ─── JAVASCRIPT ─── -->
<script>
(function(){
  'use strict';

  /* ─── TERM DEFINITIONS ─── */
  var termDefs = {
    'dscr': 'Debt Service Coverage Ratio — the ratio of net operating income to total debt service (interest + principal). Lenders typically require 1.3-2.0x, meaning cash flow must exceed debt payments by 30-100%.',
    'wacc': 'Weighted Average Cost of Capital — the blended cost of all funding sources (debt + equity), weighted by their proportion. If 60% equity at 25% and 40% debt at 8%, WACC = 18.2%.',
    'sofr': 'Secured Overnight Financing Rate — the benchmark interest rate that replaced LIBOR. Infrastructure debt is typically priced as SOFR + a spread (e.g., SOFR + 250-400 bps).',
    'pue': 'Power Usage Effectiveness — ratio of total facility power to IT equipment power. PUE of 1.1 means 10% overhead for cooling/infrastructure. PUE of 1.4 means 40% overhead. Lower is better.',
    'capex': 'Capital Expenditure — upfront investment in long-lived assets (GPUs, data centers, networking equipment). Amortized over useful life on the balance sheet.',
    'opex': 'Operating Expenditure — ongoing costs of running the business (power, salaries, rent, cloud GPU rental). Expensed in the period incurred on the income statement.',
    'tco': 'Total Cost of Ownership — the full lifecycle cost including purchase, operation, maintenance, and disposal minus residual value. For GPUs: purchase + power + cooling + maintenance - salvage.',
    'gross-margin': 'Gross Margin — (Revenue - Cost of Goods Sold) / Revenue. For GPU rental: (selling price - fully loaded GPU cost) / selling price. Crusoe ~40%, CoreWeave ~34%.',
    'statistical-multiplexing': 'Pooling demand from many users across shared infrastructure. Like insurance: individual usage is spiky, but aggregate demand is smooth. Enables 80-90% utilization vs 30-40% for dedicated.',
    'residual-value': 'The expected value of an asset at the end of its depreciation period. For GPUs, highly uncertain: could be 40% (bull) or 5% (bear) of purchase price after 3 years.',
    'fixed-rate-swap': 'A financial instrument where one party pays a fixed rate and receives a floating rate. Reserved GPU contracts work similarly: provider receives fixed $/hr, "pays" floating market cost.',
    'utilization-breakeven': 'The utilization rate at which owning a GPU costs the same per hour as renting. Before WACC: ~44%. After WACC (12%): ~59%. With pure equity (25%): ~76%.',
    'interleaved-thinking': 'A reasoning mode where the model can alternate between reasoning, tool calls, and answer generation in one turn. This raises scheduler complexity and decode contention.',
    'preserved-thinking': 'Cross-turn reasoning continuity where prior reasoning is carried to future turns. Improves continuity, but expands carried context unless policy-capped.',
    'reasoning-content': 'A separate reasoning stream returned by some APIs, distinct from user-visible output tokens.',
    'reasoning-effort': 'API control for how much internal reasoning to use before/during answer generation.',
    'reasoning-history': 'Policy control for prior reasoning carry-forward across turns (for example preserved/compact/clear/none behaviors).',
    'thinking-budget': 'A token budget cap for reasoning streams to bound latency and cost.',
    'rdma': 'Remote Direct Memory Access — lets GPUs read/write each other\'s memory directly, bypassing the CPU. Used for cluster-wide KV cache sharing in systems like MemoryAlloy.'
  };

  /* ─── TERM-TO-SECTION NAVIGATION MAP ─── */
  var termStepMap = {
    'dscr': { id: 'contracted-revenue', label: 'F2 Contracted Revenue' },
    'wacc': { id: 'buy-vs-rent', label: 'E2 Buy vs Rent' },
    'sofr': { id: 'equity-vs-debt', label: 'F1 Equity vs Debt' },
    'pue': { id: 'data-centers', label: 'E3 Data Centers' },
    'capex': { id: 'cost-stack', label: 'D1 Cost Stack' },
    'opex': { id: 'cost-stack', label: 'D1 Cost Stack' },
    'tco': { id: 'buy-vs-rent', label: 'E2 Buy vs Rent' },
    'gross-margin': { id: 'throughput', label: 'D2 Throughput' },
    'statistical-multiplexing': { id: 'managed-vs-rental', label: 'E1 Managed vs Rental' },
    'residual-value': { id: 'buy-vs-rent', label: 'E2 Buy vs Rent' },
    'fixed-rate-swap': { id: 'contracted-revenue', label: 'F2 Contracted Revenue' },
    'utilization-breakeven': { id: 'buy-vs-rent', label: 'E2 Buy vs Rent' },
    'interleaved-thinking': { id: 'throughput', label: 'D2 Throughput' },
    'preserved-thinking': { id: 'throughput', label: 'D2 Throughput' },
    'reasoning-content': { id: 'pricing', label: 'D3 Pricing' },
    'reasoning-effort': { id: 'pricing', label: 'D3 Pricing' },
    'reasoning-history': { id: 'pricing', label: 'D3 Pricing' },
    'thinking-budget': { id: 'pricing', label: 'D3 Pricing' },
    'rdma': { id: 'managed-vs-rental', label: 'E1 Managed vs Rental' }
  };

  /* ─── THEME TOGGLE ─── */
  var toggle = document.getElementById('theme-toggle');
  if (toggle) {
    toggle.addEventListener('click', function() {
      var current = document.documentElement.getAttribute('data-theme');
      var next = current === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
  }

  /* ─── PIPELINE STEP TOGGLE ─── */
  document.querySelectorAll('.pipeline-step').forEach(function(step) {
    step.querySelector('.step-card').addEventListener('click', function(e) {
      if (e.target.closest('.term, a, button, .step-detail, .sub-topic')) return;
      step.classList.toggle('active');
    });
  });

  /* ─── SUB-TOPIC TOGGLE ─── */
  window.toggleSubTopic = function(el) {
    el.classList.toggle('expanded');
  };

  /* ─── TERM TOOLTIPS ─── */
  var activeTooltip = null;
  var activeTermEl = null;

  function dismissTooltip() {
    if (activeTooltip) { activeTooltip.remove(); activeTooltip = null; activeTermEl = null; }
  }

  function navigateToSection(mapping) {
    dismissTooltip();
    var el = document.getElementById(mapping.id);
    if (el) {
      var step = el.closest('.pipeline-step');
      if (step && !step.classList.contains('active')) step.classList.add('active');
      window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 64, behavior: 'smooth' });
    }
  }

  function showTermTooltip(term) {
    if (activeTermEl === term) { dismissTooltip(); return; }
    dismissTooltip();
    var key = term.getAttribute('data-term');
    var def = termDefs[key];
    if (!def) return;
    activeTermEl = term;
    var tip = document.createElement('div');
    tip.className = 'term-tooltip';
    var html = '<button class="term-tooltip-close" aria-label="Close">\u00d7</button>';
    html += '<div class="term-tooltip-title">' + key.replace(/-/g, ' ') + '</div><div class="term-tooltip-body">' + def + '</div>';
    var mapping = termStepMap[key];
    if (mapping) {
      html += '<div class="term-tooltip-footer">';
      html += '<a class="term-tooltip-nav" data-nav-id="' + mapping.id + '">\u2192 ' + mapping.label + '</a>';
      html += '</div>';
    }
    tip.innerHTML = html;
    tip.querySelector('.term-tooltip-close').addEventListener('click', function(e) { e.stopPropagation(); dismissTooltip(); });
    var navLink = tip.querySelector('.term-tooltip-nav');
    if (navLink) {
      navLink.addEventListener('click', function(e) {
        e.stopPropagation(); e.preventDefault();
        var m = termStepMap[key];
        if (m) navigateToSection(m);
      });
    }
    document.body.appendChild(tip);
    var rect = term.getBoundingClientRect();
    var tipW = tip.offsetWidth, tipH = tip.offsetHeight;
    var left = rect.left + rect.width / 2 - tipW / 2;
    var top = rect.top - tipH - 10;
    if (top < 60) top = rect.bottom + 10;
    if (left < 10) left = 10;
    if (left + tipW > window.innerWidth - 10) left = window.innerWidth - tipW - 10;
    tip.style.left = left + 'px';
    tip.style.top = top + 'px';
    activeTooltip = tip;
  }

  document.querySelectorAll('.term').forEach(function(term) {
    term.addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      showTermTooltip(term);
    });
  });

  document.addEventListener('click', function(e) {
    if (activeTooltip && !e.target.closest('.term-tooltip') && !e.target.closest('.term')) {
      dismissTooltip();
    }
  });

  /* ─── SCROLL REVEAL ─── */
  var revealObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        revealObserver.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

  document.querySelectorAll('.reveal').forEach(function(el) { revealObserver.observe(el); });

  /* ─── MINIMAP ─── */
  var minimap = document.getElementById('minimap');
  var minimapItems = document.querySelectorAll('.minimap-item[data-target]');
  var stepSections = {};
  var scrollLock = null;

  minimapItems.forEach(function(item) {
    var target = item.getAttribute('data-target');
    var el = document.getElementById(target);
    if (el) stepSections[target] = el;
    item.addEventListener('click', function(e) {
      e.preventDefault();
      if (el) {
        // Toggle section expand/collapse
        var step = el.closest('.pipeline-step');
        if (step) step.classList.toggle('active');
        // Immediately highlight clicked item
        minimapItems.forEach(function(i) { i.classList.remove('active'); });
        item.classList.add('active');
        // Suppress observer during smooth scroll
        clearTimeout(scrollLock);
        scrollLock = setTimeout(function() { scrollLock = null; }, 800);
        var top = el.getBoundingClientRect().top + window.scrollY - 64;
        window.scrollTo({ top: top, behavior: 'smooth' });
      }
    });
  });

  function updateMinimap() {
    if (!minimap) return;
    var scrollY = window.scrollY;
    var vh = window.innerHeight;

    // Show minimap from page load (always visible on desktop)
    minimap.classList.add('visible');

    // Skip highlight update during click-initiated scroll
    if (scrollLock) return;

    // Active item
    var activeTarget = null;
    var keys = Object.keys(stepSections);
    for (var i = keys.length - 1; i >= 0; i--) {
      var rect = stepSections[keys[i]].getBoundingClientRect();
      if (rect.top <= vh * 0.4) { activeTarget = keys[i]; break; }
    }

    minimapItems.forEach(function(item) {
      if (item.getAttribute('data-target') === activeTarget) item.classList.add('active');
      else item.classList.remove('active');
    });
  }

  var minimapTick = false;
  window.addEventListener('scroll', function() {
    if (!minimapTick) { minimapTick = true; requestAnimationFrame(function() { updateMinimap(); minimapTick = false; }); }
  });
  updateMinimap();

  /* ─── INTERACTIVE VISUALS ─── */

  // D1: Cost Waterfall
  function initCostWaterfall() {
    var el = document.getElementById('visual-cost-waterfall');
    if (!el) return;

    var data = [
      { label: 'GPU CapEx (3yr)', crusoe: 0.95, coreweave: 1.10, color: 'var(--compute)' },
      { label: 'Power', crusoe: 0.03, coreweave: 0.07, color: 'var(--io)' },
      { label: 'Data center', crusoe: 0.15, coreweave: 0.25, color: 'var(--memory)' },
      { label: 'Networking', crusoe: 0.10, coreweave: 0.10, color: 'var(--network)' },
      { label: 'Operations', crusoe: 0.10, coreweave: 0.12, color: 'var(--logic)' }
    ];

    var maxVal = 1.64;
    var html = '<div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1rem">Cost per H100-Hour Comparison</div>';

    // Crusoe stacked bar
    html += '<div class="waterfall-row"><div class="waterfall-label">Crusoe</div><div class="waterfall-bar-wrap">';
    var crusoeTotal = 0;
    data.forEach(function(d) {
      var pct = (d.crusoe / maxVal * 100).toFixed(1);
      crusoeTotal += d.crusoe;
      html += '<div class="waterfall-segment" style="width:' + pct + '%;background:' + d.color + '" title="' + d.label + ': $' + d.crusoe.toFixed(2) + '/hr">';
      if (d.crusoe / maxVal > 0.08) html += '<span class="waterfall-val">$' + d.crusoe.toFixed(2) + '</span>';
      html += '</div>';
    });
    html += '</div><div class="waterfall-total">$' + crusoeTotal.toFixed(2) + '/hr</div></div>';

    // CoreWeave stacked bar
    html += '<div class="waterfall-row"><div class="waterfall-label">CoreWeave</div><div class="waterfall-bar-wrap">';
    var cwTotal = 0;
    data.forEach(function(d) {
      var pct = (d.coreweave / maxVal * 100).toFixed(1);
      cwTotal += d.coreweave;
      html += '<div class="waterfall-segment" style="width:' + pct + '%;background:' + d.color + '" title="' + d.label + ': $' + d.coreweave.toFixed(2) + '/hr">';
      if (d.coreweave / maxVal > 0.08) html += '<span class="waterfall-val">$' + d.coreweave.toFixed(2) + '</span>';
      html += '</div>';
    });
    html += '</div><div class="waterfall-total">$' + cwTotal.toFixed(2) + '/hr</div></div>';

    // Legend
    html += '<div style="display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:0.75rem">';
    data.forEach(function(d) {
      html += '<div style="display:flex;align-items:center;gap:0.3rem"><span style="width:10px;height:10px;border-radius:2px;background:' + d.color + '"></span><span style="font-size:0.55rem;color:var(--text-dim)">' + d.label + '</span></div>';
    });
    html += '</div>';

    // Margin comparison
    html += '<div style="display:flex;gap:1.5rem;margin-top:1rem">';
    html += '<div style="font-size:0.7rem;color:var(--text-dim)">Crusoe margin: <strong style="color:var(--economics)">~40%</strong> at $2.20/hr (current on-demand: $3.90/hr H100, $4.29/hr H200)</div>';
    html += '<div style="font-size:0.7rem;color:var(--text-dim)">CoreWeave margin: <strong style="color:var(--accent)">~34%</strong> at $2.20/hr</div>';
    html += '</div>';

    el.innerHTML = html;
  }

  // D3: Deflation Timeline
  function initDeflationTimeline() {
    var el = document.getElementById('visual-deflation-timeline');
    if (!el) return;

    var points = [
      { year: '2022', price: '$20.00', pct: 100 },
      { year: '2023', price: '$6.00', pct: 30 },
      { year: '2024', price: '$1.50', pct: 7.5 },
      { year: '2025', price: '$0.40', pct: 2 }
    ];

    var html = '<div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1.5rem">GPT-3.5 Equivalent — Price per Million Tokens</div>';
    html += '<div style="position:relative;padding:2rem 2rem 2.5rem">';
    html += '<div class="timeline-track"><div class="timeline-fill" id="timeline-fill" style="width:0%"></div></div>';

    points.forEach(function(p, i) {
      var left = (i / (points.length - 1) * 100);
      html += '<div class="timeline-point" style="left:' + left + '%">';
      html += '<div class="timeline-point-value">' + p.price + '</div>';
      html += '<div class="timeline-point-label">' + p.year + '</div>';
      html += '</div>';
    });

    html += '</div>';
    html += '<div style="text-align:center;font-size:0.7rem;color:var(--text-dim);margin-top:0.5rem"><strong style="color:var(--accent)">50x</strong> decline in ~2.5 years</div>';

    el.innerHTML = html;

    // Animate on scroll
    var filled = false;
    var obs = new IntersectionObserver(function(entries) {
      if (entries[0].isIntersecting && !filled) {
        filled = true;
        var fill = document.getElementById('timeline-fill');
        if (fill) setTimeout(function() { fill.style.width = '100%'; }, 200);
        obs.unobserve(el);
      }
    }, { threshold: 0.3 });
    obs.observe(el);
  }

  // E2: Breakeven Calculator
  function initBreakevenCalc() {
    var el = document.getElementById('visual-breakeven-calc');
    if (!el) return;

    var html = '<div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1rem">GPU Ownership Breakeven Calculator</div>';
    html += '<div class="calc-container">';

    html += '<div class="calc-slider-group"><label>Utilization</label><input type="range" id="calc-util" min="10" max="100" value="60" step="1"><span class="calc-val" id="calc-util-val">60%</span></div>';
    html += '<div class="calc-slider-group"><label><span class="term" data-term="wacc">WACC</span></label><input type="range" id="calc-wacc" min="0" max="30" value="12" step="1"><span class="calc-val" id="calc-wacc-val">12%</span></div>';

    html += '<div class="calc-result">';
    html += '<div class="calc-result-item"><div class="calc-result-value" id="calc-own-cost">$1.48</div><div class="calc-result-label">Owned $/hr (effective)</div></div>';
    html += '<div class="calc-result-item"><div class="calc-result-value" id="calc-rent-cost">$2.50</div><div class="calc-result-label">Rental $/hr</div></div>';
    html += '<div class="calc-result-item"><div class="calc-result-value" id="calc-savings">$0.00</div><div class="calc-result-label">Savings / GPU-hr</div></div>';
    html += '<div class="calc-result-item"><div class="calc-result-value" id="calc-breakeven">59%</div><div class="calc-result-label">Breakeven Utilization</div></div>';
    html += '</div>';

    html += '</div>';
    el.innerHTML = html;

    // Bind new term elements inside the visual (use centralized showTermTooltip)
    el.querySelectorAll('.term').forEach(function(term) {
      term.addEventListener('click', function(e) {
        e.stopPropagation();
        e.preventDefault();
        showTermTooltip(term);
      });
    });

    var utilSlider = document.getElementById('calc-util');
    var waccSlider = document.getElementById('calc-wacc');

    function updateCalc() {
      var util = parseInt(utilSlider.value) / 100;
      var wacc = parseInt(waccSlider.value) / 100;

      document.getElementById('calc-util-val').textContent = (util * 100).toFixed(0) + '%';
      document.getElementById('calc-wacc-val').textContent = (wacc * 100).toFixed(0) + '%';

      // Ownership cost model
      var gpuPrice = 28000;
      var depreciationPerHr = gpuPrice / (3 * 365.25 * 24); // 3yr straight-line
      var capitalChargePerHr = (gpuPrice * wacc) / (365.25 * 24);
      var powerPerHr = 0.07;
      var otherPerHr = 0.06; // maintenance, cooling overhead
      var baseCostPerHr = depreciationPerHr + capitalChargePerHr + powerPerHr + otherPerHr;

      // Effective cost at given utilization
      var effectiveCost = baseCostPerHr / util;
      var rentalCost = 2.50;
      var savings = rentalCost - effectiveCost;

      // Breakeven utilization
      var breakeven = baseCostPerHr / rentalCost;

      document.getElementById('calc-own-cost').textContent = '$' + effectiveCost.toFixed(2);
      document.getElementById('calc-rent-cost').textContent = '$' + rentalCost.toFixed(2);
      document.getElementById('calc-savings').textContent = (savings >= 0 ? '$' : '-$') + Math.abs(savings).toFixed(2);
      document.getElementById('calc-savings').style.color = savings >= 0 ? 'var(--economics)' : 'var(--compute)';
      document.getElementById('calc-breakeven').textContent = (breakeven * 100).toFixed(0) + '%';
    }

    utilSlider.addEventListener('input', updateCalc);
    waccSlider.addEventListener('input', updateCalc);
    updateCalc();
  }

  // F3: Capital Structure Bars
  function initCapitalBars() {
    var el = document.getElementById('visual-capital-bars');
    if (!el) return;

    var stages = [
      { label: 'Series A', equity: 97, debt: 3, eqCost: '50-100%', debtCost: 'N/A', detail: 'No revenue, no assets. VCs need 100x potential. Venture debt (if any) at 20-30% of last round with warrants.' },
      { label: 'Series B', equity: 85, debt: 15, eqCost: '30-50%', debtCost: '12-15%', detail: '$5-20M ARR. Equipment financing possible at 80% LTV on GPU purchases.' },
      { label: 'Series C/D', equity: 70, debt: 30, eqCost: '15-25%', debtCost: '8-12%', detail: '$50-200M+ ARR. CoreWeave pioneered billions in GPU-backed debt at this stage.' },
      { label: 'Pre-IPO', equity: 50, debt: 50, eqCost: '12-20%', debtCost: '6-9%', detail: '$200M-1B+ revenue. Convertible notes popular: 2-5% interest with equity conversion option. Crusoe is here.' },
      { label: 'Public', equity: 40, debt: 60, eqCost: '10-15%', debtCost: '4-7%', detail: 'Full optimization. Share buybacks, debt-funded buybacks, credit rating management.' }
    ];

    var html = '<div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1rem">Capital Structure Evolution</div>';
    html += '<div class="capital-bars">';

    stages.forEach(function(s, i) {
      html += '<div class="capital-bar-row" onclick="toggleCapitalDetail(' + i + ')">';
      html += '<div class="capital-bar-label">' + s.label + '</div>';
      html += '<div class="capital-bar-wrap">';
      html += '<div class="capital-equity" style="width:' + s.equity + '%">' + s.equity + '% Eq</div>';
      html += '<div class="capital-debt" style="width:' + s.debt + '%">' + (s.debt > 5 ? s.debt + '% Debt' : '') + '</div>';
      html += '</div>';
      html += '<div class="capital-cost">Eq ' + s.eqCost + '<br>Debt ' + s.debtCost + '</div>';
      html += '</div>';
      html += '<div class="capital-detail" id="capital-detail-' + i + '">' + s.detail + '</div>';
    });

    html += '</div>';

    // Legend
    html += '<div style="display:flex;gap:1rem;margin-top:1rem">';
    html += '<div style="display:flex;align-items:center;gap:0.3rem"><span style="width:10px;height:10px;border-radius:2px;background:var(--accent)"></span><span style="font-size:0.55rem;color:var(--text-dim)">Equity</span></div>';
    html += '<div style="display:flex;align-items:center;gap:0.3rem"><span style="width:10px;height:10px;border-radius:2px;background:var(--economics)"></span><span style="font-size:0.55rem;color:var(--text-dim)">Debt</span></div>';
    html += '</div>';

    el.innerHTML = html;
  }

  window.toggleCapitalDetail = function(idx) {
    var detail = document.getElementById('capital-detail-' + idx);
    if (!detail) return;
    var wasVisible = detail.classList.contains('visible');
    // Close all
    document.querySelectorAll('.capital-detail.visible').forEach(function(d) { d.classList.remove('visible'); });
    if (!wasVisible) detail.classList.add('visible');
  };

  // Init all visuals
  initCostWaterfall();
  initDeflationTimeline();
  initBreakevenCalc();
  initCapitalBars();

})();
</script>


<script>
// ─── SEARCH ───
var CURRENT_PAGE = 'economics.html';
var SEARCH_INDEX = [
  {page:'index.html',pageLabel:'Inference',anchor:'step-routing',title:'Request Routing',desc:'Load balancing, KV cache-aware routing, geo-aware, gateway frameworks'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-preprocessing',title:'Preprocessing',desc:'Prompt templates, RAG retrieval, rate limiting, input validation'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-tokenization',title:'Tokenization',desc:'BPE, SentencePiece, vocabulary sizes, tiktoken'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-embedding',title:'Embedding & Position',desc:'Token embeddings, RoPE, ALiBi, positional encoding'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-scheduling',title:'Scheduling & Batching',desc:'Continuous batching, chunked prefill, thinking model scheduling'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-prefill',title:'Prefill Phase',desc:'Parallel forward pass, TTFT, prefix caching, KV-Runahead'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-kvcache',title:'KV Cache & Memory',desc:'PagedAttention, KV compression, MLA, memory management'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-attention',title:'Attention Mechanisms',desc:'MHA, GQA, MQA, FlashAttention, MLA'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-decode',title:'Decode Phase',desc:'Autoregressive loop, speculative decoding, thinking model decode'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-sampling',title:'Sampling & Selection',desc:'Temperature, top-k, top-p, min-p, repetition penalties'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-streaming',title:'Detokenization & Streaming',desc:'UTF-8 buffering, SSE protocol, streaming pipeline'},
  {page:'index.html',pageLabel:'Inference',anchor:'inference-metrics',title:'Inference Metrics',desc:'TTFT, TPOT, throughput, GPU utilization, SLOs, cost per token'},
  {page:'index.html',pageLabel:'Inference',anchor:'cross-cutting',title:'Quantization & Parallelism',desc:'FP8, AWQ, GPTQ, tensor/pipeline/expert parallelism, LoRA serving'},
  {page:'index.html',pageLabel:'Inference',anchor:'frameworks',title:'Serving Frameworks',desc:'vLLM, SGLang, TensorRT-LLM, NVIDIA Dynamo'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'cost-stack',title:'The Cost Stack',desc:'GPU CapEx, power, data center, networking, operations'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'throughput',title:'Throughput as Margin',desc:'3-5x throughput variance; thinking model throughput impact'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'pricing',title:'Pricing Structures',desc:'Per-token, per-GPU-hour, reserved, batch, thinking token pricing'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'managed-vs-rental',title:'Managed vs GPU Rental',desc:'Statistical multiplexing, outcomes vs infrastructure'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'buy-vs-rent',title:'Buy vs Rent GPUs',desc:'Ownership cost model, breakeven calculator'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'data-centers',title:'Data Centers',desc:'Power costs, PUE, facility economics'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'equity-vs-debt',title:'Equity vs Debt',desc:'Risk, information asymmetry, tax shields'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'contracted-revenue',title:'Contracted Revenue',desc:'How pricing decisions unlock debt capacity'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'stage-by-stage',title:'Stage-by-Stage Capital',desc:'Series A to public capital structure evolution'},
  {page:'training.html',pageLabel:'Training',anchor:'data-pipeline',title:'Data Pipeline',desc:'Collection, filtering, dedup, mixing; DCLM, FineWeb'},
  {page:'training.html',pageLabel:'Training',anchor:'tokenizer',title:'Tokenizer Training',desc:'BPE, SentencePiece, vocabulary sizes, 128K tokens'},
  {page:'training.html',pageLabel:'Training',anchor:'architecture',title:'Model Architecture',desc:'Attention variants, SwiGLU, MoE, RoPE, RMSNorm'},
  {page:'training.html',pageLabel:'Training',anchor:'optimization',title:'Optimization',desc:'AdamW, Muon, WSD schedule, mixed precision, FP8'},
  {page:'training.html',pageLabel:'Training',anchor:'distributed',title:'Distributed Training',desc:'ZeRO, tensor/pipeline/4D parallelism, Megatron-LM'},
  {page:'training.html',pageLabel:'Training',anchor:'monitoring',title:'Monitoring & Recovery',desc:'MFU, loss spikes, checkpointing, failure recovery'},
  {page:'training.html',pageLabel:'Training',anchor:'sft',title:'Supervised Fine-Tuning',desc:'LoRA, supervised text/chat/vision, loss masking, instruction tuning'},
  {page:'training.html',pageLabel:'Training',anchor:'alignment',title:'Alignment',desc:'RLHF, DPO triplets, GRPO, Constitutional AI, KTO, thinking models'},
  {page:'training.html',pageLabel:'Training',anchor:'rft',title:'Reinforcement Fine-Tuning',desc:'Evaluator-driven RFT, environment hooks, parameter tuning, o1/o3/R1'},
  {page:'training.html',pageLabel:'Training',anchor:'evaluation',title:'Evaluation',desc:'MMLU, benchmarks, contamination detection, LiveBench'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'hardware-costs',title:'Hardware & Compute Costs',desc:'GPU pricing, cloud rental decline, cost benchmarks'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'scaling-laws',title:'Scaling Laws & Efficiency',desc:'Chinchilla, over-training, test-time compute scaling'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'failure-costs',title:'Failure & Wasted Compute',desc:'Training failures, wasted GPU-hours, checkpoint overhead'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'build-vs-buy',title:'Build vs Fine-Tune vs API',desc:'When to train, fine-tune, or use API — cost comparison'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'training-providers',title:'Training Providers',desc:'Foundation model companies, training-as-a-service'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'cloud-vs-onprem',title:'Cloud vs On-Premise',desc:'Cloud advantages, on-prem breakeven, hidden costs'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'gpu-financing',title:'GPU Financing',desc:'CoreWeave debt, sale-leaseback, GPU depreciation'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'model-funding',title:'Foundation Model Funding',desc:'Mega-rounds, Big Tech infrastructure spend'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'training-vs-inference',title:'Training vs Inference Spend',desc:'Spend ratio shift 2023–2026, revenue gap'},
];

var searchSelectedIdx = -1;
var searchSelectedEl = null;
var searchFlatResults = [];
var searchDebounceTimer = null;
var searchCrossPageRequested = false;
var SEARCH_PAGE_ORDER = ['Inference', 'Inference Economics', 'Training', 'Training Economics'];

function normalizeSearchText(text) {
  return (text || '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function escapeHtml(text) {
  return (text || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function tokenizeQuery(queryNorm) {
  if (!queryNorm) return [];
  return queryNorm.split(' ').filter(function(token) { return token.length > 1; });
}

function resolveAnchorTarget(root, anchor) {
  if (!root || !anchor) return null;
  var target = root.getElementById(anchor);
  if (target) return target;
  var stepKey = anchor.replace(/^step-/, '');
  target = root.querySelector('.pipeline-step[data-step="' + stepKey + '"]');
  if (target) return target;
  return root.querySelector('[data-step="' + stepKey + '"]');
}

function extractSectionText(root, anchor) {
  var target = resolveAnchorTarget(root, anchor);
  if (!target) return '';
  var text = (target.textContent || '').replace(/\s+/g, ' ').trim();
  if (text.length > 5000) text = text.slice(0, 5000);
  return text;
}

function rebuildSearchBlob(item) {
  var base = [item.title, item.desc, item.pageLabel, item.anchor.replace(/[-_]/g, ' ')].join(' ');
  item._titleNorm = normalizeSearchText(item.title);
  item._descNorm = normalizeSearchText(item.desc);
  item._contentNorm = normalizeSearchText(item._content || '');
  item._blobNorm = normalizeSearchText(base + ' ' + (item._content || ''));
}

function prepareSearchIndex() {
  SEARCH_INDEX.forEach(function(item) {
    if (item.page === CURRENT_PAGE) {
      item._content = extractSectionText(document, item.anchor);
    } else {
      item._content = item._content || '';
    }
    rebuildSearchBlob(item);
  });
}

function fuzzySubsequenceScore(query, text) {
  if (!query || !text) return 0;
  var qi = 0;
  var ti = 0;
  var start = -1;
  var last = -1;
  var gapPenalty = 0;

  while (qi < query.length && ti < text.length) {
    if (query.charAt(qi) === text.charAt(ti)) {
      if (start === -1) start = ti;
      if (last !== -1 && ti > last + 1) gapPenalty += (ti - last - 1);
      last = ti;
      qi++;
    }
    ti++;
  }

  if (qi !== query.length || start === -1 || last === -1) return 0;

  var span = last - start + 1;
  var compactness = query.length / Math.max(span, 1);
  var startBonus = start === 0 ? 0.2 : Math.max(0, 0.12 - start * 0.003);
  var penalty = Math.min(0.45, gapPenalty * 0.01);
  var score = compactness + startBonus - penalty;
  return Math.max(0, Math.min(1, score));
}

function scoreSearchItem(item, queryNorm, tokens) {
  if (!queryNorm) return 1;

  var titleNorm = item._titleNorm || '';
  var descNorm = item._descNorm || '';
  var blobNorm = item._blobNorm || '';

  var score = 0;
  var matched = false;

  if (titleNorm.indexOf(queryNorm) === 0) {
    score += 140;
    matched = true;
  } else if (titleNorm.indexOf(queryNorm) !== -1) {
    score += 110;
    matched = true;
  }

  if (descNorm.indexOf(queryNorm) !== -1) {
    score += 48;
    matched = true;
  }

  if (blobNorm.indexOf(queryNorm) !== -1) {
    score += 78;
    matched = true;
  }

  var tokenHits = 0;
  tokens.forEach(function(token) {
    if (titleNorm.indexOf(token) !== -1) {
      score += 34;
      tokenHits += 1;
      matched = true;
      return;
    }
    if (blobNorm.indexOf(token) !== -1) {
      score += 18;
      tokenHits += 1;
      matched = true;
      return;
    }

    var fuzzyTitle = fuzzySubsequenceScore(token, titleNorm);
    var fuzzyBlob = fuzzySubsequenceScore(token, blobNorm);
    var fuzzyToken = Math.max(fuzzyTitle, fuzzyBlob * 0.9);
    if (fuzzyToken >= 0.74) {
      score += fuzzyToken * 16;
      tokenHits += 0.6;
      matched = true;
    }
  });

  if (tokens.length) score += (tokenHits / tokens.length) * 20;

  var fuzzyWhole = Math.max(
    fuzzySubsequenceScore(queryNorm, titleNorm),
    fuzzySubsequenceScore(queryNorm, blobNorm) * 0.88
  );
  if (fuzzyWhole >= 0.76) {
    score += fuzzyWhole * 34;
    matched = true;
  }

  if (!matched || score < 22) return 0;
  if (item.page === CURRENT_PAGE) score += 6;
  return score;
}

function buildSearchSnippet(item, queryNorm, tokens) {
  var fallback = item.desc || '';
  var content = (item._content || '').replace(/\s+/g, ' ').trim();
  if (!content) return fallback;

  var lower = content.toLowerCase();
  var hit = -1;

  for (var i = 0; i < tokens.length; i++) {
    if (tokens[i].length < 3) continue;
    hit = lower.indexOf(tokens[i]);
    if (hit !== -1) break;
  }

  if (hit === -1 && queryNorm.length >= 3) {
    hit = lower.indexOf(queryNorm);
  }

  if (hit === -1) {
    return content.length > 160 ? content.slice(0, 160).trim() + '…' : content;
  }

  var start = Math.max(0, hit - 64);
  var end = Math.min(content.length, hit + 120);
  var prefix = start > 0 ? '…' : '';
  var suffix = end < content.length ? '…' : '';
  return prefix + content.slice(start, end).trim() + suffix;
}

function getSearchResults(query) {
  var queryNorm = normalizeSearchText(query);
  var tokens = tokenizeQuery(queryNorm);

  if (!queryNorm) {
    return SEARCH_INDEX.map(function(item) {
      return {
        item: item,
        score: item.page === CURRENT_PAGE ? 1 : 0,
        snippet: item.desc
      };
    }).sort(function(a, b) {
      if (b.score !== a.score) return b.score - a.score;
      var pageDelta = SEARCH_PAGE_ORDER.indexOf(a.item.pageLabel) - SEARCH_PAGE_ORDER.indexOf(b.item.pageLabel);
      if (pageDelta !== 0) return pageDelta;
      return a.item.title.localeCompare(b.item.title);
    });
  }

  var matches = [];
  SEARCH_INDEX.forEach(function(item) {
    var score = scoreSearchItem(item, queryNorm, tokens);
    if (score <= 0) return;
    matches.push({
      item: item,
      score: score,
      snippet: buildSearchSnippet(item, queryNorm, tokens)
    });
  });

  matches.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    var pageDelta = SEARCH_PAGE_ORDER.indexOf(a.item.pageLabel) - SEARCH_PAGE_ORDER.indexOf(b.item.pageLabel);
    if (pageDelta !== 0) return pageDelta;
    return a.item.title.localeCompare(b.item.title);
  });

  return matches.slice(0, 120);
}

function openSearch() {
  var overlay = document.getElementById('search-overlay');
  var input = document.getElementById('search-input');
  if (!overlay || !input) return;
  overlay.classList.add('open');
  input.value = '';
  input.focus();
  searchSelectedIdx = -1;
  searchSelectedEl = null;
  renderSearchResults('');
  warmCrossPageContent();
}

function closeSearch() {
  var overlay = document.getElementById('search-overlay');
  if (overlay) overlay.classList.remove('open');
}

function setSearchSelected(idx) {
  if (idx < 0 || idx >= searchFlatResults.length) return;
  if (searchSelectedIdx === idx) return;

  if (searchSelectedEl) searchSelectedEl.classList.remove('selected');

  searchSelectedIdx = idx;
  var container = document.getElementById('search-results');
  searchSelectedEl = container ? container.querySelector('.search-result[data-idx="' + idx + '"]') : null;
  if (searchSelectedEl) searchSelectedEl.classList.add('selected');
}

function renderSearchResults(query) {
  var container = document.getElementById('search-results');
  if (!container) return;

  var results = getSearchResults(query || '');
  searchFlatResults = results;
  searchSelectedIdx = -1;
  searchSelectedEl = null;

  if (!results.length) {
    container.innerHTML = '<div class="search-no-results">No results for &ldquo;' + escapeHtml(query || '') + '&rdquo;</div>';
    return;
  }

  var grouped = {};
  results.forEach(function(entry, idx) {
    var label = entry.item.pageLabel;
    if (!grouped[label]) grouped[label] = [];
    grouped[label].push({ entry: entry, idx: idx });
  });

  var labels = SEARCH_PAGE_ORDER.slice();
  Object.keys(grouped).forEach(function(label) {
    if (labels.indexOf(label) === -1) labels.push(label);
  });

  var html = '';
  labels.forEach(function(label) {
    if (!grouped[label] || !grouped[label].length) return;
    html += '<div class="search-group-header">' + escapeHtml(label) + '</div>';

    grouped[label].forEach(function(row) {
      var item = row.entry.item;
      var snippet = row.entry.snippet || item.desc || '';
      html += '<div class="search-result" data-idx="' + row.idx + '" data-page="' + item.page + '" data-anchor="' + item.anchor + '">' +
        '<div class="search-result-dot"></div>' +
        '<div class="search-result-body"><div class="search-result-title">' + escapeHtml(item.title) + '</div>' +
        '<div class="search-result-desc">' + escapeHtml(snippet) + '</div></div>' +
        '<span class="search-result-badge">' + (item.page === CURRENT_PAGE ? 'this page' : item.pageLabel.toLowerCase()) + '</span>' +
      '</div>';
    });
  });

  container.innerHTML = html;
}

function scheduleSearchRender(query) {
  if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
  searchDebounceTimer = setTimeout(function() {
    renderSearchResults(query);
  }, 70);
}

function navigateToResult(el) {
  var page = el.getAttribute('data-page');
  var anchor = el.getAttribute('data-anchor');
  if (!page || !anchor) return;

  closeSearch();

  if (page === CURRENT_PAGE) {
    var target = resolveAnchorTarget(document, anchor);
    if (target) {
      if (target.classList.contains('pipeline-step') && !target.classList.contains('active')) {
        target.classList.add('active');
      }
      window.scrollTo({ top: target.getBoundingClientRect().top + window.scrollY - 64, behavior: 'smooth' });
    }
  } else {
    window.location.href = page + '#' + anchor;
  }
}

function warmCrossPageContent() {
  if (searchCrossPageRequested || typeof fetch !== 'function' || typeof DOMParser === 'undefined') return;
  searchCrossPageRequested = true;

  var pages = [];
  var seen = {};
  SEARCH_INDEX.forEach(function(item) {
    if (item.page === CURRENT_PAGE || seen[item.page]) return;
    seen[item.page] = true;
    pages.push(item.page);
  });

  if (!pages.length) {
    return;
  }

  Promise.allSettled(pages.map(function(page) {
    return fetch(page, { cache: 'force-cache', credentials: 'same-origin' })
      .then(function(response) {
        if (!response.ok) return '';
        return response.text();
      })
      .then(function(html) {
        if (!html) return;
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        SEARCH_INDEX.forEach(function(item) {
          if (item.page !== page) return;
          var extracted = extractSectionText(doc, item.anchor);
          if (extracted) {
            item._content = extracted;
            rebuildSearchBlob(item);
          }
        });
      })
      .catch(function() {});
  })).then(function() {
    var overlay = document.getElementById('search-overlay');
    var input = document.getElementById('search-input');
    if (overlay && overlay.classList.contains('open') && input && input.value.trim()) {
      renderSearchResults(input.value);
    }
  });
}

prepareSearchIndex();

document.addEventListener('keydown', function(e) {
  if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
    e.preventDefault();
    var overlay = document.getElementById('search-overlay');
    if (!overlay) return;
    if (overlay.classList.contains('open')) { closeSearch(); } else { openSearch(); }
    return;
  }

  var overlay = document.getElementById('search-overlay');
  if (!overlay || !overlay.classList.contains('open')) return;

  if (e.key === 'Escape') {
    closeSearch();
    return;
  }

  if (!searchFlatResults.length) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    var next = searchSelectedIdx < 0 ? 0 : Math.min(searchSelectedIdx + 1, searchFlatResults.length - 1);
    setSearchSelected(next);
    if (searchSelectedEl) searchSelectedEl.scrollIntoView({ block: 'nearest' });
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    var prev = searchSelectedIdx <= 0 ? 0 : searchSelectedIdx - 1;
    setSearchSelected(prev);
    if (searchSelectedEl) searchSelectedEl.scrollIntoView({ block: 'nearest' });
  } else if (e.key === 'Enter') {
    e.preventDefault();
    var idx = searchSelectedIdx >= 0 ? searchSelectedIdx : 0;
    var container = document.getElementById('search-results');
    var target = container ? container.querySelector('.search-result[data-idx="' + idx + '"]') : null;
    if (target) navigateToResult(target);
  }
});

var searchInputEl = document.getElementById('search-input');
if (searchInputEl) {
  searchInputEl.addEventListener('input', function(e) {
    scheduleSearchRender(e.target.value);
  });
}

var searchResultsEl = document.getElementById('search-results');
if (searchResultsEl) {
  searchResultsEl.addEventListener('click', function(e) {
    var resultEl = e.target.closest('.search-result');
    if (!resultEl || !searchResultsEl.contains(resultEl)) return;
    navigateToResult(resultEl);
  });

  searchResultsEl.addEventListener('mouseover', function(e) {
    var resultEl = e.target.closest('.search-result');
    if (!resultEl || !searchResultsEl.contains(resultEl)) return;
    var idx = parseInt(resultEl.getAttribute('data-idx'), 10);
    if (isNaN(idx)) return;
    setSearchSelected(idx);
  });
}

var searchOverlayEl = document.getElementById('search-overlay');
if (searchOverlayEl) {
  searchOverlayEl.addEventListener('click', function(e) {
    if (e.target === searchOverlayEl) closeSearch();
  });
}

var searchTriggerEl = document.getElementById('search-trigger');
if (searchTriggerEl) {
  searchTriggerEl.addEventListener('click', function() { openSearch(); });
}

// Update shortcut label for non-Mac
(function() {
  var isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform || navigator.userAgent);
  if (!isMac) {
    var hint = document.getElementById('search-key-hint');
    if (hint) hint.textContent = 'Ctrl+K';
  }
})();

// Handle hash anchor from cross-page search navigation
(function() {
  if (!window.location.hash) return;
  var anchor = window.location.hash.slice(1);
  setTimeout(function() {
    var target = resolveAnchorTarget(document, anchor);
    if (!target) return;
    if (target.classList.contains('pipeline-step') && !target.classList.contains('active')) target.classList.add('active');
    window.scrollTo({ top: target.getBoundingClientRect().top + window.scrollY - 64, behavior: 'smooth' });
  }, 180);
})();

</script>

<script>
// ─── KNOWLEDGE MARKDOWN DOWNLOAD ───
(function() {
  var downloadBtn = document.getElementById('download-knowledge');
  if (!downloadBtn) return;

  var KNOWLEDGE_PAGES = [
    { path: 'index.html', label: 'Inference Technical Pipeline' },
    { path: 'economics.html', label: 'Inference Economics' },
    { path: 'training.html', label: 'Training Technical Pipeline' },
    { path: 'training-economics.html', label: 'Training Economics' }
  ];

  function normalizeWhitespace(text) {
    return (text || '').replace(/\s+/g, ' ').trim();
  }

  function resolveHref(href, baseUrl) {
    if (!href) return '';
    if (href.charAt(0) === '#') return baseUrl + href;
    try {
      return new URL(href, baseUrl).href;
    } catch (err) {
      return href;
    }
  }

  function inlineFromNode(node, baseUrl) {
    if (!node) return '';
    if (node.nodeType === Node.TEXT_NODE) return node.nodeValue || '';
    if (node.nodeType !== Node.ELEMENT_NODE) return '';

    var tag = node.tagName.toLowerCase();
    if (tag === 'br') return '  \n';

    var childText = '';
    node.childNodes.forEach(function(child) {
      childText += inlineFromNode(child, baseUrl);
    });

    childText = normalizeWhitespace(childText);

    if (!childText && tag !== 'a') return '';
    if (tag === 'strong' || tag === 'b') return '**' + childText + '**';
    if (tag === 'em' || tag === 'i') return '*' + childText + '*';
    if (tag === 'code') return '`' + childText.replace(/`/g, '\\`') + '`';
    if (tag === 'a') {
      var href = resolveHref(node.getAttribute('href') || '', baseUrl);
      var label = childText || href;
      return href ? '[' + label + '](' + href + ')' : label;
    }

    return childText;
  }

  function inlineText(element, baseUrl) {
    if (!element) return '';
    var text = '';
    element.childNodes.forEach(function(child) {
      text += inlineFromNode(child, baseUrl) + ' ';
    });
    return normalizeWhitespace(text);
  }

  function markdownFromList(listEl, baseUrl, depth) {
    var level = depth || 0;
    var isOrdered = listEl.tagName.toLowerCase() === 'ol';
    var lines = [];

    Array.from(listEl.children).forEach(function(li, idx) {
      if (!li || li.tagName.toLowerCase() !== 'li') return;

      var itemTextParts = [];
      li.childNodes.forEach(function(node) {
        if (node.nodeType === Node.ELEMENT_NODE) {
          var tag = node.tagName.toLowerCase();
          if (tag === 'ul' || tag === 'ol') return;
        }
        itemTextParts.push(inlineFromNode(node, baseUrl));
      });

      var itemText = normalizeWhitespace(itemTextParts.join(' '));
      if (!itemText) itemText = '(item)';
      var prefix = isOrdered ? ((idx + 1) + '.') : '-';
      lines.push(Array(level + 1).join('  ') + prefix + ' ' + itemText);

      Array.from(li.children).forEach(function(child) {
        var childTag = child.tagName.toLowerCase();
        if (childTag === 'ul' || childTag === 'ol') {
          var nested = markdownFromList(child, baseUrl, level + 1);
          if (nested) lines.push(nested);
        }
      });
    });

    return lines.join('\n');
  }

  function escapeTableCell(text) {
    return (text || '').replace(/\|/g, '\\|');
  }

  function markdownFromTable(tableEl, baseUrl) {
    var rows = Array.from(tableEl.querySelectorAll('tr')).map(function(tr) {
      return Array.from(tr.children)
        .filter(function(cell) {
          var tag = cell.tagName.toLowerCase();
          return tag === 'th' || tag === 'td';
        })
        .map(function(cell) {
          return escapeTableCell(inlineText(cell, baseUrl));
        });
    }).filter(function(row) {
      return row.length > 0;
    });

    if (!rows.length) return '';

    var colCount = rows.reduce(function(max, row) {
      return Math.max(max, row.length);
    }, 0);

    rows = rows.map(function(row) {
      var copy = row.slice(0);
      while (copy.length < colCount) copy.push('');
      return copy;
    });

    var header = rows[0];
    var body = rows.slice(1);
    var sep = [];
    for (var i = 0; i < colCount; i++) sep.push('---');

    var md = [];
    md.push('| ' + header.join(' | ') + ' |');
    md.push('| ' + sep.join(' | ') + ' |');
    body.forEach(function(row) {
      md.push('| ' + row.join(' | ') + ' |');
    });

    return md.join('\n');
  }

  function shouldSkipBlock(el) {
    if (!el) return true;
    if (el.closest('nav, .minimap, .search-overlay, .footer, .journey-detail-panel, .term-tooltip')) return true;
    return false;
  }

  function sectionToMarkdown(section, baseUrl, headingToSkip) {
    var blocks = section.querySelectorAll('h1,h2,h3,h4,h5,p,ul,ol,pre,table');
    var out = [];
    var previous = '';

    blocks.forEach(function(el) {
      if (el === headingToSkip) return;
      if (shouldSkipBlock(el)) return;

      var tag = el.tagName.toLowerCase();
      var chunk = '';

      if ((tag === 'p' && el.closest('li')) || (tag === 'p' && el.closest('table'))) return;
      if ((tag === 'ul' || tag === 'ol') && el.closest('li')) return;
      if ((tag === 'pre' || tag === 'code') && el.closest('table')) return;

      if (tag === 'h1' || tag === 'h2' || tag === 'h3' || tag === 'h4' || tag === 'h5') {
        var headingText = inlineText(el, baseUrl);
        if (!headingText) return;
        var level = parseInt(tag.charAt(1), 10) + 2;
        if (level > 6) level = 6;
        chunk = Array(level + 1).join('#') + ' ' + headingText;
      } else if (tag === 'p') {
        chunk = inlineText(el, baseUrl);
      } else if (tag === 'ul' || tag === 'ol') {
        chunk = markdownFromList(el, baseUrl, 0);
      } else if (tag === 'pre') {
        var codeText = (el.textContent || '').trim();
        if (codeText) chunk = '```\n' + codeText + '\n```';
      } else if (tag === 'table') {
        chunk = markdownFromTable(el, baseUrl);
      }

      chunk = (chunk || '').replace(/\n\s+\n/g, '\n\n').replace(/\n{3,}/g, '\n\n').trim();
      if (!chunk || chunk === previous) return;
      out.push(chunk);
      previous = chunk;
    });

    return out.join('\n\n').trim();
  }

  function parsePageToMarkdown(html, pageMeta, pageUrl) {
    var parser = new DOMParser();
    var doc = parser.parseFromString(html, 'text/html');
    var lines = [];

    lines.push('## ' + pageMeta.label);
    lines.push('Source: [' + pageMeta.path + '](' + pageUrl + ')');

    var heroTitleEl = doc.querySelector('.hero h1');
    var heroTitle = heroTitleEl ? inlineText(heroTitleEl, pageUrl) : normalizeWhitespace(doc.title || pageMeta.label);
    if (heroTitle) lines.push('### ' + heroTitle);

    var heroSubEl = doc.querySelector('.hero-sub') || doc.querySelector('.hero p');
    var heroSub = heroSubEl ? inlineText(heroSubEl, pageUrl) : '';
    if (heroSub) lines.push(heroSub);

    var sections = Array.from(doc.querySelectorAll('section'));
    sections.forEach(function(section) {
      if (section.classList.contains('hero')) return;
      if (shouldSkipBlock(section)) return;

      var sectionHeadingEl = section.querySelector('h2,h3');
      var sectionHeading = sectionHeadingEl ? inlineText(sectionHeadingEl, pageUrl) : '';
      if (!sectionHeading && section.id) sectionHeading = section.id.replace(/[-_]/g, ' ');
      if (sectionHeading) lines.push('### ' + sectionHeading);

      var sectionBody = sectionToMarkdown(section, pageUrl, sectionHeadingEl);
      if (sectionBody) lines.push(sectionBody);
    });

    return lines.join('\n\n').replace(/\n{3,}/g, '\n\n').trim();
  }

  async function buildKnowledgeMarkdown() {
    var generatedAt = new Date();
    var parts = [];

    parts.push('# LLM Anatomy Knowledge Base');
    parts.push('');
    parts.push('Generated: ' + generatedAt.toISOString());
    parts.push('Origin: ' + window.location.origin);
    parts.push('');
    parts.push('This markdown file is generated from the live website at download time.');
    parts.push('');

    for (var i = 0; i < KNOWLEDGE_PAGES.length; i++) {
      var page = KNOWLEDGE_PAGES[i];
      var pageUrl = new URL(page.path, window.location.href).href;

      try {
        var response = await fetch(pageUrl, { cache: 'no-store', credentials: 'same-origin' });
        if (!response.ok) throw new Error('HTTP ' + response.status);

        var html = await response.text();
        var pageMd = parsePageToMarkdown(html, page, pageUrl);
        parts.push(pageMd || ('## ' + page.label + '\n\nSource: [' + page.path + '](' + pageUrl + ')\n\n_No extractable content found._'));
      } catch (err) {
        parts.push('## ' + page.label);
        parts.push('Source: [' + page.path + '](' + pageUrl + ')');
        parts.push('');
        parts.push('_Failed to fetch this page while generating knowledge markdown: ' + (err && err.message ? err.message : 'Unknown error') + '._');
      }

      if (i < KNOWLEDGE_PAGES.length - 1) {
        parts.push('');
        parts.push('---');
        parts.push('');
      }
    }

    return parts.join('\n').replace(/\n{3,}/g, '\n\n').trim() + '\n';
  }

  function downloadMarkdown(content) {
    var stamp = new Date().toISOString().replace(/:/g, '-').replace(/\.\d+Z$/, 'Z');
    var fileName = 'llm-anatomy-knowledge-' + stamp + '.md';

    var blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  downloadBtn.addEventListener('click', async function() {
    if (downloadBtn.disabled) return;

    var labelEl = downloadBtn.querySelector('.search-trigger-label');
    var originalLabel = labelEl ? labelEl.textContent : '';

    downloadBtn.disabled = true;
    if (labelEl) labelEl.textContent = 'Preparing...';

    try {
      var markdown = await buildKnowledgeMarkdown();
      downloadMarkdown(markdown);
    } catch (err) {
      console.error('Knowledge markdown generation failed:', err);
      window.alert('Failed to generate knowledge markdown. Please try again.');
    } finally {
      downloadBtn.disabled = false;
      if (labelEl) labelEl.textContent = originalLabel;
    }
  });
})();
</script>

<!-- ─── SEARCH MODAL ─── -->
<div class="search-overlay" id="search-overlay" role="dialog" aria-modal="true" aria-label="Site search">
  <div class="search-modal">
    <div class="search-input-wrap">
      <svg class="search-icon-svg" viewBox="0 0 16 16" stroke="currentColor" stroke-width="1.5"><circle cx="6.5" cy="6.5" r="4.5"/><path stroke-linecap="round" d="m10 10 3.5 3.5"/></svg>
      <input type="text" class="search-input" id="search-input" placeholder="Search sections, topics, terms..." autocomplete="off" spellcheck="false">
      <kbd class="search-esc-hint">ESC</kbd>
    </div>
    <div class="search-results" id="search-results"></div>
    <div class="search-footer">
      <span class="search-footer-hint"><span class="search-footer-key">&#x2191;&#x2193;</span>&nbsp;navigate</span>
      <span class="search-footer-hint"><span class="search-footer-key">&#x23CE;</span>&nbsp;select</span>
      <span class="search-footer-hint"><span class="search-footer-key">ESC</span>&nbsp;close</span>
    </div>
  </div>
</div>

</body>
</html>
