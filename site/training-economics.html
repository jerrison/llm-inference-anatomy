<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Economics of LLM Training</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
/* ─── RESET & BASE ─── */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg: #0a0a0c; --bg-card: #111115; --bg-card-hover: #18181e;
  --border: #1e1e28; --border-active: #3a3a50;
  --text: #e8e6e3; --text-dim: #9a98a0; --text-muted: #4a4850;
  --accent: #56B4E9; --accent-dim: #3a8dc4; --accent-glow: rgba(86,180,233,0.08);
  --compute: #D55E00; --memory: #0090D6; --io: #E69F00; --logic: #CC79A7; --network: #56B4E9;
  --economics: #009E73;
  --font-display: 'Instrument Serif', serif;
  --font-body: 'Atkinson Hyperlegible', sans-serif;
  --font-mono: 'DM Mono', monospace;
}

html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--text); font-family: var(--font-body); font-weight: 400; line-height: 1.8; overflow-x: hidden; -webkit-font-smoothing: antialiased; padding-top: 48px; }
::selection { background: var(--accent); color: var(--bg); }

/* ─── SITE NAV ─── */
.site-nav { position: fixed; top: 0; left: 0; right: 0; z-index: 600; height: 48px; background: rgba(10,10,12,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; }
.nav-logo { font-family: var(--font-display); font-size: 1rem; color: var(--text); text-decoration: none; white-space: nowrap; }
.nav-links { display: flex; align-items: center; gap: 1.5rem; }
.nav-link { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); text-decoration: none; padding: 0.25rem 0; transition: color 0.2s ease; }
.nav-link:hover { color: var(--text-dim); }
.nav-link.active { color: var(--accent); border-bottom: 1.5px solid var(--accent); }
.nav-divider { width: 1px; height: 18px; background: var(--border); flex-shrink: 0; }

/* ─── THEME TOGGLE ─── */
.theme-toggle { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-dim); font-size: 1rem; transition: border-color 0.2s ease, color 0.2s ease; }
.theme-toggle:hover { border-color: var(--border-active); color: var(--text); }
.theme-toggle::after { content: '\263C'; }
[data-theme="light"] .theme-toggle::after { content: '\263E'; }

/* ─── HERO ─── */
.hero { min-height: 50vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 1.5rem 2rem; position: relative; overflow: hidden; }
.hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0,158,115,0.04) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 20% 80%, rgba(230,159,0,0.03) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(204,121,167,0.03) 0%, transparent 50%); pointer-events: none; }
.hero-label { font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--economics); margin-bottom: 1rem; opacity: 0; animation: fadeUp 0.8s ease forwards 0.2s; }
.hero h1 { font-family: var(--font-display); font-size: clamp(3rem, 8vw, 7rem); font-weight: 400; line-height: 1.05; letter-spacing: -0.02em; max-width: 900px; opacity: 0; animation: fadeUp 0.8s ease forwards 0.4s; }
.hero h1 em { font-style: italic; color: var(--accent); }
.hero-sub { font-size: clamp(1rem, 2vw, 1.2rem); color: var(--text-dim); max-width: 600px; margin-top: 1rem; opacity: 0; animation: fadeUp 0.8s ease forwards 0.6s; }
.hero-cta { margin-top: 1.5rem; display: flex; align-items: center; gap: 0.5rem; font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted); opacity: 0; animation: fadeUp 0.8s ease forwards 0.8s; }
.hero-cta .arrow { display: inline-block; animation: bounce 2s ease infinite; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(6px); } }

/* ─── PHASE OVERVIEW ─── */
.phase-overview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; max-width: 1200px; margin: 0 auto; padding: 0 2rem 4rem; }
.phase-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: border-color 0.18s ease, background-color 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease; position: relative; }
.phase-card:hover { border-color: var(--border-active); background: var(--bg-card-hover); }
.phase-letter { font-family: var(--font-display); font-size: 2.5rem; color: var(--accent); line-height: 1; margin-bottom: 0.5rem; }
.phase-name { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 0.25rem; }
.phase-subtitle { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem; }
.phase-steps { display: flex; flex-direction: column; gap: 0.25rem; }
.phase-steps span { font-family: var(--font-mono); font-size: 0.72rem; color: var(--text-muted); letter-spacing: 0.05em; }
.phase-card:not(:last-child)::after { content: '\2192'; position: absolute; right: -1rem; top: 50%; transform: translate(50%, -50%); color: var(--text-muted); font-size: 1.2rem; z-index: 3; }

/* ─── PIPELINE ─── */
.pipeline-section { padding: 4rem 2rem 6rem; max-width: 1200px; margin: 0 auto; }
.section-label { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem; }
.section-title { font-family: var(--font-display); font-size: clamp(2rem, 4vw, 3.5rem); font-weight: 400; margin-bottom: 1rem; }
.section-desc { color: var(--text-dim); max-width: 650px; margin-bottom: 3rem; font-size: 1rem; }
.phase-divider { display: grid; grid-template-columns: 48px 1fr; padding: 2rem 0 0.5rem; position: relative; }
.phase-divider:first-child { padding-top: 0; }
.phase-divider-marker { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 8px; background: var(--accent); color: var(--bg); font-family: var(--font-mono); font-weight: 700; font-size: 0.75rem; margin-left: 8px; z-index: 2; }
.phase-divider-content { padding: 0.25rem 0 0 0.75rem; }
.phase-divider-name { font-family: var(--font-display); font-size: 1.15rem; color: var(--accent); }
.phase-divider-desc { font-size: 0.8rem; color: var(--text-muted); }
.pipeline-flow { display: flex; flex-direction: column; gap: 0; position: relative; }
.pipeline-flow::before { content: ''; position: absolute; left: 24px; top: 0; bottom: 0; width: 1px; background: linear-gradient(to bottom, transparent, var(--border) 5%, var(--border) 95%, transparent); }
.pipeline-step { display: grid; grid-template-columns: 48px 1fr; gap: 0; cursor: pointer; position: relative; }
.step-marker { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; }
.step-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--border); background: var(--bg); margin-top: 1.5rem; transition: border-color 0.18s ease, background-color 0.18s ease, box-shadow 0.18s ease; flex-shrink: 0; }
.pipeline-step:hover .step-dot, .pipeline-step.active .step-dot { border-color: var(--accent); background: var(--accent); box-shadow: 0 0 12px rgba(86,180,233,0.3); }
.step-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem; margin: 0.5rem 0; transition: border-color 0.18s ease, background-color 0.18s ease; position: relative; overflow: hidden; cursor: pointer; }
.step-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, var(--accent-glow) 0%, transparent 50%); opacity: 0; transition: opacity 0.18s ease; }
.pipeline-step:hover .step-card, .pipeline-step.active .step-card { border-color: var(--border-active); background: var(--bg-card-hover); }
.pipeline-step:hover .step-card::before, .pipeline-step.active .step-card::before { opacity: 1; }
.step-header { display: flex; align-items: center; gap: 0.75rem; position: relative; z-index: 1; cursor: pointer; }
.step-number { font-family: var(--font-mono); font-size: 0.6rem; color: var(--accent-dim); letter-spacing: 0.1em; min-width: 24px; }
.step-name { font-family: var(--font-display); font-size: 1.4rem; flex: 1; }
.step-badge { font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 0.1em; text-transform: uppercase; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid; }
.step-badge::before { margin-right: 0.3em; }
.badge-economics { color: var(--economics); border-color: rgba(0,158,115,0.3); background: rgba(0,158,115,0.05); }
.badge-economics::before { content: '$'; }
.step-summary { color: var(--text-dim); font-size: 0.9rem; margin-top: 0.5rem; position: relative; z-index: 1; }
.step-expand-icon { color: var(--text-muted); font-size: 1.2rem; transition: transform 0.18s ease; font-family: var(--font-mono); }
.pipeline-step.active .step-expand-icon { transform: rotate(45deg); color: var(--accent); }

/* ─── EXPANDED DETAIL ─── */
.step-detail { max-height: 0; overflow: hidden; transition: max-height 0.18s ease-out; position: relative; z-index: 1; cursor: default; }
.pipeline-step.active .step-detail { max-height: 8000px; }
.detail-inner { padding: 1.5rem 0 0.5rem; border-top: 1px solid var(--border); margin-top: 1rem; }
.detail-section { margin-bottom: 1.5rem; }
.detail-section:last-child { margin-bottom: 0; }
.detail-label { font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--accent-dim); margin-bottom: 0.5rem; }
.detail-text { font-size: 0.92rem; color: var(--text-dim); line-height: 1.8; }
.detail-text strong { color: var(--text); font-weight: 400; }
.detail-text code { font-family: var(--font-mono); font-size: 0.78rem; background: rgba(86,180,233,0.06); color: var(--accent); padding: 0.15rem 0.4rem; border-radius: 4px; }
.callout-box { border-radius: 8px; padding: 0.85rem 1rem; margin-bottom: 1.25rem; font-size: 0.9rem; line-height: 1.7; }
.callout-takeaway { background: rgba(86,180,233,0.06); border-left: 3px solid var(--accent); }
.callout-takeaway .callout-label { font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--accent); margin-bottom: 0.3rem; }
.callout-takeaway p { color: var(--text); font-weight: 700; }
.callout-analogy { background: rgba(204,121,167,0.05); border-left: 3px solid var(--logic); }
.callout-analogy .callout-label { font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--logic); margin-bottom: 0.3rem; }
.callout-analogy p { color: var(--text-dim); font-style: italic; }

/* ─── SUB-TOPICS ─── */
.sub-topics { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
.sub-topic { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; transition: border-color 0.18s ease, background-color 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease; }
.sub-topic:hover { border-color: var(--border-active); background: rgba(255,255,255,0.04); }
.sub-topic.expanded { grid-column: 1 / -1; border-color: var(--accent-dim); }
.sub-topic-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
.sub-topic-name { font-family: var(--font-display); font-size: 1.1rem; }
.sub-topic-icon { color: var(--text-muted); font-family: var(--font-mono); font-size: 0.9rem; transition: transform 0.3s ease; }
.sub-topic.expanded .sub-topic-icon { transform: rotate(45deg); color: var(--accent); }
.sub-topic-preview { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.35rem; }
.sub-topic-detail { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
.sub-topic.expanded .sub-topic-detail { display: block; }
.sub-topic-detail p { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 0.75rem; line-height: 1.8; }
.sub-topic-detail p:last-child { margin-bottom: 0; }

/* ─── TABLES, METRICS, TERMS ─── */
.data-table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; font-size: 0.8rem; }
.data-table th { font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
.data-table td { padding: 0.5rem 0.75rem; color: var(--text-dim); border-bottom: 1px solid rgba(30,30,40,0.5); }
.data-table td:first-child { color: var(--text); }
.data-table tr:last-child td { border-bottom: none; }
.metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin: 0.75rem 0; }
.metric { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem 1rem; text-align: center; }
.metric-value { font-family: var(--font-display); font-size: 1.6rem; color: var(--accent); }
.metric-label { font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 0.25rem; }
.term { color: var(--accent); text-decoration: underline; text-decoration-style: dotted; text-decoration-color: rgba(86,180,233,0.4); text-underline-offset: 3px; cursor: help; }
.term-tooltip { position: fixed; max-width: 340px; background: #1a1a22; border: 1px solid var(--border-active); border-radius: 10px; padding: 0.85rem 1rem; z-index: 1000; box-shadow: 0 8px 32px rgba(0,0,0,0.5); animation: tooltipIn 0.2s ease; }
.term-tooltip-title { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent); margin-bottom: 0.35rem; }
.term-tooltip-body { font-size: 0.85rem; color: var(--text-dim); line-height: 1.6; }
.term-tooltip-close { position: absolute; top: 0.5rem; right: 0.5rem; width: 1.25rem; height: 1.25rem; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); font-size: 0.65rem; cursor: pointer; padding: 0; line-height: 1; transition: color 0.15s, border-color 0.15s; }
.term-tooltip-close:hover { color: var(--text-dim); border-color: var(--border-active); }
@keyframes tooltipIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* ─── CROSS-LINK ─── */
.cross-link { display: inline-block; margin-top: 0.5rem; color: var(--accent-dim); font-family: var(--font-mono); font-size: 0.75rem; text-decoration: none; letter-spacing: 0.05em; transition: color 0.2s; }
.cross-link:hover { color: var(--accent); }

/* ─── MINIMAP ─── */
.minimap { position: fixed; right: max(1.5rem, calc((100vw - 1200px) / 2 - 10rem)); top: 50%; transform: translateY(-50%); z-index: 400; opacity: 0; pointer-events: none; transition: opacity 0.35s ease; display: flex; flex-direction: column; gap: 0; }
.minimap.visible { opacity: 1; pointer-events: auto; }
.minimap-phase { padding: 0.4rem 0; position: relative; }
.minimap-phase + .minimap-phase { border-top: 1px solid var(--border); margin-top: 0.15rem; padding-top: 0.55rem; }
.minimap-phase-label { font-family: var(--font-mono); font-size: 0.5rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--accent-dim); margin-bottom: 0.35rem; padding-left: 2px; }
.minimap-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.2rem 0; text-decoration: none; cursor: pointer; outline: none; }
.minimap-dot { width: 8px; height: 8px; border-radius: 50%; border: 1.5px solid var(--border-active); background: var(--bg); flex-shrink: 0; box-shadow: 0 0 0 3px var(--bg); transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease; }
.minimap-label { font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 0.06em; color: var(--text-muted); white-space: nowrap; transition: color 0.2s ease; }
.minimap-item:hover .minimap-dot { border-color: var(--border-active); }
.minimap-item:hover .minimap-label { color: var(--text-dim); }
.minimap-item.active .minimap-dot { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 6px var(--accent-glow), 0 0 12px var(--accent-glow); }
.minimap-item.active .minimap-label { color: var(--text); }

/* ─── FOOTER ─── */
.footer { padding: 4rem 2rem; text-align: center; border-top: 1px solid var(--border); }
.footer p { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.1em; }

/* ─── SCROLL ANIMATIONS ─── */
.reveal { opacity: 0; transform: translateY(20px); transition: all 0.6s ease; }
.reveal.visible { opacity: 1; transform: translateY(0); }

/* ─── RESPONSIVE ─── */
.minimap-label { opacity: 0; width: 0; overflow: hidden; transition: opacity 0.2s ease, width 0.2s ease; }
.minimap-phase-label { opacity: 0; width: 0; overflow: hidden; transition: opacity 0.2s ease, width 0.2s ease; }
.minimap:hover { background: var(--bg); box-shadow: -4px 0 16px rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 0.75rem 1rem 0.75rem 0.5rem; border-radius: 8px; }
.minimap:hover .minimap-label { opacity: 1; width: auto; }
.minimap:hover .minimap-phase-label { opacity: 1; width: auto; }
[data-theme="light"] .minimap:hover { box-shadow: -4px 0 16px rgba(0,0,0,0.08); }
@media (max-width: 768px) {
  .minimap { display: none; }
  .site-nav { padding: 0 0.75rem; }
  .nav-logo { font-size: 0.85rem; }
  .nav-link { font-size: 0.5rem; letter-spacing: 0.08em; }
  .nav-links { gap: 0.5rem; }
  .nav-divider { height: 14px; }
  .pipeline-flow::before { left: 18px; }
  .pipeline-step { grid-template-columns: 36px 1fr; }
  .step-card { padding: 1rem; }
  .step-name { font-size: 1.15rem; }
  .sub-topics { grid-template-columns: 1fr; }
  .step-badge { display: none; }
  .metrics-row { grid-template-columns: repeat(2, 1fr); }
  .phase-overview { grid-template-columns: 1fr; }
  .phase-card:not(:last-child)::after { content: '\2193'; right: 50%; top: auto; bottom: -1rem; transform: translate(50%, 50%); }
}

/* ─── LIGHT THEME ─── */
[data-theme="light"] {
  --bg: #f5f3ef; --bg-card: #ffffff; --bg-card-hover: #f0eee9;
  --border: #d8d5ce; --border-active: #b0abb8;
  --text: #1a1a1f; --text-dim: #4a4750; --text-muted: #8a8690;
  --accent: #1a7ab5; --accent-dim: #155e8c; --accent-glow: rgba(26,122,181,0.07);
  --compute: #b34a00; --memory: #006fa8; --io: #9d6e00; --logic: #a85d87; --network: #1a7ab5;
  --economics: #007A59;
}
[data-theme="light"] .site-nav { background: rgba(245,243,239,0.85); }
[data-theme="light"] .hero::before { background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0,122,89,0.06) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 20% 80%, rgba(157,110,0,0.04) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(168,93,135,0.04) 0%, transparent 50%); }
[data-theme="light"] .step-dot { background: var(--bg-card); }
[data-theme="light"] .pipeline-step:hover .step-dot, [data-theme="light"] .pipeline-step.active .step-dot { box-shadow: 0 0 12px rgba(26,122,181,0.25); }
[data-theme="light"] .badge-economics { border-color: rgba(0,122,89,0.3); background: rgba(0,122,89,0.06); }
[data-theme="light"] .sub-topic { background: rgba(0,0,0,0.02); }
[data-theme="light"] .sub-topic:hover { background: rgba(0,0,0,0.04); }
[data-theme="light"] .metric { background: rgba(0,0,0,0.02); }
[data-theme="light"] .term-tooltip { background: #ffffff; box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
[data-theme="light"] .term-tooltip-close { border-color: rgba(0,0,0,0.15); color: rgba(0,0,0,0.3); }
[data-theme="light"] .term-tooltip-close:hover { border-color: rgba(0,0,0,0.3); color: rgba(0,0,0,0.5); }
[data-theme="light"] .callout-takeaway { background: rgba(26,122,181,0.06); }
[data-theme="light"] .callout-analogy { background: rgba(168,93,135,0.06); }
[data-theme="light"] .detail-text code { background: rgba(26,122,181,0.08); }
[data-theme="light"] .data-table td { border-bottom-color: rgba(0,0,0,0.06); }
[data-theme="light"] .term { text-decoration-color: rgba(26,122,181,0.4); }
[data-theme="light"] ::selection { background: var(--accent); color: #ffffff; }
[data-theme="light"] .minimap-dot { background: var(--bg-card); }
[data-theme="light"] .minimap-item.active .minimap-dot { box-shadow: 0 0 8px rgba(26,122,181,0.2); }
[data-theme="light"] .step-visual { background: rgba(0,0,0,0.02); }

/* ─── INTERACTIVE VISUALS ─── */
.step-visual { position: relative; min-height: 200px; background: rgba(255,255,255,0.015); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin: 0.75rem 0; font-family: var(--font-mono); font-size: 0.7rem; padding: 1.5rem; }
.waterfall-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
.waterfall-label { min-width: 100px; font-size: 0.65rem; color: var(--text-dim); text-align: right; }
.waterfall-bar-wrap { flex: 1; height: 24px; background: rgba(255,255,255,0.03); border-radius: 4px; overflow: hidden; position: relative; }
.waterfall-segment { height: 100%; float: left; transition: width 0.6s ease; position: relative; }
.waterfall-segment:hover { opacity: 0.85; }
.waterfall-val { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 0.55rem; color: rgba(255,255,255,0.9); }
.waterfall-total { font-size: 0.65rem; color: var(--text); min-width: 60px; }
.calc-container { display: flex; flex-direction: column; gap: 1rem; }
.calc-slider-group { display: flex; align-items: center; gap: 1rem; }
.calc-slider-group label { min-width: 100px; font-size: 0.65rem; color: var(--text-dim); }
.calc-slider-group input[type="range"] { flex: 1; accent-color: var(--accent); }
.calc-slider-group .calc-val { min-width: 60px; font-size: 0.75rem; color: var(--accent); text-align: right; }
.calc-result { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
.calc-result-item { flex: 1; min-width: 120px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; text-align: center; }
.calc-result-value { font-family: var(--font-display); font-size: 1.4rem; color: var(--accent); }
.calc-result-label { font-family: var(--font-mono); font-size: 0.5rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 0.2rem; }
.spend-bars { display: flex; flex-direction: column; gap: 0.6rem; }
.spend-row { display: flex; align-items: center; gap: 0.75rem; }
.spend-year { min-width: 50px; font-size: 0.6rem; color: var(--text-dim); text-align: right; }
.spend-bar-wrap { flex: 1; height: 28px; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; display: flex; }
.spend-train { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; color: rgba(255,255,255,0.9); transition: width 0.6s ease; }
.spend-infer { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; color: rgba(255,255,255,0.9); transition: width 0.6s ease; }

body, .callout-box, .metric, .site-nav, .minimap-phase { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }

/* ─── SEARCH ─── */
.search-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 2000; display: flex; align-items: flex-start; justify-content: center; padding-top: 12vh; opacity: 0; pointer-events: none; transition: opacity 0.15s ease; }
.search-overlay.open { opacity: 1; pointer-events: auto; }
.search-modal { background: var(--bg-card); border: 1px solid var(--border-active); border-radius: 12px; width: min(560px, calc(100vw - 2rem)); box-shadow: 0 24px 64px rgba(0,0,0,0.5); transform: translateY(-8px); transition: transform 0.15s ease; }
.search-overlay.open .search-modal { transform: translateY(0); }
.search-input-wrap { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; border-bottom: 1px solid var(--border); }
.search-icon-svg { width: 16px; height: 16px; color: var(--text-muted); flex-shrink: 0; fill: none; }
.search-input { flex: 1; background: none; border: none; outline: none; font-family: var(--font-body); font-size: 0.95rem; color: var(--text); }
.search-input::placeholder { color: var(--text-muted); }
.search-esc-hint { font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-muted); background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 0.15rem 0.4rem; flex-shrink: 0; }
.search-results { max-height: 380px; overflow-y: auto; padding: 0.4rem 0; contain: content; }
.search-group-header { font-family: var(--font-mono); font-size: 0.5rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--text-muted); padding: 0.6rem 1rem 0.2rem; }
.search-result { display: flex; align-items: center; gap: 0.75rem; padding: 0.55rem 1rem; cursor: pointer; transition: background 0.1s ease; }
.search-result:hover, .search-result.selected { background: var(--bg-card-hover); }
.search-result-dot { width: 6px; height: 6px; border-radius: 50%; border: 1.5px solid var(--border-active); background: transparent; flex-shrink: 0; transition: background 0.1s ease, border-color 0.1s ease; }
.search-result.selected .search-result-dot { background: var(--accent); border-color: var(--accent); }
.search-result-body { flex: 1; min-width: 0; }
.search-result-title { font-size: 0.85rem; color: var(--text-dim); }
.search-result.selected .search-result-title { color: var(--text); }
.search-result-desc { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.search-result-badge { font-family: var(--font-mono); font-size: 0.45rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent-dim); border: 1px solid rgba(86,180,233,0.25); border-radius: 3px; padding: 0.1rem 0.3rem; flex-shrink: 0; }
.search-no-results { padding: 2.5rem 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem; }
.search-footer { display: flex; gap: 1.5rem; padding: 0.5rem 1rem; border-top: 1px solid var(--border); justify-content: flex-end; align-items: center; }
.search-footer-hint { font-family: var(--font-mono); font-size: 0.5rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.3rem; }
.search-footer-key { background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 0.1rem 0.3rem; }
.search-trigger { background: none; border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0.6rem; cursor: pointer; color: var(--text-muted); font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 0.05em; transition: border-color 0.2s ease, color 0.2s ease; }
.search-trigger:hover { border-color: var(--border-active); color: var(--text-dim); }
.search-trigger svg { width: 12px; height: 12px; fill: none; }
.search-trigger .search-trigger-label { white-space: nowrap; }
.search-trigger kbd { font-family: var(--font-mono); font-size: 0.5rem; color: var(--text-muted); background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 0.05rem 0.3rem; }
.knowledge-trigger[disabled] { opacity: 0.65; cursor: wait; }
[data-theme="light"] .search-overlay { background: rgba(0,0,0,0.25); }
[data-theme="light"] .search-modal { box-shadow: 0 24px 64px rgba(0,0,0,0.15); }
@media (max-width: 768px) {
  .search-trigger .search-trigger-label, .search-trigger kbd { display: none; }
  .search-trigger { padding: 0.35rem; }
}
</style>
<script>
(function(){
  var s = localStorage.getItem('theme');
  if (s) { document.documentElement.setAttribute('data-theme', s); }
  else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  } else { document.documentElement.setAttribute('data-theme', 'dark'); }
})();
(function(){
  if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
  var key = 'scrollY' + location.pathname;
  window.addEventListener('beforeunload', function(){ sessionStorage.setItem(key, String(window.scrollY)); });
  if (!window.location.hash) {
    var saved = sessionStorage.getItem(key);
    if (saved) {
      var y = parseInt(saved, 10);
      document.addEventListener('DOMContentLoaded', function(){
        document.documentElement.style.scrollBehavior = 'auto';
        window.scrollTo(0, y);
        requestAnimationFrame(function(){ document.documentElement.style.scrollBehavior = ''; });
      });
    }
  }
})();
</script>
</head>
<body>

<!-- ─── NAV ─── -->
<nav class="site-nav">
  <a href="index.html" class="nav-logo">LLM Anatomy</a>
  <div class="nav-links">
    <a href="training.html" class="nav-link">Training</a>
    <a href="training-economics.html" class="nav-link active">Training Economics</a>
    <span class="nav-divider"></span>
    <a href="index.html" class="nav-link">Inference</a>
    <a href="economics.html" class="nav-link">Inference Economics</a>
    <button class="search-trigger" id="search-trigger" aria-label="Search all pages">
      <svg viewBox="0 0 16 16" stroke="currentColor" stroke-width="1.5"><circle cx="6.5" cy="6.5" r="4.5"></circle><path stroke-linecap="round" d="m10 10 3.5 3.5"></path></svg>
      <span class="search-trigger-label">Search</span>
      <kbd id="search-key-hint">&#8984;K</kbd>
    </button>
    <button class="search-trigger knowledge-trigger" id="download-knowledge" aria-label="Download website knowledge as Markdown">
      <svg viewBox="0 0 16 16" stroke="currentColor" stroke-width="1.5" fill="none"><path stroke-linecap="round" stroke-linejoin="round" d="M8 2.5v7"></path><path stroke-linecap="round" stroke-linejoin="round" d="m5.5 7.5 2.5 2.5 2.5-2.5"></path><path stroke-linecap="round" stroke-linejoin="round" d="M3 12.5h10"></path></svg>
      <span class="search-trigger-label">Knowledge</span>
      <kbd>.md</kbd>
    </button>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme"></button>
  </div>
</nav>

<!-- ─── MINIMAP ─── -->
<div class="minimap" id="minimap">
  <div class="minimap-phase">
    <div class="minimap-phase-label">Cost Stack</div>
    <div class="minimap-item" data-target="hardware-costs"><div class="minimap-dot"></div><span class="minimap-label">Hardware</span></div>
    <div class="minimap-item" data-target="scaling-laws"><div class="minimap-dot"></div><span class="minimap-label">Scaling Laws</span></div>
    <div class="minimap-item" data-target="failure-costs"><div class="minimap-dot"></div><span class="minimap-label">Failure Costs</span></div>
  </div>
  <div class="minimap-phase">
    <div class="minimap-phase-label">Business Models</div>
    <div class="minimap-item" data-target="build-vs-buy"><div class="minimap-dot"></div><span class="minimap-label">Build vs Buy</span></div>
    <div class="minimap-item" data-target="training-providers"><div class="minimap-dot"></div><span class="minimap-label">Providers</span></div>
    <div class="minimap-item" data-target="cloud-vs-onprem"><div class="minimap-dot"></div><span class="minimap-label">Cloud vs On-Prem</span></div>
  </div>
  <div class="minimap-phase">
    <div class="minimap-phase-label">Capital &amp; Market</div>
    <div class="minimap-item" data-target="gpu-financing"><div class="minimap-dot"></div><span class="minimap-label">GPU Financing</span></div>
    <div class="minimap-item" data-target="model-funding"><div class="minimap-dot"></div><span class="minimap-label">Model Funding</span></div>
    <div class="minimap-item" data-target="training-vs-inference"><div class="minimap-dot"></div><span class="minimap-label">Train vs Infer</span></div>
  </div>
</div>

<!-- ─── HERO ─── -->
<section class="hero">
  <div class="hero-label">The Cost of Intelligence</div>
  <h1>From GPU to <em>Balance Sheet</em></h1>
  <p class="hero-sub">What it costs to train frontier AI models &mdash; and how the industry finances it.</p>
  <div class="hero-cta"><span class="arrow">&darr;</span> Nine sections, three phases</div>
</section>

<!-- ─── PHASE OVERVIEW ─── -->
<div class="phase-overview">
  <div class="phase-card" onclick="document.getElementById('phase-j').scrollIntoView({behavior:'smooth',block:'start'})">
    <div class="phase-letter">J</div>
    <div class="phase-name">Training Cost Stack</div>
    <div class="phase-subtitle">Hardware, scaling, and failure costs</div>
    <div class="phase-steps">
      <span>J1 &middot; Hardware &amp; Compute Costs</span>
      <span>J2 &middot; Scaling Laws &amp; Efficiency</span>
      <span>J3 &middot; Failure &amp; Wasted Compute</span>
    </div>
  </div>
  <div class="phase-card" onclick="document.getElementById('phase-k').scrollIntoView({behavior:'smooth',block:'start'})">
    <div class="phase-letter">K</div>
    <div class="phase-name">Business Models</div>
    <div class="phase-subtitle">Build, fine-tune, or buy access</div>
    <div class="phase-steps">
      <span>K1 &middot; Build vs Fine-Tune vs API</span>
      <span>K2 &middot; Training Providers</span>
      <span>K3 &middot; Cloud vs On-Premise</span>
    </div>
  </div>
  <div class="phase-card" onclick="document.getElementById('phase-l').scrollIntoView({behavior:'smooth',block:'start'})">
    <div class="phase-letter">L</div>
    <div class="phase-name">Capital &amp; Market</div>
    <div class="phase-subtitle">Financing GPUs and frontier models</div>
    <div class="phase-steps">
      <span>L1 &middot; GPU Financing</span>
      <span>L2 &middot; Foundation Model Funding</span>
      <span>L3 &middot; Training vs Inference Spend</span>
    </div>
  </div>
</div>

<!-- ─── PIPELINE SECTION ─── -->
<section class="pipeline-section" id="pipeline">
  <div class="section-label">Training Economics</div>
  <div class="section-title">The Business of Building Models</div>
  <div class="section-desc">From GPU procurement to venture financing &mdash; the economic machinery behind frontier AI training.</div>

  <div class="pipeline-flow">

    <!-- ═══ PHASE J ═══ -->
    <div class="phase-divider" id="phase-j">
      <div class="phase-divider-marker">J</div>
      <div class="phase-divider-content">
        <div class="phase-divider-name">Training Cost Stack</div>
        <div class="phase-divider-desc">What it costs to train a frontier model</div>
      </div>
    </div>

    <!-- J1: Hardware & Compute Costs -->
    <div class="pipeline-step reveal" data-step="hardware-costs" id="hardware-costs">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">J1</span>
          <span class="step-name">Hardware &amp; Compute Costs</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">GPU pricing, cloud rental rates, and the exponential escalation of training costs.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Training costs are doubling every ~8 months. GPT-4 cost ~$100M; frontier models by 2027 will exceed $1B. Meanwhile, cloud GPU rental has fallen 60-70%, creating a growing gap between buying and renting.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">GPU Pricing</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>GPU</th><th>Price</th><th>Notes</th></tr></thead>
                  <tbody>
                    <tr><td>H100 SXM</td><td>$25-31K</td><td>The workhorse of 2024 training</td></tr>
                    <tr><td>B200</td><td>$30-35K</td><td>2x H100 performance</td></tr>
                    <tr><td>GB200 NVL72</td><td>~$3M</td><td>72-GPU rack system</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Cloud Rental Decline</div>
              <div class="detail-text">
                <p>H100 cloud pricing fell from <strong>$8/hr</strong> (early 2024) to <strong>~$1.50/hr</strong> (late 2025) &mdash; a <strong>60-70% drop</strong> driven by massive supply buildout and competition from CoreWeave, Lambda, and hyperscalers.</p>
                <table class="data-table" style="margin-top:0.75rem">
                  <thead><tr><th>GPU</th><th>Crusoe On-Demand</th><th>Crusoe Spot</th><th>Fireworks On-Demand</th></tr></thead>
                  <tbody>
                    <tr><td>A100 80 GB</td><td>$1.95/hr</td><td>$1.30/hr</td><td>$3.19/hr</td></tr>
                    <tr><td>H100 SXM</td><td>$3.90/hr</td><td>$1.60/hr</td><td>$5.49/hr</td></tr>
                    <tr><td>H200 SXM</td><td>$4.29/hr</td><td>&mdash;</td><td>&mdash;</td></tr>
                    <tr><td>B200</td><td>Coming soon</td><td>&mdash;</td><td>&mdash;</td></tr>
                  </tbody>
                </table>
                <p style="margin-top:0.5rem"><strong>Training cost example:</strong> An 8&times;H100 fine-tuning run on Crusoe spot at $1.60/hr &times; 8 GPUs &times; 24 hours = <strong>$307</strong> for a day-long training session. The same run on managed platforms costs 2&ndash;3&times; more but includes orchestration, checkpointing, and automatic failure recovery.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Training Cost Benchmarks</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Model</th><th>Training Cost</th><th>GPUs</th></tr></thead>
                  <tbody>
                    <tr><td>GPT-4</td><td>$78-100M</td><td>~25,000 A100s</td></tr>
                    <tr><td>Llama 3 405B</td><td>~$60M</td><td>16,384 H100s</td></tr>
                    <tr><td>DeepSeek V3</td><td>$5.5M (GPU only)</td><td>2,048 H800s</td></tr>
                    <tr><td>Gemini Ultra</td><td>~$191M</td><td>TPU v4 pods</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Cost Breakdown (Epoch AI)</div>
              <div class="detail-text">
                <p><strong>Chips</strong>: 21-30% &middot; <strong>Server/networking</strong>: 22-30% &middot; <strong>Staff</strong>: 29-49% &middot; <strong>Energy</strong>: 2-6%. Staff costs dominate at smaller scales; hardware dominates at frontier scale.</p>
              </div>
            </div>

            <div class="step-visual" id="visual-training-waterfall"></div>

            <a href="economics.html#cost-stack" class="cross-link">&rarr; Inference cost stack comparison</a>
          </div>
        </div>
      </div>
    </div>

    <!-- J2: Scaling Laws -->
    <div class="pipeline-step reveal" data-step="scaling-laws" id="scaling-laws">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">J2</span>
          <span class="step-name">Scaling Laws &amp; Efficiency</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">The Chinchilla trap, over-training economics, and why smaller models trained longer can be cheaper overall.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Chinchilla-optimal training (20 tokens/parameter) minimizes training cost but ignores inference cost. The industry now over-trains smaller models — Llama 3 at 200 tokens/param — to shift cost from inference to training.</p>
            </div>
            <div class="callout-box callout-analogy">
              <div class="callout-label">Think of it like&hellip;</div>
              <p>Building a factory vs. running it. Chinchilla minimizes factory construction cost but doesn&rsquo;t consider that a smaller, better-trained factory may produce cheaper widgets for years to come.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Chinchilla Optimal</div>
              <div class="detail-text">
                <p><span class="term" data-term="chinchilla">Chinchilla scaling laws</span> (2022): for a fixed compute budget, the optimal allocation is <strong>20 tokens per parameter</strong>. A 70B model should train on 1.4T tokens. This minimizes training loss per FLOP.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">The Chinchilla Trap</div>
              <div class="detail-text">
                <p>Chinchilla-optimal training minimizes <em>training</em> cost but ignores <em>inference</em> cost. A model&rsquo;s lifetime inference cost can be <strong>10-15x its training cost</strong> (GPT-4: ~$100M training, ~$2.3B inference over 18 months). Optimizing for training alone is locally optimal but globally wasteful.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Modern Over-Training</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Model</th><th>Params</th><th>Tokens</th><th>Tokens/Param</th></tr></thead>
                  <tbody>
                    <tr><td>Chinchilla</td><td>70B</td><td>1.4T</td><td>20x (optimal)</td></tr>
                    <tr><td>Llama 3 405B</td><td>405B</td><td>15T</td><td>37x</td></tr>
                    <tr><td>Llama 3 8B</td><td>8B</td><td>15T</td><td>1,875x</td></tr>
                    <tr><td>Qwen3-0.6B</td><td>0.6B</td><td>36T</td><td>60,000x</td></tr>
                  </tbody>
                </table>
                <p>The industry shift: <strong>spend more on training (one-time) to make every inference call cheaper (ongoing)</strong>. Over-training smaller models by 10-1,000x Chinchilla-optimal is now standard practice.</p>
              </div>
            </div>

            <div class="step-visual" id="visual-scaling-curve"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- J3: Failure Costs -->
    <div class="pipeline-step reveal" data-step="failure-costs" id="failure-costs">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">J3</span>
          <span class="step-name">Failure &amp; Wasted Compute</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Training failures burn millions in GPU-hours. Checkpointing overhead alone costs 12-43% of training time.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>OpenAI spent $7B on R&amp;D in one year, with over 70% going to failed experiments. Less than $1B was for the final successful training run. Frontier AI research is dominated by the cost of exploration, not exploitation.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Failure Statistics</div>
              <div class="metrics-row">
                <div class="metric"><div class="metric-value">419</div><div class="metric-label">Llama 3 Failures</div></div>
                <div class="metric"><div class="metric-value">$8K</div><div class="metric-label">Per 8hr Loss (512 GPUs)</div></div>
                <div class="metric"><div class="metric-value">178K</div><div class="metric-label">OPT-175B Wasted GPU-hrs</div></div>
                <div class="metric"><div class="metric-value">12-43%</div><div class="metric-label">Checkpoint Overhead</div></div>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">R&amp;D vs. Final Training</div>
              <div class="detail-text">
                <p><strong>OpenAI 2024 R&amp;D spend: ~$7B total.</strong> The vast majority (&gt;70%) went to experimentation &mdash; architecture search, hyperparameter tuning, failed training runs, and data mixture experiments. The final production training run for a model like GPT-4 costs &lt;$1B of that total.</p>
                <p>This mirrors pharmaceutical R&amp;D: the drug that ships costs a fraction of the total research budget that produced hundreds of failed candidates.</p>
              </div>
            </div>

            <a href="training.html#monitoring" class="cross-link">&rarr; Monitoring &amp; recovery systems</a>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ PHASE K ═══ -->
    <div class="phase-divider" id="phase-k">
      <div class="phase-divider-marker">K</div>
      <div class="phase-divider-content">
        <div class="phase-divider-name">Business Models</div>
        <div class="phase-divider-desc">How organizations access training compute</div>
      </div>
    </div>

    <!-- K1: Build vs Fine-Tune vs API -->
    <div class="pipeline-step reveal" data-step="build-vs-buy" id="build-vs-buy">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">K1</span>
          <span class="step-name">Build vs Fine-Tune vs API</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Foundation training costs $50M+; LoRA fine-tuning costs $300. The decision framework for when each makes sense.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>For 99% of organizations, fine-tuning or API access is the right choice. Foundation model training is only viable for the largest labs with differentiated data or architecture advantages.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Cost Comparison</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Approach</th><th>Cost Range</th><th>When It Makes Sense</th></tr></thead>
                  <tbody>
                    <tr><td>Foundation training</td><td>$50M-$500M+</td><td>Differentiated architecture, massive data moat</td></tr>
                    <tr><td>Full fine-tuning</td><td>~$50K/run (7B)</td><td>Need deep domain specialization</td></tr>
                    <tr><td>LoRA/QLoRA</td><td>$300-$3,000/run</td><td>90-95% of fine-tuning quality at 1% cost</td></tr>
                    <tr><td>API inference</td><td>Pay per token</td><td>No training cost, fastest time to value</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Decision Framework</div>
              <div class="detail-text">
                <p><strong>Build from scratch</strong> if: you have unique data at scale, need architecture control, and can sustain $100M+/year in compute spend (OpenAI, Anthropic, Google, Meta).</p>
                <p><strong>Fine-tune</strong> if: you need domain-specific behavior, proprietary knowledge injection, or format/style control that prompting can&rsquo;t achieve.</p>
                <p><strong>Use APIs</strong> if: your use case can be solved with prompting + RAG, you need rapid iteration, or you can&rsquo;t justify the fixed cost of training infrastructure.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Managed Fine-Tuning Economics (Fireworks)</div>
              <div class="detail-text">
                <p>Modern managed stacks now cover the full post-training ladder: supervised text/chat/vision fine-tuning, DPO, and RFT. This collapses integration overhead compared with stitching multiple vendors.</p>
                <p>Fireworks-specific levers that change unit economics: <strong>one-click LoRA deployment</strong>, support for up to <strong>100 LoRA adapters per base model</strong> on a single deployment, and secure enterprise modes for customer-controlled data boundaries.</p>
                <p>Operationally, synthetic data generation plus built-in evaluation loops reduce labeling and experimentation costs, shifting budgets from infrastructure plumbing to model quality iteration.</p>
                <table class="data-table" style="margin-top:0.75rem">
                  <thead><tr><th>Model Size</th><th>SFT $/M tokens</th><th>DPO $/M tokens</th></tr></thead>
                  <tbody>
                    <tr><td>&le;16B</td><td>$0.50</td><td>$1.00</td></tr>
                    <tr><td>16B &ndash; 80B</td><td>$2.00</td><td>$4.00</td></tr>
                    <tr><td>80B &ndash; 300B</td><td>$5.00</td><td>$10.00</td></tr>
                    <tr><td>300B+</td><td>$10.00</td><td>$20.00</td></tr>
                  </tbody>
                </table>
                <p style="margin-top:0.5rem">DPO costs <strong>2&times; SFT</strong> because each training step processes a preference pair (chosen + rejected), doubling compute. Back-of-envelope: a LoRA fine-tune on a 7B model with 10K examples (~5M tokens) costs roughly <strong>$2.50&ndash;$25</strong> on managed platforms &mdash; orders of magnitude less than raw GPU rental for equivalent self-managed runs.</p>
              </div>
            </div>

            <div class="step-visual" id="visual-cost-calc"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- K2: Training Providers -->
    <div class="pipeline-step reveal" data-step="training-providers" id="training-providers">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">K2</span>
          <span class="step-name">Training Providers</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Foundation model labs, training-as-a-service companies, and the cloud vs. on-prem cost differential.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Llama 3 would have cost $483M on AWS vs. ~$60M on Meta&rsquo;s own cluster. The 8x cost advantage of on-prem at scale explains why every major lab is building its own data centers.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Foundation Model Labs</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Lab</th><th>Compute Spend</th><th>CapEx (2025)</th></tr></thead>
                  <tbody>
                    <tr><td>OpenAI</td><td>~$7B/yr R&amp;D</td><td>Partnership with Microsoft</td></tr>
                    <tr><td>Anthropic</td><td>$33.7B raised</td><td>AWS + GCP partnerships</td></tr>
                    <tr><td>Google DeepMind</td><td>Internal TPU</td><td>$85B total AI CapEx</td></tr>
                    <tr><td>Meta AI</td><td>Own clusters</td><td>$68B total AI CapEx</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Training-as-a-Service</div>
              <div class="detail-text">
                <p><strong>Together AI</strong> ($3.3B valuation): managed training and inference platform. <strong>Anyscale</strong> ($1B+): Ray-based distributed training. <strong>Modal</strong> ($1.1B): serverless GPU compute with training focus. These companies provide the infrastructure layer for organizations that want to train without building their own clusters.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- K3: Cloud vs On-Premise -->
    <div class="pipeline-step reveal" data-step="cloud-vs-onprem" id="cloud-vs-onprem">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">K3</span>
          <span class="step-name">Cloud vs On-Premise</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Cloud offers flexibility; on-prem offers 3-8x cost savings for sustained workloads. The breakeven is at ~60-70% utilization.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>Cloud = buying a call option on compute (pay premium for flexibility). On-prem = owning the asset (3-8x cheaper if utilization stays above 60-70%). The right answer depends on demand predictability and time horizon.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Cloud Advantages</div>
              <div class="detail-text">
                <p>No upfront CapEx. Access to latest hardware without procurement delays. Burst capacity for experiments. Scale down when not training. <strong>Option value</strong>: switch hardware as next-gen GPUs ship every 12-18 months.</p>
                <p style="margin-top:0.5rem"><strong>The managed middle ground:</strong> Crusoe spot H100s at $1.60/hr combined with managed Slurm and AutoClusters offer a hybrid between cloud flexibility and on-prem economics. Teams get near-bare-metal rates (60% below on-demand) without managing their own cluster orchestration, checkpointing, or failure recovery. This collapses the build-vs-rent decision for training workloads that don&rsquo;t require 24/7 uptime.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">On-Prem Advantages</div>
              <div class="detail-text">
                <p><strong>3-8x cheaper</strong> for sustained workloads at high utilization. Full control over hardware configuration, networking topology, and security. No egress charges for massive data movement. Predictable cost structure for financial planning.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Hidden On-Prem Costs</div>
              <div class="detail-text">
                <p>Data center space and construction. Power infrastructure and cooling systems. Network engineering staff. 5-6 month GPU procurement lead times. Hardware maintenance and spare inventory. Opportunity cost of capital locked in depreciating assets.</p>
              </div>
            </div>

            <a href="economics.html#data-centers" class="cross-link">&rarr; Data center economics for inference</a>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ PHASE L ═══ -->
    <div class="phase-divider" id="phase-l">
      <div class="phase-divider-marker">L</div>
      <div class="phase-divider-content">
        <div class="phase-divider-name">Capital &amp; Market</div>
        <div class="phase-divider-desc">Financing the AI infrastructure buildout</div>
      </div>
    </div>

    <!-- L1: GPU Financing -->
    <div class="pipeline-step reveal" data-step="gpu-financing" id="gpu-financing">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">L1</span>
          <span class="step-name">GPU Financing</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">CoreWeave raised $7.6B in GPU-backed debt. GPUs are the new collateral class &mdash; but depreciation risk is severe.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>GPU-backed financing enabled the AI infrastructure buildout, but the underlying collateral is depreciating rapidly: H100 rentals fell 60-70%, and hardware faces 30-40% year-one depreciation. Lenders are taking concentrated technology risk.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Key Deals</div>
              <div class="detail-text">
                <p><strong>CoreWeave</strong>: $7.6B in GPU-backed debt, $14.6B in equipment assets. IPO&rsquo;d at $40, reached $183. The poster child for GPU-as-collateral financing.</p>
                <p><strong>Lambda</strong>: $1.5B sale-leaseback &mdash; sell GPUs to a lessor, lease them back. Frees capital while retaining operational control.</p>
                <p><strong>Creative structures</strong>: 5-year GPU leases, synthetic GPU derivatives, sale-leasebacks backed by contracted cloud revenue.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Depreciation Risk</div>
              <div class="detail-text">
                <p>H100 cloud rental fell <strong>60-70%</strong> in 18 months. Hardware faces <strong>30-40% year-one depreciation</strong>. Each new generation (B200, GB200) makes the previous one less economically viable. Lenders underwriting 5-year GPU loans face significant residual value risk.</p>
              </div>
            </div>

            <a href="economics.html#equity-vs-debt" class="cross-link">&rarr; Equity vs debt financing for inference</a>
          </div>
        </div>
      </div>
    </div>

    <!-- L2: Foundation Model Funding -->
    <div class="pipeline-step reveal" data-step="model-funding" id="model-funding">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">L2</span>
          <span class="step-name">Foundation Model Funding</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">Top 10 AI mega-rounds in 2025 totaled $84B. Big Tech AI CapEx: $405B in 2025, projected $3T through 2029.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>AI funding has reached unprecedented scale: Anthropic raised $30B at $380B valuation, OpenAI planned $40B+ rounds, and Big Tech collectively committed $405B in 2025 AI CapEx. The GPU-rich vs GPU-poor dynamic is the defining market structure.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Recent Mega-Rounds</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Company</th><th>Amount</th><th>Valuation</th></tr></thead>
                  <tbody>
                    <tr><td>OpenAI</td><td>$40B+</td><td>~$300B</td></tr>
                    <tr><td>Anthropic</td><td>$30B</td><td>$380B (Feb 2026)</td></tr>
                    <tr><td>xAI</td><td>$6B</td><td>$50B</td></tr>
                    <tr><td>CoreWeave</td><td>$7.6B debt + IPO</td><td>$35B+ at peak</td></tr>
                    <tr><td>Crusoe</td><td>$3.4B Series E + $9.6B infra debt</td><td>$10B+</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Big Tech AI Infrastructure</div>
              <div class="detail-text">
                <p><strong>2025 CapEx commitments</strong>: Google $85B, Meta $68B, Microsoft $80B, Amazon $100B+, Apple $500M (data centers). Morgan Stanley projects <strong>$3T cumulative AI infrastructure spending through 2029</strong>.</p>
                <p>OpenAI&rsquo;s $1T infrastructure plan through 2035 includes custom data centers, chip development (with Samsung/TSMC), and a global network of training clusters.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- L3: Training vs Inference Spend -->
    <div class="pipeline-step reveal" data-step="training-vs-inference" id="training-vs-inference">
      <div class="step-marker"><div class="step-dot"></div></div>
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">L3</span>
          <span class="step-name">Training vs Inference Spend</span>
          <span class="step-badge badge-economics">Economics</span>
          <span class="step-expand-icon">+</span>
        </div>
        <div class="step-summary">The industry is shifting from training-dominated to inference-dominated spend &mdash; from 2:1 in 2023 to 1:2 by 2026.</div>
        <div class="step-detail">
          <div class="detail-inner">
            <div class="callout-box callout-takeaway">
              <div class="callout-label">Key Takeaway</div>
              <p>GPT-4&rsquo;s lifetime inference cost (~$2.3B) is 15x its training cost (~$100M). As models are deployed at scale, inference becomes the dominant cost driver. The AI inference market is projected to grow from $106B (2025) to $255B by 2030.</p>
            </div>

            <div class="detail-section">
              <div class="detail-label">Spend Ratio Shift</div>
              <div class="detail-text">
                <table class="data-table">
                  <thead><tr><th>Year</th><th>Training</th><th>Inference</th></tr></thead>
                  <tbody>
                    <tr><td>2023</td><td>~67%</td><td>~33%</td></tr>
                    <tr><td>2025</td><td>~50%</td><td>~50%</td></tr>
                    <tr><td>2026 (proj.)</td><td>~33%</td><td>~67%</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Reasoning Models Shift More Cost to Inference</div>
              <div class="detail-text">
                <p>Reasoning-capable deployment modes (<span class="term" data-term="interleaved-thinking">interleaved thinking</span>, preserved reasoning context, tool-augmented loops) increase runtime decode work per request. Even when training cost is unchanged, inference spend grows faster because each query executes more steps.</p>
                <p>Cost controls increasingly move to runtime policy: reasoning effort levels, thinking-token budgets, and history retention policies. In practice, product pricing and scheduler policy now matter as much as model architecture for total lifecycle margin.</p>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">OpenAI 2024 Breakdown</div>
              <div class="metrics-row">
                <div class="metric"><div class="metric-value">$3B</div><div class="metric-label">Training Compute</div></div>
                <div class="metric"><div class="metric-value">$1.8B</div><div class="metric-label">Inference Compute</div></div>
                <div class="metric"><div class="metric-value">$2B</div><div class="metric-label">R&amp;D (Failed Experiments)</div></div>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">Industry Spend vs Revenue</div>
              <div class="detail-text">
                <p>Total AI industry spend in 2025: <strong>~$527B</strong>. Total AI revenue: <strong>~$51B</strong>. That&rsquo;s a <strong>10:1 spend-to-revenue ratio</strong>, the largest infrastructure-to-revenue gap since the early days of cloud computing. The bet: inference revenue at scale will eventually justify the capital deployed.</p>
              </div>
            </div>

            <div class="step-visual" id="visual-spend-timeline"></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /pipeline-flow -->
</section>

<!-- ─── FOOTER ─── -->
<footer class="footer">
  <p>Training Economics &middot; A reference on the business of building large language models</p>
</footer>

<script>
/* ─── THEME TOGGLE ─── */
var toggle = document.getElementById('theme-toggle');
if (toggle) {
  toggle.addEventListener('click', function() {
    var current = document.documentElement.getAttribute('data-theme') || 'dark';
    var next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  });
}

/* ─── REVEAL ON SCROLL ─── */
var revealObserver = new IntersectionObserver(function(entries) {
  entries.forEach(function(entry) {
    if (entry.isIntersecting) {
      entry.target.classList.add('visible');
      revealObserver.unobserve(entry.target);
    }
  });
}, { threshold: 0.1 });

document.querySelectorAll('.reveal').forEach(function(el) {
  revealObserver.observe(el);
});

/* ─── PIPELINE STEP TOGGLE ─── */
document.querySelectorAll('.pipeline-step').forEach(function(step) {
  step.querySelector('.step-card').addEventListener('click', function(e) {
    if (e.target.closest('.term, a, button, .step-detail, .sub-topic')) return;
    step.classList.toggle('active');
  });
});

/* ─── SUB-TOPIC TOGGLE ─── */
window.toggleSubTopic = function(el) {
  el.closest('.sub-topic').classList.toggle('expanded');
};

/* ─── TERM TOOLTIPS ─── */
var activeTooltip = null;
var activeTermEl = null;

var termDefs = {
  'chinchilla': { def: 'Chinchilla scaling laws (Hoffmann et al., 2022): for a fixed compute budget, optimal training uses ~20 tokens per parameter. This minimizes training loss per FLOP but ignores downstream inference costs.' },
  'scaling-laws': { def: 'Mathematical relationships between model size, data quantity, and compute budget that predict model performance. Kaplan (2020) and Chinchilla (2022) established the foundational scaling laws for LLMs.' },
  'statistical-multiplexing': { def: 'Sharing GPU resources across many customers whose peak demand doesn\'t coincide. Enables 80-90% utilization vs. 10-20% for dedicated instances, creating the economic basis for cloud GPU providers.' },
  'interleaved-thinking': { def: 'Reasoning mode where a model alternates between reasoning, tool actions, and answer generation within one turn. This increases inference-time compute demand per request.' }
};

function dismissTooltip() {
  if (activeTooltip) { activeTooltip.remove(); activeTooltip = null; activeTermEl = null; }
}

function showTermTooltip(term) {
  if (activeTermEl === term) { dismissTooltip(); return; }
  dismissTooltip();
  var key = term.getAttribute('data-term');
  var def = termDefs[key];
  if (!def) return;
  activeTermEl = term;

  var tip = document.createElement('div');
  tip.className = 'term-tooltip';

  var closeBtn = document.createElement('button');
  closeBtn.className = 'term-tooltip-close';
  closeBtn.textContent = '\u00D7';
  closeBtn.addEventListener('click', function(e) { e.stopPropagation(); dismissTooltip(); });
  tip.appendChild(closeBtn);

  var title = document.createElement('div');
  title.className = 'term-tooltip-title';
  title.textContent = term.textContent;
  tip.appendChild(title);

  var body = document.createElement('div');
  body.className = 'term-tooltip-body';
  body.textContent = def.def;
  tip.appendChild(body);

  document.body.appendChild(tip);
  activeTooltip = tip;

  var r = term.getBoundingClientRect();
  var tw = tip.offsetWidth;
  var th = tip.offsetHeight;
  var left = r.left + r.width / 2 - tw / 2;
  var top = r.bottom + 8;

  if (left < 8) left = 8;
  if (left + tw > window.innerWidth - 8) left = window.innerWidth - tw - 8;
  if (top + th > window.innerHeight - 8) top = r.top - th - 8;

  tip.style.left = left + 'px';
  tip.style.top = top + 'px';
}

document.querySelectorAll('.term').forEach(function(term) {
  term.addEventListener('click', function(e) {
    e.stopPropagation();
    e.preventDefault();
    showTermTooltip(term);
  });
});

document.addEventListener('click', function(e) {
  if (activeTooltip && !activeTooltip.contains(e.target) && !e.target.classList.contains('term')) {
    dismissTooltip();
  }
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') dismissTooltip();
});

/* ─── MINIMAP ─── */
var minimap = document.getElementById('minimap');
var minimapItems = minimap.querySelectorAll('.minimap-item');
var scrollLock = false;

var minimapObserver = new IntersectionObserver(function(entries) {
  if (scrollLock) return;
  entries.forEach(function(entry) {
    if (entry.isIntersecting) {
      var id = entry.target.id;
      minimapItems.forEach(function(item) {
        item.classList.toggle('active', item.getAttribute('data-target') === id);
      });
    }
  });
}, { rootMargin: '-64px 0px -60% 0px', threshold: 0 });

document.querySelectorAll('.pipeline-step[id], .phase-divider[id]').forEach(function(section) {
  if (section.id) minimapObserver.observe(section);
});

minimapItems.forEach(function(item) {
  item.addEventListener('click', function() {
    var targetId = item.getAttribute('data-target');
    var el = document.getElementById(targetId);
    if (!el) return;

    minimapItems.forEach(function(mi) { mi.classList.remove('active'); });
    item.classList.add('active');
    scrollLock = true;

    window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 64, behavior: 'smooth' });

    setTimeout(function() { scrollLock = false; }, 800);
  });
});

/* Show minimap from hero through all content, hide in footer */
var visibleSections = new Set();
var minimapShowObserver = new IntersectionObserver(function(entries) {
  entries.forEach(function(entry) {
    if (entry.isIntersecting) visibleSections.add(entry.target);
    else visibleSections.delete(entry.target);
  });
  minimap.classList.toggle('visible', visibleSections.size > 0);
}, { threshold: 0 });
var heroSection = document.querySelector('.hero');
var pipelineSection = document.getElementById('pipeline');
if (heroSection) minimapShowObserver.observe(heroSection);
if (pipelineSection) minimapShowObserver.observe(pipelineSection);

/* ─── INTERACTIVE VISUALS ─── */

// J1: Training Cost Waterfall
function initTrainingWaterfall() {
  var el = document.getElementById('visual-training-waterfall');
  if (!el) return;

  var data = [
    { label: 'Chips (GPUs)', pct: 25, color: 'var(--compute)' },
    { label: 'Server & Networking', pct: 26, color: 'var(--network)' },
    { label: 'Staff', pct: 39, color: 'var(--logic)' },
    { label: 'Energy', pct: 4, color: 'var(--io)' },
    { label: 'Other', pct: 6, color: 'var(--text-muted)' }
  ];

  var html = '<div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1rem">Training Cost Breakdown (Epoch AI, Frontier Models)</div>';

  html += '<div class="waterfall-row"><div class="waterfall-label">Cost Share</div><div class="waterfall-bar-wrap">';
  data.forEach(function(d) {
    html += '<div class="waterfall-segment" style="width:' + d.pct + '%;background:' + d.color + '" title="' + d.label + ': ' + d.pct + '%">';
    if (d.pct > 6) html += '<span class="waterfall-val">' + d.pct + '%</span>';
    html += '</div>';
  });
  html += '</div><div class="waterfall-total">100%</div></div>';

  // Legend
  html += '<div style="display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:0.5rem">';
  data.forEach(function(d) {
    html += '<div style="display:flex;align-items:center;gap:0.3rem"><span style="width:10px;height:10px;border-radius:2px;background:' + d.color + '"></span><span style="font-size:0.55rem;color:var(--text-dim)">' + d.label + ' (' + d.pct + '%)</span></div>';
  });
  html += '</div>';

  // Model costs comparison
  html += '<div style="margin-top:1rem;font-size:0.55rem;color:var(--text-muted);letter-spacing:0.12em;text-transform:uppercase;margin-bottom:0.5rem">Estimated Total Training Cost</div>';
  var models = [
    { name: 'DeepSeek V3', cost: 5.5, color: 'var(--economics)' },
    { name: 'Llama 3 405B', cost: 60, color: 'var(--accent)' },
    { name: 'GPT-4', cost: 89, color: 'var(--compute)' },
    { name: 'Gemini Ultra', cost: 191, color: 'var(--logic)' }
  ];
  models.forEach(function(m) {
    var pct = (m.cost / 191 * 100).toFixed(1);
    html += '<div class="waterfall-row"><div class="waterfall-label">' + m.name + '</div>';
    html += '<div class="waterfall-bar-wrap"><div class="waterfall-segment" style="width:' + pct + '%;background:' + m.color + '"><span class="waterfall-val">$' + m.cost + 'M</span></div></div>';
    html += '<div class="waterfall-total">$' + m.cost + 'M</div></div>';
  });

  el.innerHTML = html;
}

// J2: Scaling Curve
function initScalingCurve() {
  var el = document.getElementById('visual-scaling-curve');
  if (!el) return;

  var points = [
    { name: 'Chinchilla (70B)', tokPerParam: 20, quality: 42, color: 'var(--compute)' },
    { name: 'Llama 3 405B', tokPerParam: 37, quality: 68, color: 'var(--accent)' },
    { name: 'Llama 3 8B', tokPerParam: 1875, quality: 72, color: 'var(--network)' },
    { name: 'Qwen3-0.6B', tokPerParam: 60000, quality: 58, color: 'var(--logic)' }
  ];

  var html = '<div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1rem">Over-Training: Tokens per Parameter vs Chinchilla Optimal</div>';

  // Visual scale — use log-ish representation
  html += '<div style="position:relative;padding:0.5rem 0">';
  points.forEach(function(p) {
    var logScale = Math.log10(p.tokPerParam);
    var maxLog = Math.log10(60000);
    var minLog = Math.log10(20);
    var pct = ((logScale - minLog) / (maxLog - minLog) * 85 + 5).toFixed(1);
    var ratio = (p.tokPerParam / 20).toFixed(0);
    html += '<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.6rem">';
    html += '<div style="min-width:110px;font-size:0.6rem;color:var(--text-dim);text-align:right">' + p.name + '</div>';
    html += '<div style="flex:1;height:24px;background:rgba(255,255,255,0.03);border-radius:4px;overflow:hidden;position:relative">';
    html += '<div style="width:' + pct + '%;height:100%;background:' + p.color + ';border-radius:4px;display:flex;align-items:center;padding:0 0.5rem">';
    html += '<span style="font-size:0.5rem;color:rgba(255,255,255,0.9)">' + p.tokPerParam.toLocaleString() + 'x</span>';
    html += '</div></div>';
    html += '<div style="min-width:50px;font-size:0.55rem;color:var(--text-dim)">' + ratio + 'x opt</div>';
    html += '</div>';
  });
  html += '</div>';

  html += '<div style="text-align:center;font-size:0.65rem;color:var(--text-dim);margin-top:0.5rem">The industry shifted from <strong style="color:var(--compute)">Chinchilla-optimal</strong> (cheapest training) to <strong style="color:var(--accent)">inference-optimal</strong> (cheapest deployment)</div>';

  el.innerHTML = html;
}

// K1: Cost Calculator
function initCostCalc() {
  var el = document.getElementById('visual-cost-calc');
  if (!el) return;

  var html = '<div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1rem">Training Approach Cost Estimator</div>';
  html += '<div class="calc-container">';

  html += '<div class="calc-slider-group"><label>Model Size</label><input type="range" id="tc-size" min="0" max="3" value="1" step="1"><span class="calc-val" id="tc-size-val">7B</span></div>';
  html += '<div class="calc-slider-group"><label>Token Budget</label><input type="range" id="tc-tokens" min="1" max="100" value="15" step="1"><span class="calc-val" id="tc-tokens-val">15T</span></div>';

  html += '<div class="calc-result">';
  html += '<div class="calc-result-item"><div class="calc-result-value" id="tc-foundation">$50K</div><div class="calc-result-label">Foundation Training</div></div>';
  html += '<div class="calc-result-item"><div class="calc-result-value" id="tc-finetune">$50K</div><div class="calc-result-label">Full Fine-Tune</div></div>';
  html += '<div class="calc-result-item"><div class="calc-result-value" id="tc-lora">$300</div><div class="calc-result-label">LoRA/QLoRA</div></div>';
  html += '<div class="calc-result-item"><div class="calc-result-value" id="tc-api">$0</div><div class="calc-result-label">API (No Training)</div></div>';
  html += '</div></div>';

  el.innerHTML = html;

  var sizeSlider = document.getElementById('tc-size');
  var tokenSlider = document.getElementById('tc-tokens');
  var sizes = [
    { label: '0.6B', params: 0.6 },
    { label: '7B', params: 7 },
    { label: '70B', params: 70 },
    { label: '405B', params: 405 }
  ];

  function updateCostCalc() {
    var sizeIdx = parseInt(sizeSlider.value);
    var tokens = parseInt(tokenSlider.value);
    var size = sizes[sizeIdx];

    document.getElementById('tc-size-val').textContent = size.label;
    document.getElementById('tc-tokens-val').textContent = tokens + 'T';

    // Foundation: ~$0.004 per billion param-tokens on H100 cluster
    var foundationCost = size.params * tokens * 4000;
    // Fine-tune: ~100x cheaper than from-scratch, 10K-100K examples
    var ftCost = size.params * 7000;
    // LoRA: ~100x cheaper than fine-tune
    var loraCost = size.params * 40 + 200;

    document.getElementById('tc-foundation').textContent = formatCost(foundationCost);
    document.getElementById('tc-finetune').textContent = formatCost(ftCost);
    document.getElementById('tc-lora').textContent = formatCost(loraCost);
    document.getElementById('tc-api').textContent = '$0';
  }

  function formatCost(val) {
    if (val >= 1000000) return '$' + (val / 1000000).toFixed(0) + 'M';
    if (val >= 1000) return '$' + (val / 1000).toFixed(0) + 'K';
    return '$' + val.toFixed(0);
  }

  sizeSlider.addEventListener('input', updateCostCalc);
  tokenSlider.addEventListener('input', updateCostCalc);
  updateCostCalc();
}

// L3: Training vs Inference Spend Timeline
function initSpendTimeline() {
  var el = document.getElementById('visual-spend-timeline');
  if (!el) return;

  var years = [
    { year: '2023', train: 67, infer: 33 },
    { year: '2024', train: 55, infer: 45 },
    { year: '2025', train: 50, infer: 50 },
    { year: '2026E', train: 35, infer: 65 }
  ];

  var html = '<div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1rem">Training vs Inference Spend Shift</div>';

  html += '<div class="spend-bars">';
  years.forEach(function(y) {
    html += '<div class="spend-row">';
    html += '<div class="spend-year">' + y.year + '</div>';
    html += '<div class="spend-bar-wrap">';
    html += '<div class="spend-train" style="width:' + y.train + '%;background:var(--compute)">' + (y.train > 10 ? y.train + '% Train' : '') + '</div>';
    html += '<div class="spend-infer" style="width:' + y.infer + '%;background:var(--accent)">' + (y.infer > 10 ? y.infer + '% Infer' : '') + '</div>';
    html += '</div></div>';
  });
  html += '</div>';

  // Legend
  html += '<div style="display:flex;gap:1rem;margin-top:0.75rem;justify-content:center">';
  html += '<div style="display:flex;align-items:center;gap:0.3rem"><span style="width:10px;height:10px;border-radius:2px;background:var(--compute)"></span><span style="font-size:0.55rem;color:var(--text-dim)">Training</span></div>';
  html += '<div style="display:flex;align-items:center;gap:0.3rem"><span style="width:10px;height:10px;border-radius:2px;background:var(--accent)"></span><span style="font-size:0.55rem;color:var(--text-dim)">Inference</span></div>';
  html += '</div>';

  html += '<div style="text-align:center;font-size:0.65rem;color:var(--text-dim);margin-top:0.5rem">Inference projected to dominate by 2026: <strong style="color:var(--accent)">~65%</strong> of total compute spend</div>';

  el.innerHTML = html;
}

initTrainingWaterfall();
initScalingCurve();
initCostCalc();
initSpendTimeline();

</script>


<script>
// ─── SEARCH ───
var CURRENT_PAGE = 'training-economics.html';
var SEARCH_INDEX = [
  {page:'index.html',pageLabel:'Inference',anchor:'step-routing',title:'Request Routing',desc:'Load balancing, KV cache-aware routing, geo-aware, gateway frameworks'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-preprocessing',title:'Preprocessing',desc:'Prompt templates, RAG retrieval, rate limiting, input validation'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-tokenization',title:'Tokenization',desc:'BPE, SentencePiece, vocabulary sizes, tiktoken'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-embedding',title:'Embedding & Position',desc:'Token embeddings, RoPE, ALiBi, positional encoding'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-scheduling',title:'Scheduling & Batching',desc:'Continuous batching, chunked prefill, thinking model scheduling'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-prefill',title:'Prefill Phase',desc:'Parallel forward pass, TTFT, prefix caching, KV-Runahead'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-kvcache',title:'KV Cache & Memory',desc:'PagedAttention, KV compression, MLA, memory management'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-attention',title:'Attention Mechanisms',desc:'MHA, GQA, MQA, FlashAttention, MLA'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-decode',title:'Decode Phase',desc:'Autoregressive loop, speculative decoding, thinking model decode'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-sampling',title:'Sampling & Selection',desc:'Temperature, top-k, top-p, min-p, repetition penalties'},
  {page:'index.html',pageLabel:'Inference',anchor:'step-streaming',title:'Detokenization & Streaming',desc:'UTF-8 buffering, SSE protocol, streaming pipeline'},
  {page:'index.html',pageLabel:'Inference',anchor:'inference-metrics',title:'Inference Metrics',desc:'TTFT, TPOT, throughput, GPU utilization, SLOs, cost per token'},
  {page:'index.html',pageLabel:'Inference',anchor:'cross-cutting',title:'Quantization & Parallelism',desc:'FP8, AWQ, GPTQ, tensor/pipeline/expert parallelism, LoRA serving'},
  {page:'index.html',pageLabel:'Inference',anchor:'frameworks',title:'Serving Frameworks',desc:'vLLM, SGLang, TensorRT-LLM, NVIDIA Dynamo'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'cost-stack',title:'The Cost Stack',desc:'GPU CapEx, power, data center, networking, operations'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'throughput',title:'Throughput as Margin',desc:'3-5x throughput variance; thinking model throughput impact'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'pricing',title:'Pricing Structures',desc:'Per-token, per-GPU-hour, reserved, batch, thinking token pricing'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'managed-vs-rental',title:'Managed vs GPU Rental',desc:'Statistical multiplexing, outcomes vs infrastructure'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'buy-vs-rent',title:'Buy vs Rent GPUs',desc:'Ownership cost model, breakeven calculator'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'data-centers',title:'Data Centers',desc:'Power costs, PUE, facility economics'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'equity-vs-debt',title:'Equity vs Debt',desc:'Risk, information asymmetry, tax shields'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'contracted-revenue',title:'Contracted Revenue',desc:'How pricing decisions unlock debt capacity'},
  {page:'economics.html',pageLabel:'Inference Economics',anchor:'stage-by-stage',title:'Stage-by-Stage Capital',desc:'Series A to public capital structure evolution'},
  {page:'training.html',pageLabel:'Training',anchor:'data-pipeline',title:'Data Pipeline',desc:'Collection, filtering, dedup, mixing; DCLM, FineWeb'},
  {page:'training.html',pageLabel:'Training',anchor:'tokenizer',title:'Tokenizer Training',desc:'BPE, SentencePiece, vocabulary sizes, 128K tokens'},
  {page:'training.html',pageLabel:'Training',anchor:'architecture',title:'Model Architecture',desc:'Attention variants, SwiGLU, MoE, RoPE, RMSNorm'},
  {page:'training.html',pageLabel:'Training',anchor:'optimization',title:'Optimization',desc:'AdamW, Muon, WSD schedule, mixed precision, FP8'},
  {page:'training.html',pageLabel:'Training',anchor:'distributed',title:'Distributed Training',desc:'ZeRO, tensor/pipeline/4D parallelism, Megatron-LM'},
  {page:'training.html',pageLabel:'Training',anchor:'monitoring',title:'Monitoring & Recovery',desc:'MFU, loss spikes, checkpointing, failure recovery'},
  {page:'training.html',pageLabel:'Training',anchor:'sft',title:'Supervised Fine-Tuning',desc:'LoRA, supervised text/chat/vision, loss masking, instruction tuning'},
  {page:'training.html',pageLabel:'Training',anchor:'alignment',title:'Alignment',desc:'RLHF, DPO triplets, GRPO, Constitutional AI, KTO, thinking models'},
  {page:'training.html',pageLabel:'Training',anchor:'rft',title:'Reinforcement Fine-Tuning',desc:'Evaluator-driven RFT, environment hooks, parameter tuning, o1/o3/R1'},
  {page:'training.html',pageLabel:'Training',anchor:'evaluation',title:'Evaluation',desc:'MMLU, benchmarks, contamination detection, LiveBench'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'hardware-costs',title:'Hardware & Compute Costs',desc:'GPU pricing, cloud rental decline, cost benchmarks'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'scaling-laws',title:'Scaling Laws & Efficiency',desc:'Chinchilla, over-training, test-time compute scaling'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'failure-costs',title:'Failure & Wasted Compute',desc:'Training failures, wasted GPU-hours, checkpoint overhead'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'build-vs-buy',title:'Build vs Fine-Tune vs API',desc:'When to train, fine-tune, or use API — cost comparison'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'training-providers',title:'Training Providers',desc:'Foundation model companies, training-as-a-service'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'cloud-vs-onprem',title:'Cloud vs On-Premise',desc:'Cloud advantages, on-prem breakeven, hidden costs'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'gpu-financing',title:'GPU Financing',desc:'CoreWeave debt, sale-leaseback, GPU depreciation'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'model-funding',title:'Foundation Model Funding',desc:'Mega-rounds, Big Tech infrastructure spend'},
  {page:'training-economics.html',pageLabel:'Training Economics',anchor:'training-vs-inference',title:'Training vs Inference Spend',desc:'Spend ratio shift 2023–2026, revenue gap'},
];

var searchSelectedIdx = -1;
var searchSelectedEl = null;
var searchFlatResults = [];
var searchDebounceTimer = null;
var searchCrossPageRequested = false;
var SEARCH_PAGE_ORDER = ['Inference', 'Inference Economics', 'Training', 'Training Economics'];

function normalizeSearchText(text) {
  return (text || '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function escapeHtml(text) {
  return (text || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function tokenizeQuery(queryNorm) {
  if (!queryNorm) return [];
  return queryNorm.split(' ').filter(function(token) { return token.length > 1; });
}

function resolveAnchorTarget(root, anchor) {
  if (!root || !anchor) return null;
  var target = root.getElementById(anchor);
  if (target) return target;
  var stepKey = anchor.replace(/^step-/, '');
  target = root.querySelector('.pipeline-step[data-step="' + stepKey + '"]');
  if (target) return target;
  return root.querySelector('[data-step="' + stepKey + '"]');
}

function extractSectionText(root, anchor) {
  var target = resolveAnchorTarget(root, anchor);
  if (!target) return '';
  var text = (target.textContent || '').replace(/\s+/g, ' ').trim();
  if (text.length > 5000) text = text.slice(0, 5000);
  return text;
}

function rebuildSearchBlob(item) {
  var base = [item.title, item.desc, item.pageLabel, item.anchor.replace(/[-_]/g, ' ')].join(' ');
  item._titleNorm = normalizeSearchText(item.title);
  item._descNorm = normalizeSearchText(item.desc);
  item._contentNorm = normalizeSearchText(item._content || '');
  item._blobNorm = normalizeSearchText(base + ' ' + (item._content || ''));
}

function prepareSearchIndex() {
  SEARCH_INDEX.forEach(function(item) {
    if (item.page === CURRENT_PAGE) {
      item._content = extractSectionText(document, item.anchor);
    } else {
      item._content = item._content || '';
    }
    rebuildSearchBlob(item);
  });
}

function fuzzySubsequenceScore(query, text) {
  if (!query || !text) return 0;
  var qi = 0;
  var ti = 0;
  var start = -1;
  var last = -1;
  var gapPenalty = 0;

  while (qi < query.length && ti < text.length) {
    if (query.charAt(qi) === text.charAt(ti)) {
      if (start === -1) start = ti;
      if (last !== -1 && ti > last + 1) gapPenalty += (ti - last - 1);
      last = ti;
      qi++;
    }
    ti++;
  }

  if (qi !== query.length || start === -1 || last === -1) return 0;

  var span = last - start + 1;
  var compactness = query.length / Math.max(span, 1);
  var startBonus = start === 0 ? 0.2 : Math.max(0, 0.12 - start * 0.003);
  var penalty = Math.min(0.45, gapPenalty * 0.01);
  var score = compactness + startBonus - penalty;
  return Math.max(0, Math.min(1, score));
}

function scoreSearchItem(item, queryNorm, tokens) {
  if (!queryNorm) return 1;

  var titleNorm = item._titleNorm || '';
  var descNorm = item._descNorm || '';
  var blobNorm = item._blobNorm || '';

  var score = 0;
  var matched = false;

  if (titleNorm.indexOf(queryNorm) === 0) {
    score += 140;
    matched = true;
  } else if (titleNorm.indexOf(queryNorm) !== -1) {
    score += 110;
    matched = true;
  }

  if (descNorm.indexOf(queryNorm) !== -1) {
    score += 48;
    matched = true;
  }

  if (blobNorm.indexOf(queryNorm) !== -1) {
    score += 78;
    matched = true;
  }

  var tokenHits = 0;
  tokens.forEach(function(token) {
    if (titleNorm.indexOf(token) !== -1) {
      score += 34;
      tokenHits += 1;
      matched = true;
      return;
    }
    if (blobNorm.indexOf(token) !== -1) {
      score += 18;
      tokenHits += 1;
      matched = true;
      return;
    }

    var fuzzyTitle = fuzzySubsequenceScore(token, titleNorm);
    var fuzzyBlob = fuzzySubsequenceScore(token, blobNorm);
    var fuzzyToken = Math.max(fuzzyTitle, fuzzyBlob * 0.9);
    if (fuzzyToken >= 0.74) {
      score += fuzzyToken * 16;
      tokenHits += 0.6;
      matched = true;
    }
  });

  if (tokens.length) score += (tokenHits / tokens.length) * 20;

  var fuzzyWhole = Math.max(
    fuzzySubsequenceScore(queryNorm, titleNorm),
    fuzzySubsequenceScore(queryNorm, blobNorm) * 0.88
  );
  if (fuzzyWhole >= 0.76) {
    score += fuzzyWhole * 34;
    matched = true;
  }

  if (!matched || score < 22) return 0;
  if (item.page === CURRENT_PAGE) score += 6;
  return score;
}

function buildSearchSnippet(item, queryNorm, tokens) {
  var fallback = item.desc || '';
  var content = (item._content || '').replace(/\s+/g, ' ').trim();
  if (!content) return fallback;

  var lower = content.toLowerCase();
  var hit = -1;

  for (var i = 0; i < tokens.length; i++) {
    if (tokens[i].length < 3) continue;
    hit = lower.indexOf(tokens[i]);
    if (hit !== -1) break;
  }

  if (hit === -1 && queryNorm.length >= 3) {
    hit = lower.indexOf(queryNorm);
  }

  if (hit === -1) {
    return content.length > 160 ? content.slice(0, 160).trim() + '…' : content;
  }

  var start = Math.max(0, hit - 64);
  var end = Math.min(content.length, hit + 120);
  var prefix = start > 0 ? '…' : '';
  var suffix = end < content.length ? '…' : '';
  return prefix + content.slice(start, end).trim() + suffix;
}

function getSearchResults(query) {
  var queryNorm = normalizeSearchText(query);
  var tokens = tokenizeQuery(queryNorm);

  if (!queryNorm) {
    return SEARCH_INDEX.map(function(item) {
      return {
        item: item,
        score: item.page === CURRENT_PAGE ? 1 : 0,
        snippet: item.desc
      };
    }).sort(function(a, b) {
      if (b.score !== a.score) return b.score - a.score;
      var pageDelta = SEARCH_PAGE_ORDER.indexOf(a.item.pageLabel) - SEARCH_PAGE_ORDER.indexOf(b.item.pageLabel);
      if (pageDelta !== 0) return pageDelta;
      return a.item.title.localeCompare(b.item.title);
    });
  }

  var matches = [];
  SEARCH_INDEX.forEach(function(item) {
    var score = scoreSearchItem(item, queryNorm, tokens);
    if (score <= 0) return;
    matches.push({
      item: item,
      score: score,
      snippet: buildSearchSnippet(item, queryNorm, tokens)
    });
  });

  matches.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    var pageDelta = SEARCH_PAGE_ORDER.indexOf(a.item.pageLabel) - SEARCH_PAGE_ORDER.indexOf(b.item.pageLabel);
    if (pageDelta !== 0) return pageDelta;
    return a.item.title.localeCompare(b.item.title);
  });

  return matches.slice(0, 120);
}

function openSearch() {
  var overlay = document.getElementById('search-overlay');
  var input = document.getElementById('search-input');
  if (!overlay || !input) return;
  overlay.classList.add('open');
  input.value = '';
  input.focus();
  searchSelectedIdx = -1;
  searchSelectedEl = null;
  renderSearchResults('');
  warmCrossPageContent();
}

function closeSearch() {
  var overlay = document.getElementById('search-overlay');
  if (overlay) overlay.classList.remove('open');
}

function setSearchSelected(idx) {
  if (idx < 0 || idx >= searchFlatResults.length) return;
  if (searchSelectedIdx === idx) return;

  if (searchSelectedEl) searchSelectedEl.classList.remove('selected');

  searchSelectedIdx = idx;
  var container = document.getElementById('search-results');
  searchSelectedEl = container ? container.querySelector('.search-result[data-idx="' + idx + '"]') : null;
  if (searchSelectedEl) searchSelectedEl.classList.add('selected');
}

function renderSearchResults(query) {
  var container = document.getElementById('search-results');
  if (!container) return;

  var results = getSearchResults(query || '');
  searchFlatResults = results;
  searchSelectedIdx = -1;
  searchSelectedEl = null;

  if (!results.length) {
    container.innerHTML = '<div class="search-no-results">No results for &ldquo;' + escapeHtml(query || '') + '&rdquo;</div>';
    return;
  }

  var grouped = {};
  results.forEach(function(entry, idx) {
    var label = entry.item.pageLabel;
    if (!grouped[label]) grouped[label] = [];
    grouped[label].push({ entry: entry, idx: idx });
  });

  var labels = SEARCH_PAGE_ORDER.slice();
  Object.keys(grouped).forEach(function(label) {
    if (labels.indexOf(label) === -1) labels.push(label);
  });

  var html = '';
  labels.forEach(function(label) {
    if (!grouped[label] || !grouped[label].length) return;
    html += '<div class="search-group-header">' + escapeHtml(label) + '</div>';

    grouped[label].forEach(function(row) {
      var item = row.entry.item;
      var snippet = row.entry.snippet || item.desc || '';
      html += '<div class="search-result" data-idx="' + row.idx + '" data-page="' + item.page + '" data-anchor="' + item.anchor + '">' +
        '<div class="search-result-dot"></div>' +
        '<div class="search-result-body"><div class="search-result-title">' + escapeHtml(item.title) + '</div>' +
        '<div class="search-result-desc">' + escapeHtml(snippet) + '</div></div>' +
        '<span class="search-result-badge">' + (item.page === CURRENT_PAGE ? 'this page' : item.pageLabel.toLowerCase()) + '</span>' +
      '</div>';
    });
  });

  container.innerHTML = html;
}

function scheduleSearchRender(query) {
  if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
  searchDebounceTimer = setTimeout(function() {
    renderSearchResults(query);
  }, 70);
}

function navigateToResult(el) {
  var page = el.getAttribute('data-page');
  var anchor = el.getAttribute('data-anchor');
  if (!page || !anchor) return;

  closeSearch();

  if (page === CURRENT_PAGE) {
    var target = resolveAnchorTarget(document, anchor);
    if (target) {
      if (target.classList.contains('pipeline-step') && !target.classList.contains('active')) {
        target.classList.add('active');
      }
      window.scrollTo({ top: target.getBoundingClientRect().top + window.scrollY - 64, behavior: 'smooth' });
    }
  } else {
    window.location.href = page + '#' + anchor;
  }
}

function warmCrossPageContent() {
  if (searchCrossPageRequested || typeof fetch !== 'function' || typeof DOMParser === 'undefined') return;
  searchCrossPageRequested = true;

  var pages = [];
  var seen = {};
  SEARCH_INDEX.forEach(function(item) {
    if (item.page === CURRENT_PAGE || seen[item.page]) return;
    seen[item.page] = true;
    pages.push(item.page);
  });

  if (!pages.length) {
    return;
  }

  Promise.allSettled(pages.map(function(page) {
    return fetch(page, { cache: 'force-cache', credentials: 'same-origin' })
      .then(function(response) {
        if (!response.ok) return '';
        return response.text();
      })
      .then(function(html) {
        if (!html) return;
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        SEARCH_INDEX.forEach(function(item) {
          if (item.page !== page) return;
          var extracted = extractSectionText(doc, item.anchor);
          if (extracted) {
            item._content = extracted;
            rebuildSearchBlob(item);
          }
        });
      })
      .catch(function() {});
  })).then(function() {
    var overlay = document.getElementById('search-overlay');
    var input = document.getElementById('search-input');
    if (overlay && overlay.classList.contains('open') && input && input.value.trim()) {
      renderSearchResults(input.value);
    }
  });
}

prepareSearchIndex();

document.addEventListener('keydown', function(e) {
  if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
    e.preventDefault();
    var overlay = document.getElementById('search-overlay');
    if (!overlay) return;
    if (overlay.classList.contains('open')) { closeSearch(); } else { openSearch(); }
    return;
  }

  var overlay = document.getElementById('search-overlay');
  if (!overlay || !overlay.classList.contains('open')) return;

  if (e.key === 'Escape') {
    closeSearch();
    return;
  }

  if (!searchFlatResults.length) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    var next = searchSelectedIdx < 0 ? 0 : Math.min(searchSelectedIdx + 1, searchFlatResults.length - 1);
    setSearchSelected(next);
    if (searchSelectedEl) searchSelectedEl.scrollIntoView({ block: 'nearest' });
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    var prev = searchSelectedIdx <= 0 ? 0 : searchSelectedIdx - 1;
    setSearchSelected(prev);
    if (searchSelectedEl) searchSelectedEl.scrollIntoView({ block: 'nearest' });
  } else if (e.key === 'Enter') {
    e.preventDefault();
    var idx = searchSelectedIdx >= 0 ? searchSelectedIdx : 0;
    var container = document.getElementById('search-results');
    var target = container ? container.querySelector('.search-result[data-idx="' + idx + '"]') : null;
    if (target) navigateToResult(target);
  }
});

var searchInputEl = document.getElementById('search-input');
if (searchInputEl) {
  searchInputEl.addEventListener('input', function(e) {
    scheduleSearchRender(e.target.value);
  });
}

var searchResultsEl = document.getElementById('search-results');
if (searchResultsEl) {
  searchResultsEl.addEventListener('click', function(e) {
    var resultEl = e.target.closest('.search-result');
    if (!resultEl || !searchResultsEl.contains(resultEl)) return;
    navigateToResult(resultEl);
  });

  searchResultsEl.addEventListener('mouseover', function(e) {
    var resultEl = e.target.closest('.search-result');
    if (!resultEl || !searchResultsEl.contains(resultEl)) return;
    var idx = parseInt(resultEl.getAttribute('data-idx'), 10);
    if (isNaN(idx)) return;
    setSearchSelected(idx);
  });
}

var searchOverlayEl = document.getElementById('search-overlay');
if (searchOverlayEl) {
  searchOverlayEl.addEventListener('click', function(e) {
    if (e.target === searchOverlayEl) closeSearch();
  });
}

var searchTriggerEl = document.getElementById('search-trigger');
if (searchTriggerEl) {
  searchTriggerEl.addEventListener('click', function() { openSearch(); });
}

// Update shortcut label for non-Mac
(function() {
  var isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform || navigator.userAgent);
  if (!isMac) {
    var hint = document.getElementById('search-key-hint');
    if (hint) hint.textContent = 'Ctrl+K';
  }
})();

// Handle hash anchor from cross-page search navigation
(function() {
  if (!window.location.hash) return;
  var anchor = window.location.hash.slice(1);
  setTimeout(function() {
    var target = resolveAnchorTarget(document, anchor);
    if (!target) return;
    if (target.classList.contains('pipeline-step') && !target.classList.contains('active')) target.classList.add('active');
    window.scrollTo({ top: target.getBoundingClientRect().top + window.scrollY - 64, behavior: 'smooth' });
  }, 180);
})();

</script>

<script>
// ─── KNOWLEDGE MARKDOWN DOWNLOAD ───
(function() {
  var downloadBtn = document.getElementById('download-knowledge');
  if (!downloadBtn) return;

  var KNOWLEDGE_PAGES = [
    { path: 'index.html', label: 'Inference Technical Pipeline' },
    { path: 'economics.html', label: 'Inference Economics' },
    { path: 'training.html', label: 'Training Technical Pipeline' },
    { path: 'training-economics.html', label: 'Training Economics' }
  ];

  function normalizeWhitespace(text) {
    return (text || '').replace(/\s+/g, ' ').trim();
  }

  function resolveHref(href, baseUrl) {
    if (!href) return '';
    if (href.charAt(0) === '#') return baseUrl + href;
    try {
      return new URL(href, baseUrl).href;
    } catch (err) {
      return href;
    }
  }

  function inlineFromNode(node, baseUrl) {
    if (!node) return '';
    if (node.nodeType === Node.TEXT_NODE) return node.nodeValue || '';
    if (node.nodeType !== Node.ELEMENT_NODE) return '';

    var tag = node.tagName.toLowerCase();
    if (tag === 'br') return '  \n';

    var childText = '';
    node.childNodes.forEach(function(child) {
      childText += inlineFromNode(child, baseUrl);
    });

    childText = normalizeWhitespace(childText);

    if (!childText && tag !== 'a') return '';
    if (tag === 'strong' || tag === 'b') return '**' + childText + '**';
    if (tag === 'em' || tag === 'i') return '*' + childText + '*';
    if (tag === 'code') return '`' + childText.replace(/`/g, '\\`') + '`';
    if (tag === 'a') {
      var href = resolveHref(node.getAttribute('href') || '', baseUrl);
      var label = childText || href;
      return href ? '[' + label + '](' + href + ')' : label;
    }

    return childText;
  }

  function inlineText(element, baseUrl) {
    if (!element) return '';
    var text = '';
    element.childNodes.forEach(function(child) {
      text += inlineFromNode(child, baseUrl) + ' ';
    });
    return normalizeWhitespace(text);
  }

  function markdownFromList(listEl, baseUrl, depth) {
    var level = depth || 0;
    var isOrdered = listEl.tagName.toLowerCase() === 'ol';
    var lines = [];

    Array.from(listEl.children).forEach(function(li, idx) {
      if (!li || li.tagName.toLowerCase() !== 'li') return;

      var itemTextParts = [];
      li.childNodes.forEach(function(node) {
        if (node.nodeType === Node.ELEMENT_NODE) {
          var tag = node.tagName.toLowerCase();
          if (tag === 'ul' || tag === 'ol') return;
        }
        itemTextParts.push(inlineFromNode(node, baseUrl));
      });

      var itemText = normalizeWhitespace(itemTextParts.join(' '));
      if (!itemText) itemText = '(item)';
      var prefix = isOrdered ? ((idx + 1) + '.') : '-';
      lines.push(Array(level + 1).join('  ') + prefix + ' ' + itemText);

      Array.from(li.children).forEach(function(child) {
        var childTag = child.tagName.toLowerCase();
        if (childTag === 'ul' || childTag === 'ol') {
          var nested = markdownFromList(child, baseUrl, level + 1);
          if (nested) lines.push(nested);
        }
      });
    });

    return lines.join('\n');
  }

  function escapeTableCell(text) {
    return (text || '').replace(/\|/g, '\\|');
  }

  function markdownFromTable(tableEl, baseUrl) {
    var rows = Array.from(tableEl.querySelectorAll('tr')).map(function(tr) {
      return Array.from(tr.children)
        .filter(function(cell) {
          var tag = cell.tagName.toLowerCase();
          return tag === 'th' || tag === 'td';
        })
        .map(function(cell) {
          return escapeTableCell(inlineText(cell, baseUrl));
        });
    }).filter(function(row) {
      return row.length > 0;
    });

    if (!rows.length) return '';

    var colCount = rows.reduce(function(max, row) {
      return Math.max(max, row.length);
    }, 0);

    rows = rows.map(function(row) {
      var copy = row.slice(0);
      while (copy.length < colCount) copy.push('');
      return copy;
    });

    var header = rows[0];
    var body = rows.slice(1);
    var sep = [];
    for (var i = 0; i < colCount; i++) sep.push('---');

    var md = [];
    md.push('| ' + header.join(' | ') + ' |');
    md.push('| ' + sep.join(' | ') + ' |');
    body.forEach(function(row) {
      md.push('| ' + row.join(' | ') + ' |');
    });

    return md.join('\n');
  }

  function shouldSkipBlock(el) {
    if (!el) return true;
    if (el.closest('nav, .minimap, .search-overlay, .footer, .journey-detail-panel, .term-tooltip')) return true;
    return false;
  }

  function sectionToMarkdown(section, baseUrl, headingToSkip) {
    var blocks = section.querySelectorAll('h1,h2,h3,h4,h5,p,ul,ol,pre,table');
    var out = [];
    var previous = '';

    blocks.forEach(function(el) {
      if (el === headingToSkip) return;
      if (shouldSkipBlock(el)) return;

      var tag = el.tagName.toLowerCase();
      var chunk = '';

      if ((tag === 'p' && el.closest('li')) || (tag === 'p' && el.closest('table'))) return;
      if ((tag === 'ul' || tag === 'ol') && el.closest('li')) return;
      if ((tag === 'pre' || tag === 'code') && el.closest('table')) return;

      if (tag === 'h1' || tag === 'h2' || tag === 'h3' || tag === 'h4' || tag === 'h5') {
        var headingText = inlineText(el, baseUrl);
        if (!headingText) return;
        var level = parseInt(tag.charAt(1), 10) + 2;
        if (level > 6) level = 6;
        chunk = Array(level + 1).join('#') + ' ' + headingText;
      } else if (tag === 'p') {
        chunk = inlineText(el, baseUrl);
      } else if (tag === 'ul' || tag === 'ol') {
        chunk = markdownFromList(el, baseUrl, 0);
      } else if (tag === 'pre') {
        var codeText = (el.textContent || '').trim();
        if (codeText) chunk = '```\n' + codeText + '\n```';
      } else if (tag === 'table') {
        chunk = markdownFromTable(el, baseUrl);
      }

      chunk = (chunk || '').replace(/\n\s+\n/g, '\n\n').replace(/\n{3,}/g, '\n\n').trim();
      if (!chunk || chunk === previous) return;
      out.push(chunk);
      previous = chunk;
    });

    return out.join('\n\n').trim();
  }

  function parsePageToMarkdown(html, pageMeta, pageUrl) {
    var parser = new DOMParser();
    var doc = parser.parseFromString(html, 'text/html');
    var lines = [];

    lines.push('## ' + pageMeta.label);
    lines.push('Source: [' + pageMeta.path + '](' + pageUrl + ')');

    var heroTitleEl = doc.querySelector('.hero h1');
    var heroTitle = heroTitleEl ? inlineText(heroTitleEl, pageUrl) : normalizeWhitespace(doc.title || pageMeta.label);
    if (heroTitle) lines.push('### ' + heroTitle);

    var heroSubEl = doc.querySelector('.hero-sub') || doc.querySelector('.hero p');
    var heroSub = heroSubEl ? inlineText(heroSubEl, pageUrl) : '';
    if (heroSub) lines.push(heroSub);

    var sections = Array.from(doc.querySelectorAll('section'));
    sections.forEach(function(section) {
      if (section.classList.contains('hero')) return;
      if (shouldSkipBlock(section)) return;

      var sectionHeadingEl = section.querySelector('h2,h3');
      var sectionHeading = sectionHeadingEl ? inlineText(sectionHeadingEl, pageUrl) : '';
      if (!sectionHeading && section.id) sectionHeading = section.id.replace(/[-_]/g, ' ');
      if (sectionHeading) lines.push('### ' + sectionHeading);

      var sectionBody = sectionToMarkdown(section, pageUrl, sectionHeadingEl);
      if (sectionBody) lines.push(sectionBody);
    });

    return lines.join('\n\n').replace(/\n{3,}/g, '\n\n').trim();
  }

  async function buildKnowledgeMarkdown() {
    var generatedAt = new Date();
    var parts = [];

    parts.push('# LLM Anatomy Knowledge Base');
    parts.push('');
    parts.push('Generated: ' + generatedAt.toISOString());
    parts.push('Origin: ' + window.location.origin);
    parts.push('');
    parts.push('This markdown file is generated from the live website at download time.');
    parts.push('');

    for (var i = 0; i < KNOWLEDGE_PAGES.length; i++) {
      var page = KNOWLEDGE_PAGES[i];
      var pageUrl = new URL(page.path, window.location.href).href;

      try {
        var response = await fetch(pageUrl, { cache: 'no-store', credentials: 'same-origin' });
        if (!response.ok) throw new Error('HTTP ' + response.status);

        var html = await response.text();
        var pageMd = parsePageToMarkdown(html, page, pageUrl);
        parts.push(pageMd || ('## ' + page.label + '\n\nSource: [' + page.path + '](' + pageUrl + ')\n\n_No extractable content found._'));
      } catch (err) {
        parts.push('## ' + page.label);
        parts.push('Source: [' + page.path + '](' + pageUrl + ')');
        parts.push('');
        parts.push('_Failed to fetch this page while generating knowledge markdown: ' + (err && err.message ? err.message : 'Unknown error') + '._');
      }

      if (i < KNOWLEDGE_PAGES.length - 1) {
        parts.push('');
        parts.push('---');
        parts.push('');
      }
    }

    return parts.join('\n').replace(/\n{3,}/g, '\n\n').trim() + '\n';
  }

  function downloadMarkdown(content) {
    var stamp = new Date().toISOString().replace(/:/g, '-').replace(/\.\d+Z$/, 'Z');
    var fileName = 'llm-anatomy-knowledge-' + stamp + '.md';

    var blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  downloadBtn.addEventListener('click', async function() {
    if (downloadBtn.disabled) return;

    var labelEl = downloadBtn.querySelector('.search-trigger-label');
    var originalLabel = labelEl ? labelEl.textContent : '';

    downloadBtn.disabled = true;
    if (labelEl) labelEl.textContent = 'Preparing...';

    try {
      var markdown = await buildKnowledgeMarkdown();
      downloadMarkdown(markdown);
    } catch (err) {
      console.error('Knowledge markdown generation failed:', err);
      window.alert('Failed to generate knowledge markdown. Please try again.');
    } finally {
      downloadBtn.disabled = false;
      if (labelEl) labelEl.textContent = originalLabel;
    }
  });
})();
</script>

<!-- ─── SEARCH MODAL ─── -->
<div class="search-overlay" id="search-overlay" role="dialog" aria-modal="true" aria-label="Site search">
  <div class="search-modal">
    <div class="search-input-wrap">
      <svg class="search-icon-svg" viewBox="0 0 16 16" stroke="currentColor" stroke-width="1.5"><circle cx="6.5" cy="6.5" r="4.5"/><path stroke-linecap="round" d="m10 10 3.5 3.5"/></svg>
      <input type="text" class="search-input" id="search-input" placeholder="Search sections, topics, terms..." autocomplete="off" spellcheck="false">
      <kbd class="search-esc-hint">ESC</kbd>
    </div>
    <div class="search-results" id="search-results"></div>
    <div class="search-footer">
      <span class="search-footer-hint"><span class="search-footer-key">&#x2191;&#x2193;</span>&nbsp;navigate</span>
      <span class="search-footer-hint"><span class="search-footer-key">&#x23CE;</span>&nbsp;select</span>
      <span class="search-footer-hint"><span class="search-footer-key">ESC</span>&nbsp;close</span>
    </div>
  </div>
</div>

</body>
</html>
